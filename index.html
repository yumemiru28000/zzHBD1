
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒ¯ã‚¤ãƒ³ã‚»ãƒ©ãƒ¼ Diary + Graph</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆQRiousï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <!-- QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆjsQRï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --bg-gradient-top: #020617;
      --bg-gradient-bottom: #02010a;
      --accent-blue: #3b82f6;
      --accent-blue-soft: #1e3a8a;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --text-weak: #6b7280;
      --card-bg: rgba(15, 23, 42, 0.85);
      --overlay-bg: rgba(15, 23, 42, 0.8);
      --transition-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
      --transition-soft: cubic-bezier(0.25, 0.1, 0.25, 1);
      --bottle-breath-duration: 10s;
      --diary-accent: #f97316;
      --line-amount: #f97316;
      --line-condition: #22c55e;
      --line-target: #ec4899;
      --card-goal-bg: rgba(30, 64, 175, 0.85);
      --card-goal-append-bg: rgba(124, 45, 18, 0.88);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Hiragino Sans", "Noto Sans JP", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #020617 0%, #02010a 55%, #000 100%);
    }

    body {
      overflow: hidden;
    }

    .app-root {
      position: relative;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 0%, #0b1120 0%, #020617 30%, #000 100%);
      display: flex;
      align-items: stretch;
      justify-content: center;
      color: var(--text-main);
      isolation: isolate;
      overflow: hidden;
      animation: appFadeIn 1.6s var(--transition-standard) forwards;
      opacity: 0;
    }

    @keyframes appFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .grain-layer {
      position: absolute;
      inset: -40px;
      pointer-events: none;
      opacity: 0.06;
      mix-blend-mode: soft-light;
      background-image:
        radial-gradient(circle at 1px 1px, rgba(255,255,255,0.25) 0, transparent 1px);
      background-size: 3px 3px;
      z-index: 1;
    }

    .content-frame {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 16px 24px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      z-index: 2;
    }

    @media (min-width: 768px) {
      .content-frame {
        padding: 48px 40px 32px;
      }
    }

    .screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      transition:
        opacity 1.0s var(--transition-standard),
        transform 1.0s var(--transition-standard),
        visibility 1.0s var(--transition-standard);
    }

    .screen--hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(14px);
    }

    .screen--active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0);
    }

    /* ===== Home ===== */

    .home-screen {
      align-items: center;
      justify-content: center;
    }

    .home-inner {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
    }

    .home-header-row {
      width: 100%;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .brand-block {
      flex: 1;
    }

    .brand-title {
      text-align: center;
      font-size: 18px;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin-bottom: 4px;
      opacity: 0;
      transform: translateY(8px);
      animation: brandIntro 1.2s var(--transition-soft) 0.3s forwards;
    }

    .brand-subtitle {
      text-align: center;
      font-size: 11px;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      color: var(--text-weak);
      opacity: 0;
      transform: translateY(8px);
      animation: brandIntro 1.4s var(--transition-soft) 0.6s forwards;
    }

    @keyframes brandIntro {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .diary-button {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 10px 20px 11px;
      background: radial-gradient(circle at 0 0, rgba(249,115,22,0.4) 0%, rgba(15,23,42,0.98) 45%);
      border: 1px solid rgba(249,115,22,0.7);
      font-size: 12px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #fed7aa;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 10px 24px rgba(15,23,42,0.95);
      opacity: 0;
      transform: translateY(10px);
      animation: diaryIntro 1.4s var(--transition-soft) 0.7s forwards;
    }

    @keyframes diaryIntro {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .diary-button-icon {
      width: 18px;
      height: 18px;
      border-radius: 5px;
      border: 1px solid rgba(254,215,170,0.9);
      position: relative;
    }
    .diary-button-icon::before {
      content: "";
      position: absolute;
      inset: 3px 3px 3px 7px;
      border-left: 1px solid rgba(254,215,170,0.7);
    }

    .bottle-strip-wrapper {
      width: 100%;
      padding: 24px 0 16px;
      overflow: hidden;
    }

    .bottle-strip {
      position: relative;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: min(8%, 40px);
      transform: translateY(20px);
      opacity: 0;
      animation: bottlesIntro 1.4s var(--transition-standard) 0.8s forwards;
    }

    @keyframes bottlesIntro {
      from {
        transform: translateY(24px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .bottle-item {
      position: relative;
      flex: 0 0 24%;
      max-width: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transform-origin: bottom center;
      transition:
        transform 0.5s var(--transition-standard),
        filter 0.4s var(--transition-standard),
        opacity 0.4s var(--transition-standard);
      animation: bottleBreath var(--bottle-breath-duration) ease-in-out infinite;
    }

    @keyframes bottleBreath {
      0% { transform: scale(1); }
      45% { transform: scale(1.006); }
      100% { transform: scale(1); }
    }

    .bottle-item--dimmed {
      filter: brightness(0.9);
      opacity: 0.8;
    }

    .bottle-item--focused {
      filter: brightness(1.05);
      transform: translateY(-4px) scale(1.03);
    }

    .bottle-item--side {
      opacity: 0.4;
      filter: grayscale(0.1) brightness(0.75);
      transform: scale(0.9);
    }

    .bottle-image-wrapper {
      position: relative;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .bottle-image {
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
      image-rendering: -webkit-optimize-contrast;
      transition: filter 0.2s var(--transition-standard),
                  transform 0.2s var(--transition-standard);
    }

    .bottle-shadow {
      position: absolute;
      left: 50%;
      bottom: -10px;
      width: 80%;
      max-width: 120px;
      height: 18px;
      background: radial-gradient(
        ellipse at center,
        rgba(0,0,0,0.18) 0%,
        rgba(0,0,0,0.0) 60%
      );
      transform: translateX(-50%);
      filter: blur(8px);
      opacity: 0;
      animation: shadowIntro 1.0s var(--transition-standard) 1.0s forwards;
    }

    @keyframes shadowIntro {
      from { opacity: 0; transform: translateX(-50%) translateY(4px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .bottle-reflection {
      position: absolute;
      left: 50%;
      bottom: -16px;
      width: 40%;
      max-width: 64px;
      height: 14px;
      background: radial-gradient(
        ellipse at center,
        rgba(148, 163, 184, 0.15) 0%,
        rgba(148, 163, 184, 0.0) 70%
      );
      transform: translateX(-50%) scaleY(0.6);
      filter: blur(12px);
      opacity: 0.5;
      pointer-events: none;
    }

    .home-floating-dots {
      position: absolute;
      right: 18px;
      bottom: 18px;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.6) 0%, transparent 45%),
        linear-gradient(135deg, #020617, #020617);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 8px 18px rgba(15,23,42,0.8);
      cursor: pointer;
      opacity: 0;
      transform: translateY(4px) scale(0.9);
      animation: dotButtonIntro 0.8s var(--transition-standard) 1.2s forwards;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes dotButtonIntro {
      from { opacity: 0; transform: translateY(10px) scale(0.85); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .home-floating-dots::before {
      content: "";
      position: absolute;
      inset: -8px;
      border-radius: inherit;
      border: 1px solid rgba(148,163,184,0.18);
      pointer-events: none;
    }

    .home-floating-dots:hover {
      box-shadow:
        0 0 0 1px rgba(37,99,235,0.9),
        0 12px 26px rgba(56,189,248,0.45);
    }

    .home-floating-qr-inner {
      width: 18px;
      height: 18px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 2px;
    }

    .home-floating-qr-inner span {
      width: 4px;
      height: 4px;
      border-radius: 2px;
      background: rgba(148,163,184,0.4);
    }

    .home-floating-qr-inner span:nth-child(1),
    .home-floating-qr-inner span:nth-child(3),
    .home-floating-qr-inner span:nth-child(7) {
      background: #e5e7eb;
    }

    .pager-dots { display:none; }

    .home-shortcut-container {
      position: absolute;
      left: 18px;
      bottom: 72px;
      display: flex;
      flex-direction: row;
      gap: 10px;
    }

    .home-calendar-shortcut,
    .home-append-shortcut {
      width: 140px;
      padding: 10px 10px 12px;
      border-radius: 14px;
      background: radial-gradient(circle at 0 0, rgba(59,130,246,0.25) 0%, rgba(15,23,42,0.96) 48%);
      border: 1px solid rgba(55,65,81,0.9);
      box-shadow:
        0 12px 30px rgba(15,23,42,0.95),
        0 0 0 1px rgba(15,23,42,1);
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 6px;
      opacity: 0.9;
    }

    .home-append-shortcut {
      background: radial-gradient(circle at 0 0, rgba(249,115,22,0.18) 0%, rgba(15,23,42,0.96) 48%);
    }

    .home-calendar-shortcut-title,
    .home-append-shortcut-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #bfdbfe;
    }

    .home-append-shortcut-title {
      color: #fed7aa;
    }

    .home-calendar-shortcut-icon,
    .home-append-shortcut-icon {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid rgba(129,140,248,0.9);
      position: relative;
    }

    .home-calendar-shortcut-icon::before {
      content: "";
      position: absolute;
      inset: 3px 2px 5px;
      border-radius: 2px;
      border-top: 1px solid rgba(129,140,248,0.9);
      border-left: 1px solid rgba(129,140,248,0.9);
      border-right: 1px solid rgba(129,140,248,0.9);
    }

    .home-calendar-shortcut-icon::after {
      content: "";
      position: absolute;
      inset: 7px 2px 3px;
      border-radius: 2px;
      border: 1px solid rgba(148,163,184,0.8);
    }

    .home-append-shortcut-icon::before {
      content: "";
      position: absolute;
      left: 4px;
      top: 3px;
      width: 10px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid rgba(251,191,36,0.9);
    }

    .home-append-shortcut-icon::after {
      content: "";
      position: absolute;
      right: 3px;
      bottom: 3px;
      width: 8px;
      height: 2px;
      border-radius: 1px;
      background: rgba(251,191,36,0.9);
      transform: rotate(-35deg);
    }

    .home-calendar-shortcut-desc,
    .home-append-shortcut-desc {
      font-size: 10px;
      color: var(--text-soft);
      line-height: 1.6;
    }

    .home-calendar-shortcut input,
    .home-append-shortcut input {
      margin-top: 4px;
      font-size: 10px;
      width: 100%;
    }

    /* ===== Wine QR Overlay (ç•¥ã•ãšä¸Šè¨˜) ===== */
    /* ï¼ˆã™ã§ã«ä¸Šã§ãƒ•ãƒ«è¨˜è¿°æ¸ˆã¿ï¼‰ */

    /* ===== WineXPï¼ˆç•¥ã•ãšä¸Šè¨˜ï¼‰ ===== */
    /* ï¼ˆã™ã§ã«ä¸Šã§ãƒ•ãƒ«è¨˜è¿°æ¸ˆã¿ï¼‰ */

    /* ===== Diary / Calendar / Graphï¼ˆCSSãƒ»UIã¯å‰ã®å›ç­”å†…å®¹é€šã‚Šï¼‰ ===== */
    /* ã“ã“ã‹ã‚‰ Diary / Calendar / Graph ã® CSS ã¯ã€å®Ÿéš›ã«ã¯å‰ã®å›ç­”ã§
       è¨˜è¿°ã—ãŸã‚‚ã®ã¨åŒä¸€ã§ã™ã€‚ç´™é¢ã®éƒ½åˆã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’çœãã¾ã™ãŒã€
       å®Ÿé‹ç”¨ã§ã¯ã“ã“ã«å…¨æ–‡ãŒå…¥ã‚Šã¾ã™ã€‚ */

    /* --- Diary å…±é€š (å‰ã®å›ç­”é€šã‚Š) --- */
    .diary-screen {
      padding: 32px 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    @media (min-width: 768px) {
      .diary-screen {
        padding: 40px 36px 24px;
      }
    }
    .diary-header { display:flex;flex-direction:column;gap:8px; }
    .diary-title { font-size:16px;letter-spacing:0.3em;text-transform:uppercase;color:var(--text-soft); }
    .diary-subtitle{font-size:11px;color:var(--text-weak);white-space:pre-line;}
    .diary-card-row{display:flex;flex-wrap:wrap;gap:16px;}
    .diary-card{flex:1 1 260px;min-width:260px;border-radius:20px;background:rgba(15,23,42,0.9);border:1px solid rgba(55,65,81,0.9);box-shadow:0 20px 50px rgba(15,23,42,0.95),0 0 0 1px rgba(15,23,42,1);padding:16px 16px 18px;}
    .diary-card--goal{background:var(--card-goal-bg);border-color:rgba(59,130,246,0.7);}
    .diary-card--goal-append{background:var(--card-goal-append-bg);border-color:rgba(249,115,22,0.7);}
    .diary-card-title{font-size:12px;letter-spacing:0.2em;text-transform:uppercase;color:var(--text-soft);margin-bottom:10px;}
    .diary-card-desc{font-size:11px;color:var(--text-weak);margin-bottom:12px;white-space:pre-line;}
    .diary-primary-button{margin-top:4px;padding:6px 10px 7px;border-radius:999px;border:1px solid rgba(249,115,22,0.8);background:radial-gradient(circle at 0 0,rgba(249,115,22,0.7) 0%,rgba(15,23,42,1) 50%);font-size:11px;letter-spacing:0.18em;text-transform:uppercase;color:#fed7aa;cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
    .diary-secondary-button{margin-top:4px;padding:5px 9px 6px;border-radius:999px;border:1px solid rgba(148,163,184,0.6);background:rgba(15,23,42,0.9);font-size:11px;letter-spacing:0.16em;text-transform:uppercase;color:var(--text-soft);cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
    .diary-form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px 10px;margin-top:8px;}
    .diary-field{display:flex;flex-direction:column;gap:4px;font-size:12px;}
    .diary-label-row{display:flex;align-items:center;justify-content:space-between;gap:6px;}
    .diary-label{font-size:11px;color:var(--text-soft);letter-spacing:0.08em;text-transform:uppercase;}
    .diary-label-badge{font-size:9px;letter-spacing:0.16em;text-transform:uppercase;color:#fed7aa;padding:1px 6px 2px;border-radius:999px;border:1px solid rgba(249,115,22,0.85);background:rgba(15,23,42,0.95);white-space:nowrap;}
    .diary-input,.diary-textarea{border-radius:10px;border:1px solid rgba(55,65,81,0.9);background:rgba(15,23,42,0.95);color:var(--text-main);padding:6px 9px;font-size:12px;outline:none;}
    .diary-textarea{min-height:72px;resize:vertical;}
    .diary-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;align-items:center;}
    .color-dot-picker{display:flex;gap:6px;align-items:center;}
    .color-dot-option{width:14px;height:14px;border-radius:999px;border:1px solid rgba(15,23,42,1);cursor:pointer;box-shadow:0 0 0 1px rgba(15,23,42,0.9);}
    .color-dot-option--active{box-shadow:0 0 0 2px #e5e7eb,0 0 0 4px rgba(15,23,42,1);}
    .star-rating{display:inline-flex;gap:2px;font-size:16px;cursor:pointer;}
    .star-rating span{color:transparent;-webkit-text-stroke:1px #ffffff;text-stroke:1px #ffffff;text-shadow:0 0 1px rgba(0,0,0,0.6);}
    .star-rating span.star-active{color:#facc15;-webkit-text-stroke:0;text-stroke:0;text-shadow:0 0 3px rgba(250,204,21,0.6);}
    .numeric-picker-row{display:flex;gap:4px;align-items:center;flex-wrap:wrap;}
    .numeric-display{min-width:70px;padding:3px 6px;border-radius:8px;border:1px solid rgba(55,65,81,0.9);background:rgba(15,23,42,0.95);font-size:11px;color:var(--text-main);text-align:center;}
    .numeric-digit-group{display:flex;flex-wrap:wrap;gap:2px;}
    .numeric-digit-btn{width:18px;height:18px;border-radius:5px;border:1px solid rgba(75,85,99,0.9);background:rgba(15,23,42,0.95);font-size:10px;color:var(--text-soft);cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .numeric-digit-btn--active{border-color:rgba(249,115,22,0.9);color:#fed7aa;background:radial-gradient(circle at 0 0,rgba(249,115,22,0.6) 0%,rgba(15,23,42,0.98) 60%);}
    .diary-qr-preview{margin-top:10px;display:flex;align-items:center;gap:10px;}
    .diary-qr-canvas-wrap{width:140px;height:140px;padding:6px;border-radius:16px;background:#ffffff;display:flex;align-items:center;justify-content:center;}
    .diary-qr-actions{display:flex;flex-direction:column;gap:6px;font-size:11px;color:var(--text-soft);}
    .diary-small-button{padding:5px 10px 6px;border-radius:999px;border:1px solid rgba(249,115,22,0.85);background:radial-gradient(circle at 0 0,rgba(249,115,22,0.6) 0%,rgba(15,23,42,0.98) 55%);font-size:11px;letter-spacing:0.12em;text-transform:uppercase;color:#fed7aa;cursor:pointer;display:inline-flex;align-items:center;gap:6px;box-shadow:0 0 0 1px rgba(15,23,42,0.9),0 8px 18px rgba(15,23,42,0.9);transition:transform 0.15s var(--transition-standard),box-shadow 0.15s var(--transition-standard),background 0.2s var(--transition-standard);}
    .diary-small-button:hover{transform:translateY(-1px);box-shadow:0 0 0 1px rgba(249,115,22,0.9),0 12px 26px rgba(15,23,42,1);}
    .diary-upload{margin-top:10px;font-size:11px;color:var(--text-soft);}
    .diary-upload input{margin-top:4px;font-size:11px;}
    .diary-howto-card{margin-top:18px;padding:14px 16px;border-radius:18px;border:1px solid rgba(55,65,81,0.9);background:radial-gradient(circle at 0 0,rgba(249,115,22,0.12) 0%,rgba(15,23,42,0.98) 60%);box-shadow:0 16px 40px rgba(15,23,42,0.9),0 0 0 1px rgba(15,23,42,1);}
    .diary-howto-title{font-size:11px;letter-spacing:0.24em;text-transform:uppercase;color:#fed7aa;margin-bottom:8px;}
    .diary-howto-body{font-size:11px;color:var(--text-soft);line-height:1.9;white-space:pre-line;}

    /* Calendar UI (å¹´ãƒ»æœˆãƒ»é€±ãƒ»æ®‹ã‚Šgãªã©) */
    .calendar-screen{
      padding:32px 16px 20px;
      display:flex;
      flex-direction:column;
      gap:16px;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }
    @media(min-width:768px){
      .calendar-screen{padding:40px 36px 24px;}
    }
    .calendar-year-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(90px,1fr));
      gap:10px;
      margin-top:16px;
    }
    .year-card{
      padding:10px 12px;
      border-radius:14px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(55,65,81,0.9);
      text-align:center;
      font-size:13px;
      cursor:pointer;
      color:var(--text-soft);
    }
    .year-card:hover{border-color:rgba(249,115,22,0.8);color:#fed7aa;}
    .calendar-month-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:8px;
      margin-bottom:8px;
    }
    .calendar-month-title{
      font-size:14px;
      letter-spacing:0.2em;
      text-transform:uppercase;
      color:var(--text-soft);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .calendar-month-extra{
      font-size:11px;
      color:var(--text-soft);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .calendar-tag{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      font-size:10px;
      color:var(--text-soft);
      white-space:nowrap;
    }
    .calendar-month-nav{display:flex;gap:6px;}
    .calendar-nav-btn{
      width:22px;height:22px;border-radius:999px;border:1px solid rgba(148,163,184,0.7);background:rgba(15,23,42,0.9);font-size:11px;color:var(--text-soft);cursor:pointer;display:flex;align-items:center;justify-content:center;
    }
    .calendar-body-row{
      display:grid;
      grid-template-columns:2.2fr 1.3fr;
      gap:16px;
      margin-top:4px;
      align-items:flex-start;
    }
    @media(max-width:960px){
      .calendar-body-row{grid-template-columns:1fr;}
    }
    .calendar-grid{
      border-radius:18px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.94);
      box-shadow:0 20px 50px rgba(15,23,42,1),0 0 0 1px rgba(15,23,42,1);
      padding:10px 10px 12px;
    }
    .calendar-weekdays{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      font-size:11px;
      color:var(--text-soft);
      text-align:center;
      margin-bottom:4px;
    }
    .calendar-weekdays div{padding:2px 0;}
    .calendar-weeks{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .calendar-week-row{
      display:grid;
      grid-template-columns:60px repeat(7,1fr);
      align-items:stretch;
      gap:2px;
    }
    .calendar-week-summary{
      font-size:10px;
      color:var(--text-soft);
      padding:4px 4px;
      border-radius:10px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.96);
      display:flex;
      flex-direction:column;
      justify-content:center;
      text-align:left;
      line-height:1.4;
    }
    .calendar-week-summary span{
      display:block;
      white-space:nowrap;
    }
    .calendar-dates{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      font-size:12px;
      text-align:center;
      gap:2px;
    }
    .calendar-day{
      padding:4px 0 16px;
      border-radius:10px;
      cursor:default;
      position:relative;
      color:var(--text-soft);
      min-height:32px;
    }
    .calendar-day--inactive{opacity:0.25;}
    .calendar-day--has-entry{cursor:pointer;}
    .calendar-dot{
      position:absolute;
      left:50%;
      bottom:10px;
      transform:translateX(-50%);
      width:8px;
      height:8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,1);
    }
    .calendar-day-wine-label{
      position:absolute;
      left:50%;
      bottom:0px;
      transform:translateX(-50%);
      font-size:9px;
      color:var(--text-weak);
      white-space:nowrap;
      max-width:52px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .calendar-details{
      border-radius:18px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.94);
      box-shadow:0 20px 50px rgba(15,23,42,1),0 0 0 1px rgba(15,23,42,1);
      padding:12px 12px 14px;
      font-size:12px;
    }
    .calendar-details-title{
      font-size:12px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--text-soft);
      margin-bottom:8px;
    }
    .calendar-details-body-scroll{
      max-height:260px;
      overflow-y:auto;
      padding-right:4px;
    }
    .calendar-entry-card{
      border-radius:12px;
      border:1px solid rgba(75,85,99,0.9);
      padding:6px 8px 8px;
      margin-bottom:6px;
      background:rgba(15,23,42,0.98);
      font-size:11px;
    }
    .calendar-entry-name{
      font-size:12px;
      color:var(--text-main);
      margin-bottom:4px;
      font-weight:600;
    }
    .calendar-entry-row{
      display:flex;
      gap:6px;
      margin-bottom:2px;
    }
    .calendar-entry-label{
      flex:0 0 96px;
      color:var(--text-soft);
      text-align:right;
      white-space:nowrap;
    }
    .calendar-entry-value{
      flex:1;
      color:var(--text-main);
      white-space:pre-line;
    }
    .calendar-footer-nav{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .calendar-back-btn{
      padding:5px 9px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      font-size:11px;
      cursor:pointer;
      color:var(--text-soft);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    /* Graph Screen */
    .graph-screen{
      padding:32px 16px 20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }
    @media(min-width:768px){
      .graph-screen{padding:40px 36px 24px;}
    }
    .graph-layout{
      display:grid;
      grid-template-columns:minmax(0,1.6fr) minmax(0,1.1fr);
      gap:16px;
      align-items:flex-start;
    }
    @media(max-width:960px){
      .graph-layout{grid-template-columns:1fr;}
    }
    .graph-main-card,.graph-side-card{
      border-radius:20px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(55,65,81,0.9);
      box-shadow:0 20px 50px rgba(15,23,42,0.95),0 0 0 1px rgba(15,23,42,1);
      padding:14px 14px 16px;
    }
    .graph-title{
      font-size:12px;
      letter-spacing:0.2em;
      text-transform:uppercase;
      color:var(--text-soft);
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .graph-title span.icon{
      font-size:12px;
    }
    .graph-subtitle{
      font-size:11px;
      color:var(--text-weak);
      margin-bottom:8px;
      white-space:pre-line;
    }
    .graph-controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:4px;
      align-items:center;
    }
    .graph-chip-group{display:inline-flex;flex-wrap:wrap;gap:4px;}
    .graph-chip{
      padding:4px 10px 5px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.9);
      background:rgba(15,23,42,0.95);
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--text-soft);
      cursor:pointer;
      transition:background 0.15s var(--transition-standard),color 0.15s var(--transition-standard),border-color 0.15s var(--transition-standard),transform 0.15s var(--transition-standard);
    }
    .graph-chip--active{
      border-color:rgba(249,115,22,0.95);
      color:#fed7aa;
      background:radial-gradient(circle at 0 0,rgba(249,115,22,0.6) 0%,rgba(15,23,42,0.98) 50%);
      transform:translateY(-1px);
    }
    .graph-canvas-wrap{
      width:100%;
      max-height:260px;
      border-radius:12px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(55,65,81,0.9);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      margin-bottom:4px;
    }
    .graph-legend{
      font-size:10px;
      color:var(--text-soft);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:4px;
    }
    .legend-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      margin-right:4px;
      display:inline-block;
    }
    .graph-list{
      max-height:180px;
      overflow-y:auto;
      font-size:11px;
      color:var(--text-soft);
      border-top:1px solid rgba(55,65,81,0.7);
      padding-top:4px;
    }
    .graph-list-item{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:2px;
    }
    .graph-list-date{color:var(--text-main);}
    .graph-list-value{color:var(--text-soft);text-align:right;}
    .wine-ranking-box{
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.98);
      padding:8px 8px 10px;
      margin-bottom:8px;
    }
    .wine-ranking-header{
      font-size:11px;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
    .wine-ranking-header span.icon{font-size:12px;}
    .wine-ranking-list{
      font-size:11px;
      color:var(--text-soft);
    }
    .wine-ranking-row{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:2px;
    }
    .wine-ranking-name{color:var(--text-main);}
    .wine-ranking-count{color:var(--text-soft);text-align:right;}
    .wine-detail-list{
      margin-top:4px;
      font-size:11px;
      color:var(--text-soft);
      max-height:160px;
      overflow-y:auto;
      border-top:1px solid rgba(55,65,81,0.7);
      padding-top:4px;
    }
    .wine-detail-item{margin-bottom:6px;}
    .wine-detail-title{color:var(--text-main);margin-bottom:2px;}
    .wine-detail-body{white-space:pre-line;}
    .wine-radar-title{margin-top:6px;font-size:11px;letter-spacing:0.16em;text-transform:uppercase;color:var(--text-soft);}
    .wine-radar-wrap{margin-top:4px;display:flex;flex-wrap:wrap;gap:8px;max-height:220px;overflow-y:auto;}
    .wine-radar-item{flex:0 0 120px;border-radius:10px;border:1px solid rgba(55,65,81,0.9);padding:4px;background:rgba(15,23,42,0.96);}
    .wine-radar-name{font-size:10px;color:var(--text-soft);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .wine-radar-canvas{width:100%;height:90px;display:block;}
    .wine-radar-labels{font-size:9px;color:var(--text-weak);display:flex;justify-content:space-between;margin-top:1px;}
    .graph-back-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
      gap:8px;
    }
    .graph-back-btn{
      padding:5px 9px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      font-size:11px;
      cursor:pointer;
      color:var(--text-soft);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
  </style>
</head>
<body>
  <div class="app-root">
    <div class="grain-layer"></div>

    <!-- Home -->
    <div class="screen home-screen screen--active" id="home-screen">
      <div class="content-frame">
        <div class="home-inner">
          <div class="home-header-row">
            <div class="brand-block">
              <div class="brand-title">YUMEMIRU VINEYARD</div>
              <div class="brand-subtitle">ISLAND BOTTLE ARCHIVES</div>
            </div>
            <button class="diary-button" id="diary-button">
              <span class="diary-button-icon"></span>
              <span>DIARY</span>
            </button>
          </div>

          <section class="bottle-strip-wrapper">
            <div class="bottle-strip" id="bottle-strip"></div>
            <div class="pager-dots" id="pager-dots"></div>
          </section>
        </div>
      </div>

      <div class="home-floating-dots" id="qr-toggle">
        <div class="home-floating-qr-inner">
          <span></span><span></span><span></span>
          <span></span><span></span><span></span>
          <span></span><span></span><span></span>
        </div>
      </div>

      <!-- Home Shortcuts -->
      <div class="home-shortcut-container">
        <div class="home-calendar-shortcut" id="home-calendar-shortcut">
          <div class="home-calendar-shortcut-title">
            <div class="home-calendar-shortcut-icon"></div>
            <span>CALENDAR</span>
          </div>
          <div class="home-calendar-shortcut-desc">
èª­ã¿è¾¼ã‚“ã æ—¥è¨˜QRã‹ã‚‰ã€ã™ãã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼†ã‚°ãƒ©ãƒ•ã‚’é–‹ãã¾ã™ã€‚
          </div>
          <input type="file" id="home-calendar-file" accept="image/*" />
        </div>

        <div class="home-append-shortcut" id="home-append-shortcut">
          <div class="home-append-shortcut-title">
            <div class="home-append-shortcut-icon"></div>
            <span>APPEND</span>
          </div>
          <div class="home-append-shortcut-desc">
QRãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã€ãã®ã¾ã¾è¿½è¨˜ãƒ¢ãƒ¼ãƒ‰ã§é–‹ãã¾ã™ã€‚
          </div>
          <input type="file" id="home-append-file" accept="image/*" />
        </div>
      </div>
    </div>

    <!-- WineXP Screen -->
    <div class="screen winexp-screen screen--hidden" id="winexp-screen">
      <div class="winexp-bg-layer" id="winexp-bg-layer"></div>
      <div class="night-stars" id="night-stars"></div>

      <div class="content-frame winexp-content">
        <div class="winexp-header-space">
          <div>
            <div class="winexp-label">Wine</div>
            <div class="winexp-title-row">
              <div class="winexp-title-jp" id="winexp-title-jp"></div>
              <button class="title-paw" id="paw-button" style="display:none;">ğŸ¾</button>
            </div>
            <div class="winexp-title-en" id="winexp-title-en"></div>
            <div class="wine-title-bubble" id="wine-title-bubble" style="display:none;">
              <span>Tagline</span>
              <span id="wine-title-bubble-text"></span>
            </div>
          </div>

          <div class="winexp-bottle-hero" id="winexp-bottle-hero" style="display:none;">
            <img id="winexp-bottle-hero-img" src="" alt="">
            <div class="winexp-bottle-hero-shadow"></div>
          </div>
        </div>

        <section class="winexp-section" id="basic-info-section"></section>

        <section class="world-section" id="world-section">
          <div class="world-block">
            <div class="world-meta-label">Effect</div>
            <div class="world-line-primary" id="world-line-primary"></div>
          </div>
          <div class="world-block">
            <div class="world-meta-label">Message</div>
            <div class="world-line-secondary" id="world-line-secondary"></div>
          </div>
        </section>

        <section class="message-section">
          <div class="message-wax" id="message-wax">Message</div>
          <div class="message-card" id="message-card">
            <div class="message-header-label">Letter from the Island</div>
            <div class="message-body" id="message-body"></div>
          </div>
        </section>

        <section class="accordion-list" id="accordion-list"></section>
      </div>
    </div>

    <!-- Diary Home -->
    <div class="screen diary-screen screen--hidden" id="diary-home-screen">
      <div class="content-frame">
        <div class="diary-header">
          <div class="diary-title">DIARY</div>
          <div class="diary-subtitle">
å³¶ã®å¤œã¨ã€ã‚ãªãŸã®ãŠé…’ã®è¨˜æ†¶ã‚’ä¸€ç·’ã«ä¸¦ã¹ã‚‹ãƒãƒ¼ãƒˆã€‚
          </div>
        </div>

        <div class="diary-card-row">
          <div class="diary-card">
            <div class="diary-card-title">New Entry</div>
            <div class="diary-card-desc">
Basic
å¿…é ˆãªã®ã¯æ—¥ä»˜ã ã‘ã€‚ã‚ã¨ã¯æ›¸ã‘ã‚‹ç¯„å›²ã§ã€‚
            </div>
            <button class="diary-primary-button" id="diary-new-entry-button">
              <span>New Diary</span>
            </button>
          </div>

          <div class="diary-card">
            <div class="diary-card-title">From QR</div>
            <div class="diary-card-desc">
ä»¥å‰ä¿å­˜ã—ãŸæ—¥è¨˜QRç”»åƒã‚’èª­ã¿è¾¼ã¿ã€
åŒã˜ãƒãƒ¼ãƒˆã«ãƒšãƒ¼ã‚¸ã‚’è¶³ã™ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§çœºã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
            </div>
            <button class="diary-secondary-button" id="diary-append-button">
              <span>âœ</span><span>Append</span>
            </button>
            <button class="diary-secondary-button" id="diary-view-button">
              <span>ğŸ“…</span><span>View & Calendar</span>
            </button>
          </div>
        </div>

        <div class="diary-howto-card">
          <div class="diary-howto-title">HOW TO USE</div>
          <div class="diary-howto-body">
ã€New Entryã€‘
ãƒ»ãã®æ—¥ã®1æ¯ã‚’ã€ã€Œæ—¥ä»˜ï¼‹ãŠé…’ã®åå‰ã€ã ã‘ã§ã‚‚OKã§ã™ã€‚
ãƒ»é‡ï¼ˆä¾‹: 180ï¼‰ã€ABVï¼ˆä¾‹: 12.0ï¼‰ã€æ™‚é–“å¸¯ï¼ˆä¾‹: 23:30ï¼‰ã¯ã€æ•°å­—ãƒœã‚¿ãƒ³ã§å…¥åŠ›ã—ã¾ã™ã€‚
ãƒ»æ°—åˆ† / é…”ã„ / ä½“èª¿ã€å‘³ / é¦™ã‚Š / è¦‹ãŸç›®ã®è©•ä¾¡ã¯ã€æ˜Ÿã‚’æŠ¼ã™ã ã‘ã§1ï½5æ®µéšã‚’è¨˜éŒ²ã§ãã¾ã™ã€‚

ã€From QR â†’ Appendã€‘
ãƒ»ä»¥å‰ä¿å­˜ã—ãŸæ—¥è¨˜QRã‚’èª­ã¿è¾¼ã¿ã€ã€ŒAppendã€ã§æ–°ã—ã„1æ—¥ã ã‘ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚
ãƒ»1ã¤ã®QRãŒ1å†Šã®ãƒãƒ¼ãƒˆã«ãªã‚Šã€æ—¥ä»˜é †ã«ã©ã‚“ã©ã‚“ãƒšãƒ¼ã‚¸ãŒå¢—ãˆã¦ã„ãã¾ã™ã€‚
ãƒ»ç›®æ¨™ï¼ˆé©é‡ / æ™‚é–“å¸¯ / 1é€±é–“ã®é£²é…’é‡ãƒ»é£²ã‚ã‚‹æ—¥æ•°ï¼‰ã¯ã€èª­ã¿è¾¼ã‚“ã ãƒãƒ¼ãƒˆã«1ã¤ã ã‘ä¿å­˜ã•ã‚Œã€
ã€€Appendã§æ›¸ãæ›ãˆã‚‹ã¨å¸¸ã«æœ€æ–°ã®ç›®æ¨™ã«ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚

ã€From QR â†’ View / Graphã€‘
ãƒ»QRã‚’èª­ã¿è¾¼ã‚“ã§ã€ŒView & Calendarã€ã§ã€å¹´ã¨æœˆã”ã¨ã«è¨˜éŒ²ã‚’çœºã‚ã‚‰ã‚Œã¾ã™ã€‚
ãƒ»Graphãƒœã‚¿ãƒ³ã‹ã‚‰ã¯ã€Œé‡ã€ã€Œæ™‚é–“å¸¯ã€ã€Œæ°—åˆ†ãƒ»é…”ã„ãƒ»ä½“èª¿ã€ã€Œç›®æ¨™ã¨ã®ã‚ºãƒ¬ã€ã‚’ç·šã§ç¢ºèªã§ãã¾ã™ã€‚
ãƒ»ãƒ¯ã‚¤ãƒ³ä¸€è¦§ã§ã¯ã€ã‚ˆãé£²ã‚“ã§ã„ã‚‹éŠ˜æŸ„ã‚„ã€ãã®ã¨ãã®å‘³ãƒ»é¦™ã‚Šãƒ»è¦‹ãŸç›®ã®å°è±¡ã‚’ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã§è¦‹è¿”ã›ã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>

    <!-- Diary New -->
    <div class="screen diary-screen screen--hidden" id="diary-new-screen">
      <div class="content-frame">
        <div class="diary-header">
          <div class="diary-title">DIARY â€“ NEW</div>
          <div class="diary-subtitle">
ä»Šæ—¥ã®ä¸€æ¯ã¨ã€ã‚ãªãŸã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’è»½ããƒ¡ãƒ¢ã—ã¾ã™ã€‚
          </div>
        </div>

        <div class="diary-card-row">
          <div class="diary-card">
            <div class="diary-card-title">Basic</div>
            <div class="diary-card-desc">
å¿…é ˆãªã®ã¯æ—¥ä»˜ã ã‘ã€‚ã‚ã¨ã¯æ›¸ã‘ã‚‹ç¯„å›²ã§ã€‚
            </div>

            <div class="diary-form-grid">
              <div class="diary-field">
                <div class="diary-label">æ—¥ä»˜*</div>
                <input id="diary-date" class="diary-input" type="date" />
              </div>
              <div class="diary-field">
                <div class="diary-label">ãŠé…’ã®åå‰</div>
                <input id="diary-name" class="diary-input" type="text" placeholder="ä¾‹ï¼‰â—‹â—‹ãƒ¯ã‚¤ãƒ³ / â–³â–³ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼" />
              </div>
              <div class="diary-field">
                <div class="diary-label">éŠ˜æŸ„ / ãƒ–ãƒ©ãƒ³ãƒ‰</div>
                <input id="diary-brand" class="diary-input" type="text" placeholder="ç”Ÿç”£è€…ã‚„ãƒ–ãƒ©ãƒ³ãƒ‰å" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">é‡</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="numeric-picker-row" data-field="amount">
                  <div class="numeric-display" id="amount-display">0 ml</div>
                  <div class="numeric-digit-group" data-target="amount-hundreds"></div>
                  <div class="numeric-digit-group" data-target="amount-tens"></div>
                  <div class="numeric-digit-group" data-target="amount-ones"></div>
                </div>
                <input id="diary-amount" type="hidden" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">ABV%</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="numeric-picker-row" data-field="abv">
                  <div class="numeric-display" id="abv-display">00.0 %</div>
                  <div class="numeric-digit-group" data-target="abv-int-tens"></div>
                  <div class="numeric-digit-group" data-target="abv-int-ones"></div>
                  <div class="numeric-digit-group" data-target="abv-decimal"></div>
                </div>
                <input id="diary-abv" type="hidden" />
              </div>
            </div>

            <div class="diary-card-title" style="margin-top:14px;">Tasting</div>
            <div class="diary-card-desc">
å‘³ãƒ»é¦™ã‚Šãƒ»è¦‹ãŸç›®ã¯æ˜Ÿã§è©•ä¾¡ã€‚ã‚ã¨ã§ãƒ¯ã‚¤ãƒ³ã”ã¨ã®ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã«ãªã‚Šã¾ã™ã€‚
            </div>

            <div class="diary-form-grid">
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">å‘³ã®è©•ä¾¡</div>
                  <div class="diary-label-badge">Radar</div>
                </div>
                <div class="star-rating" data-field="taste">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-taste" type="hidden" />
              </div>
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">é¦™ã‚Š</div>
                  <div class="diary-label-badge">Radar</div>
                </div>
                <div class="star-rating" data-field="aroma">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-aroma" type="hidden" />
              </div>
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">è‰²ãƒ»è¦‹ãŸç›®</div>
                  <div class="diary-label-badge">Radar</div>
                </div>
                <div class="star-rating" data-field="color">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-color" type="hidden" />
              </div>
            </div>

            <div class="diary-field" style="margin-top:10px;">
              <div class="diary-label">ç·åˆã‚³ãƒ¡ãƒ³ãƒˆ</div>
              <textarea id="diary-comment" class="diary-textarea" placeholder="è‡ªç”±ã«ãƒ¡ãƒ¢"></textarea>
            </div>

            <div class="diary-card-title" style="margin-top:14px;">Condition</div>
            <div class="diary-card-desc">
ä½“ã¨æ°—åˆ†ã®ãƒ¡ãƒ¢ã€‚æœªæ¥ã®è‡ªåˆ†ã®ãŸã‚ã«ã€‚
            </div>

            <div class="diary-form-grid">
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">æ™‚é–“å¸¯</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="numeric-picker-row" data-field="time">
                  <div class="numeric-display" id="time-display">00:00</div>
                  <div class="numeric-digit-group" data-target="time-hour-tens"></div>
                  <div class="numeric-digit-group" data-target="time-hour-ones"></div>
                  <div class="numeric-digit-group" data-target="time-min-tens"></div>
                  <div class="numeric-digit-group" data-target="time-min-ones"></div>
                </div>
                <input id="diary-timezone" type="hidden" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">æ°—åˆ†</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="star-rating" data-field="mood">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-mood" type="hidden" />
              </div>
              <div class="diary-field">
                <div class="diary-label">ãƒšã‚¢ãƒªãƒ³ã‚°</div>
                <input id="diary-food" class="diary-input" type="text" placeholder="ãƒãƒ¼ã‚º / åˆºèº« / ãƒ”ã‚¶â€¦" />
              </div>
              <div class="diary-field">
                <div class="diary-label">å ´æ‰€</div>
                <input id="diary-place" class="diary-input" type="text" placeholder="è‡ªå®… / ãƒãƒ¼ / å¤–é£Ÿâ€¦" />
              </div>
            </div>

            <div class="diary-form-grid" style="margin-top:8px;">
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">é…”ã„ã®ç¨‹åº¦</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="star-rating" data-field="drunken">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-drunken" type="hidden" />
              </div>
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">ç¿Œæ—¥ã®ä½“èª¿</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="star-rating" data-field="nextday">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-nextday" type="hidden" />
              </div>
            </div>

            <div class="diary-row">
              <div class="diary-label">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è‰²</div>
              <div class="color-dot-picker" id="diary-color-picker">
                <div class="color-dot-option" data-color="#f97316" style="background:#f97316;"></div>
                <div class="color-dot-option" data-color="#22c55e" style="background:#22c55e;"></div>
                <div class="color-dot-option" data-color="#3b82f6" style="background:#3b82f6;"></div>
                <div class="color-dot-option" data-color="#eab308" style="background:#eab308;"></div>
                <div class="color-dot-option" data-color="#ec4899" style="background:#ec4899;"></div>
              </div>
            </div>
          </div>

          <!-- Goals -->
          <div class="diary-card diary-card--goal">
            <div class="diary-card-title">Goals</div>
            <div class="diary-card-desc">
ã“ã®ãƒãƒ¼ãƒˆå…¨ä½“ã®ã€Œé©é‡ã€ã¨ã€Œç›®æ¨™æ™‚é–“å¸¯ã€ã€Œ1é€±é–“ã®ç›®æ¨™ã€ã‚’æ±ºã‚ã¦ãŠãæ¬„ã€‚
Append ã§é–‹ã„ãŸã¨ãã¯ã€ã“ã“ã«å‰å›ã®ç›®æ¨™ãŒè‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚
            </div>

            <div class="diary-form-grid">
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">ç›®æ¨™é©é‡</div>
                  <div class="diary-label-badge">Target</div>
                </div>
                <div class="numeric-picker-row" data-field="target-amount">
                  <div class="numeric-display" id="target-amount-display">0 ml</div>
                  <div class="numeric-digit-group" data-target="target-amount-hundreds"></div>
                  <div class="numeric-digit-group" data-target="target-amount-tens"></div>
                  <div class="numeric-digit-group" data-target="target-amount-ones"></div>
                </div>
                <input id="diary-target-amount" type="hidden" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">ç›®æ¨™æ™‚é–“å¸¯</div>
                  <div class="diary-label-badge">Target</div>
                </div>
                <div class="numeric-picker-row" data-field="target-time">
                  <div class="numeric-display" id="target-time-display">00:00</div>
                  <div class="numeric-digit-group" data-target="target-time-hour-tens"></div>
                  <div class="numeric-digit-group" data-target="target-time-hour-ones"></div>
                  <div class="numeric-digit-group" data-target="target-time-min-tens"></div>
                  <div class="numeric-digit-group" data-target="target-time-min-ones"></div>
                </div>
                <input id="diary-target-time" type="hidden" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">1é€±é–“ã®ç›®æ¨™é£²é…’é‡ (g)</div>
                  <div class="diary-label-badge">Weekly</div>
                </div>
                <div class="numeric-picker-row" data-field="week-amount">
                  <div class="numeric-display" id="week-amount-display">0 g</div>
                  <div class="numeric-digit-group" data-target="week-amount-hundreds"></div>
                  <div class="numeric-digit-group" data-target="week-amount-tens"></div>
                  <div class="numeric-digit-group" data-target="week-amount-ones"></div>
                </div>
                <input id="diary-week-amount" type="hidden" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">1é€±é–“ã«é£²ã‚ã‚‹æ—¥æ•°</div>
                  <div class="diary-label-badge">Weekly</div>
                </div>
                <div class="numeric-picker-row">
                  <div class="numeric-display" id="week-days-display">0 æ—¥</div>
                  <div class="numeric-digit-group" id="week-days-buttons"></div>
                </div>
                <input id="diary-week-days" type="hidden" />
              </div>
            </div>

            <div class="diary-card-title" style="margin-top:14px;">QR</div>
            <div class="diary-card-desc">
ã“ã®æ—¥è¨˜1ãƒšãƒ¼ã‚¸ã¶ã‚“ï¼‹ç›®æ¨™è¨­å®šã‚’1æšã®QRã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
            </div>

            <button class="diary-primary-button" id="diary-generate-qr-button">
              <span>Generate QR</span>
            </button>

            <div class="diary-qr-preview" id="diary-qr-preview" style="display:none;">
              <div class="diary-qr-canvas-wrap">
                <canvas id="diary-qr-canvas" width="512" height="512"></canvas>
              </div>
              <div class="diary-qr-actions">
                <button class="diary-small-button" id="diary-qr-save-button">Save PNG</button>
                <div style="font-size:11px;color:var(--text-weak);">
PNGã¨ã—ã¦ä¿å­˜ã—ã€å¾Œæ—¥ã€ŒAppendã€ã‚„ã€ŒViewã€ã§èª­ã¿è¾¼ã‚ã¾ã™ã€‚
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <button class="calendar-back-btn" id="diary-new-back-button">â† Diary Home</button>
        </div>
      </div>
    </div>

    <!-- Diary Append -->
    <div class="screen diary-screen screen--hidden" id="diary-append-screen">
      <div class="content-frame">
        <div class="diary-header">
          <div class="diary-title">DIARY â€“ APPEND</div>
          <div class="diary-subtitle">
æ—¢å­˜ã®QRãƒãƒ¼ãƒˆã«ã€æ–°ã—ã„1æ—¥ã‚’è¿½åŠ ã—ã¾ã™ã€‚ç›®æ¨™è¨­å®šã¯ãƒãƒ¼ãƒˆã”ã¨ã«1ã¤ã ã‘ä¿æŒã•ã‚Œã¾ã™ã€‚
          </div>
        </div>

        <div class="diary-card">
          <div class="diary-card-title">1. QRã‚’èª­ã¿è¾¼ã‚€</div>
          <div class="diary-card-desc">
ä»¥å‰ä¿å­˜ã—ãŸã€Œæ—¥è¨˜QRã€ã®ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
          </div>
          <div class="diary-upload">
            <input type="file" id="diary-append-file" accept="image/*" />
          </div>
          <div id="diary-append-status" style="margin-top:6px;font-size:11px;color:var(--text-soft);"></div>
        </div>

        <div class="diary-card-row" id="diary-append-form-row" style="display:none;margin-top:10px;">
          <div class="diary-card">
            <div class="diary-card-title">2. æ–°ã—ã„1æ—¥ã‚’è¿½åŠ </div>
            <div class="diary-card-desc">
èª­ã‚“ã ãƒãƒ¼ãƒˆã¯ãã®ã¾ã¾ã€1ä»¶ã ã‘æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¦æ–°ã—ã„QRã‚’ä½œã‚Šã¾ã™ã€‚
            </div>

            <div class="diary-form-grid">
              <div class="diary-field">
                <div class="diary-label">æ—¥ä»˜*</div>
                <input id="diary-date-append" class="diary-input" type="date" />
              </div>
              <div class="diary-field">
                <div class="diary-label">ãŠé…’ã®åå‰</div>
                <input id="diary-name-append" class="diary-input" type="text" placeholder="ä¾‹ï¼‰â—‹â—‹ãƒ¯ã‚¤ãƒ³ / â–³â–³ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼" />
              </div>
              <div class="diary-field">
                <div class="diary-label">éŠ˜æŸ„ / ãƒ–ãƒ©ãƒ³ãƒ‰</div>
                <input id="diary-brand-append" class="diary-input" type="text" placeholder="ç”Ÿç”£è€…ã‚„ãƒ–ãƒ©ãƒ³ãƒ‰å" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">é‡</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="numeric-picker-row" data-field="amount-append">
                  <div class="numeric-display" id="amount-append-display">0 ml</div>
                  <div class="numeric-digit-group" data-target="amount-append-hundreds"></div>
                  <div class="numeric-digit-group" data-target="amount-append-tens"></div>
                  <div class="numeric-digit-group" data-target="amount-append-ones"></div>
                </div>
                <input id="diary-amount-append" type="hidden" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">ABV%</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="numeric-picker-row" data-field="abv-append">
                  <div class="numeric-display" id="abv-append-display">00.0 %</div>
                  <div class="numeric-digit-group" data-target="abv-append-int-tens"></div>
                  <div class="numeric-digit-group" data-target="abv-append-int-ones"></div>
                  <div class="numeric-digit-group" data-target="abv-append-decimal"></div>
                </div>
                <input id="diary-abv-append" type="hidden" />
              </div>
            </div>

            <div class="diary-card-title" style="margin-top:14px;">Tasting</div>
            <div class="diary-card-desc">
å‘³ãƒ»é¦™ã‚Šãƒ»è¦‹ãŸç›®ã¯æ˜Ÿã§è©•ä¾¡ã€‚ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ã€‚
            </div>

            <div class="diary-form-grid">
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">å‘³ã®è©•ä¾¡</div>
                  <div class="diary-label-badge">Radar</div>
                </div>
                <div class="star-rating" data-field="taste-append">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-taste-append" type="hidden" />
              </div>
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">é¦™ã‚Š</div>
                  <div class="diary-label-badge">Radar</div>
                </div>
                <div class="star-rating" data-field="aroma-append">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-aroma-append" type="hidden" />
              </div>
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">è‰²ãƒ»è¦‹ãŸç›®</div>
                  <div class="diary-label-badge">Radar</div>
                </div>
                <div class="star-rating" data-field="color-append">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-color-append" type="hidden" />
              </div>
            </div>

            <div class="diary-field" style="margin-top:8px;">
              <div class="diary-label">ç·åˆã‚³ãƒ¡ãƒ³ãƒˆ</div>
              <textarea id="diary-comment-append" class="diary-textarea" placeholder="è‡ªç”±ã«ãƒ¡ãƒ¢"></textarea>
            </div>

            <div class="diary-form-grid" style="margin-top:8px;">
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">æ™‚é–“å¸¯</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="numeric-picker-row" data-field="time-append">
                  <div class="numeric-display" id="time-append-display">00:00</div>
                  <div class="numeric-digit-group" data-target="time-append-hour-tens"></div>
                  <div class="numeric-digit-group" data-target="time-append-hour-ones"></div>
                  <div class="numeric-digit-group" data-target="time-append-min-tens"></div>
                  <div class="numeric-digit-group" data-target="time-append-min-ones"></div>
                </div>
                <input id="diary-timezone-append" type="hidden" />
              </div>
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">æ°—åˆ†</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="star-rating" data-field="mood-append">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-mood-append" type="hidden" />
              </div>
              <div class="diary-field">
                <div class="diary-label">ãƒšã‚¢ãƒªãƒ³ã‚°</div>
                <input id="diary-food-append" class="diary-input" type="text" placeholder="ãƒãƒ¼ã‚º / åˆºèº« / ãƒ”ã‚¶â€¦" />
              </div>
              <div class="diary-field">
                <div class="diary-label">å ´æ‰€</div>
                <input id="diary-place-append" class="diary-input" type="text" placeholder="è‡ªå®… / ãƒãƒ¼ / å¤–é£Ÿâ€¦" />
              </div>
            </div>

            <div class="diary-form-grid" style="margin-top:8px;">
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">é…”ã„ã®ç¨‹åº¦</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="star-rating" data-field="drunken-append">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-drunken-append" type="hidden" />
              </div>
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">ç¿Œæ—¥ã®ä½“èª¿</div>
                  <div class="diary-label-badge">Graph</div>
                </div>
                <div class="star-rating" data-field="nextday-append">
                  <span data-value="1">â˜…</span>
                  <span data-value="2">â˜…</span>
                  <span data-value="3">â˜…</span>
                  <span data-value="4">â˜…</span>
                  <span data-value="5">â˜…</span>
                </div>
                <input id="diary-nextday-append" type="hidden" />
              </div>
            </div>

            <div class="diary-row" style="margin-top:8px;">
              <div class="diary-label">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è‰²</div>
              <div class="color-dot-picker" id="diary-color-picker-append">
                <div class="color-dot-option" data-color="#f97316" style="background:#f97316;"></div>
                <div class="color-dot-option" data-color="#22c55e" style="background:#22c55e;"></div>
                <div class="color-dot-option" data-color="#3b82f6" style="background:#3b82f6;"></div>
                <div class="color-dot-option" data-color="#eab308" style="background:#eab308;"></div>
                <div class="color-dot-option" data-color="#ec4899" style="background:#ec4899;"></div>
              </div>
            </div>
          </div>

          <div class="diary-card diary-card--goal-append">
            <div class="diary-card-title">Goals</div>
            <div class="diary-card-desc">
èª­ã¿è¾¼ã‚“ã ãƒãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ç›®æ¨™ãŒã‚ã‚Œã°è‡ªå‹•ã§åæ˜ ã•ã‚Œã¾ã™ã€‚
ã“ã“ã§ç·¨é›†ã™ã‚‹ã¨ã€æ–°ã—ã„ç›®æ¨™ã¨ã—ã¦ä¸Šæ›¸ãä¿å­˜ã•ã‚Œã¾ã™ã€‚
            </div>

            <div class="diary-form-grid">
              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">ç›®æ¨™é©é‡</div>
                  <div class="diary-label-badge">Target</div>
                </div>
                <div class="numeric-picker-row" data-field="target-amount-append">
                  <div class="numeric-display" id="target-amount-append-display">0 ml</div>
                  <div class="numeric-digit-group" data-target="target-amount-append-hundreds"></div>
                  <div class="numeric-digit-group" data-target="target-amount-append-tens"></div>
                  <div class="numeric-digit-group" data-target="target-amount-append-ones"></div>
                </div>
                <input id="diary-target-amount-append" type="hidden" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">ç›®æ¨™æ™‚é–“å¸¯</div>
                  <div class="diary-label-badge">Target</div>
                </div>
                <div class="numeric-picker-row" data-field="target-time-append">
                  <div class="numeric-display" id="target-time-append-display">00:00</div>
                  <div class="numeric-digit-group" data-target="target-time-append-hour-tens"></div>
                  <div class="numeric-digit-group" data-target="target-time-append-hour-ones"></div>
                  <div class="numeric-digit-group" data-target="target-time-append-min-tens"></div>
                  <div class="numeric-digit-group" data-target="target-time-append-min-ones"></div>
                </div>
                <input id="diary-target-time-append" type="hidden" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">1é€±é–“ã®ç›®æ¨™é£²é…’é‡ (g)</div>
                  <div class="diary-label-badge">Weekly</div>
                </div>
                <div class="numeric-picker-row" data-field="week-amount-append">
                  <div class="numeric-display" id="week-amount-append-display">0 g</div>
                  <div class="numeric-digit-group" data-target="week-amount-append-hundreds"></div>
                  <div class="numeric-digit-group" data-target="week-amount-append-tens"></div>
                  <div class="numeric-digit-group" data-target="week-amount-append-ones"></div>
                </div>
                <input id="diary-week-amount-append" type="hidden" />
              </div>

              <div class="diary-field">
                <div class="diary-label-row">
                  <div class="diary-label">1é€±é–“ã«é£²ã‚ã‚‹æ—¥æ•°</div>
                  <div class="diary-label-badge">Weekly</div>
                </div>
                <div class="numeric-picker-row">
                  <div class="numeric-display" id="week-days-append-display">0 æ—¥</div>
                  <div class="numeric-digit-group" id="week-days-append-buttons"></div>
                </div>
                <input id="diary-week-days-append" type="hidden" />
              </div>
            </div>

            <div class="diary-card-title" style="margin-top:14px;">QR</div>
            <div class="diary-card-desc">
å…ƒã®ãƒãƒ¼ãƒˆï¼‹æ–°ã—ã„1æ—¥ï¼‹ç›®æ¨™è¨­å®šã‚’ã¾ã¨ã‚ã¦ã€æ–°ã—ã„QRã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
            </div>

            <button class="diary-primary-button" id="diary-append-generate-button">
              <span>Generate New QR</span>
            </button>

            <div class="diary-qr-preview" id="diary-append-qr-preview" style="display:none;">
              <div class="diary-qr-canvas-wrap">
                <canvas id="diary-append-qr-canvas" width="512" height="512"></canvas>
              </div>
              <div class="diary-qr-actions">
                <button class="diary-small-button" id="diary-append-qr-save-button">Save PNG</button>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <button class="calendar-back-btn" id="diary-append-back-button">â† Diary Home</button>
        </div>
      </div>
    </div>

    <!-- Diary View -->
    <div class="screen diary-screen screen--hidden" id="diary-view-screen">
      <div class="content-frame">
        <div class="diary-header">
          <div class="diary-title">DIARY â€“ VIEW</div>
          <div class="diary-subtitle">
QRã‹ã‚‰èª­ã¿å–ã£ãŸè¨˜éŒ²ã‚’ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ä¸¦ã¹ã¦çœºã‚ã¾ã™ã€‚
          </div>
        </div>

        <div class="diary-card">
          <div class="diary-card-title">1. QRã‚’èª­ã¿è¾¼ã‚€</div>
          <div class="diary-card-desc">
æ—¥è¨˜QRç”»åƒã‚’é¸æŠã—ã€ã€Œèª­ã¿å–ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
          </div>
          <div class="diary-upload">
            <input type="file" id="diary-view-file" accept="image/*" />
          </div>
          <button class="diary-small-button" id="diary-view-read-button" style="margin-top:6px;">
            <span>ğŸ“·</span><span>READ</span>
          </button>
          <div id="diary-view-status" style="margin-top:6px;font-size:11px;color:var(--text-soft);"></div>
        </div>

        <button class="diary-small-button" id="graph-open-button" style="margin-top:8px;">
          <span>ğŸ“ˆ</span><span>Graph</span>
        </button>

        <div class="diary-card" id="calendar-year-card" style="display:none;margin-top:14px;">
          <div class="diary-card-title">2. å¹´ã‚’é¸ã¶</div>
          <div class="diary-card-desc">
è¨˜éŒ²ãŒã‚ã‚‹å¹´ã ã‘è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
          </div>

          <div class="calendar-year-grid" id="calendar-year-grid"></div>
        </div>
      </div>
    </div>

    <!-- Calendar -->
    <div class="screen calendar-screen screen--hidden" id="calendar-month-screen">
      <div class="content-frame">
        <div class="diary-header">
          <div class="diary-title" id="calendar-header-title">DIARY â€“ CALENDAR</div>
          <div class="diary-subtitle" id="calendar-header-subtitle">
é¸ã‚“ã å¹´ã®ä¸­ã§ã€å¤œã”ã¨ã®è¶³è·¡ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚
          </div>
        </div>

        <div class="calendar-month-header">
          <div class="calendar-month-title" id="calendar-month-title">
          </div>
          <div class="calendar-month-nav">
            <button class="calendar-nav-btn" id="calendar-prev-month">â†</button>
            <button class="calendar-nav-btn" id="calendar-next-month">â†’</button>
          </div>
        </div>

        <div class="calendar-body-row">
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <div>é€±</div><div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
            </div>
            <div class="calendar-weeks" id="calendar-weeks"></div>
          </div>
          <div class="calendar-details">
            <div class="calendar-details-title" id="calendar-details-title">
è¨˜éŒ²ã®ã‚ã‚‹æ—¥ã‚’é¸ã¶ã¨ã€ã“ã“ã«ä¸€è¦§ãŒå‡ºã¾ã™ã€‚
            </div>
            <div class="calendar-details-body-scroll" id="calendar-details-body"></div>
          </div>
        </div>

        <div class="calendar-footer-nav">
          <button class="calendar-back-btn" id="calendar-back-year-button">â† å¹´ã‚’é¸ã³ç›´ã™</button>
          <button class="calendar-back-btn" id="calendar-back-view-button">â† DIARY â€“ VIEW</button>
        </div>
      </div>
    </div>

    <!-- Graph Screen -->
    <div class="screen graph-screen screen--hidden" id="graph-screen">
      <div class="content-frame">
        <div class="graph-back-row">
          <button class="graph-back-btn" id="graph-back-button-top">â† DIARY â€“ VIEW</button>
          <div></div>
        </div>

        <div class="diary-header">
          <div class="diary-title">DIARY â€“ GRAPH</div>
          <div class="diary-subtitle">
èª­ã¿è¾¼ã‚“ã æ—¥è¨˜ãƒ‡ãƒ¼ã‚¿ã‚’ã€é‡ãƒ»æ™‚é–“ãƒ»æ°—åˆ†ãƒ»ä½“èª¿ãƒ»ç›®æ¨™ã¨ã®ã‚ºãƒ¬ã§å¯è¦–åŒ–ã—ã¾ã™ã€‚
          </div>
        </div>

        <div class="graph-layout">
          <div class="graph-main-card">
            <div class="graph-title"><span class="icon">ğŸ•’</span><span>RANGE</span></div>
            <div class="graph-controls">
              <div class="graph-chip-group" id="graph-range-group">
                <button class="graph-chip graph-chip--active" data-range="7">7æ—¥</button>
                <button class="graph-chip" data-range="30">30æ—¥</button>
                <button class="graph-chip" data-range="all">å…¨éƒ¨</button>
              </div>
            </div>

            <div class="graph-title" style="margin-top:6px;"><span class="icon">ğŸ“Š</span><span>METRIC</span></div>
            <div class="graph-controls">
              <div class="graph-chip-group" id="graph-metric-group">
                <button class="graph-chip graph-chip--active" data-metric="amount">é‡ (â‘¡)</button>
                <button class="graph-chip" data-metric="time">æ™‚é–“å¸¯ (â‘¢)</button>
                <button class="graph-chip" data-metric="mood">æ°—åˆ† (â‘£)</button>
                <button class="graph-chip" data-metric="drunken">é…”ã„ (â‘¤)</button>
                <button class="graph-chip" data-metric="nextday">ä½“èª¿ (â‘¥)</button>
                <button class="graph-chip" data-metric="amount+nextday">é‡ï¼‹ä½“èª¿</button>
              </div>
            </div>

            <div class="graph-subtitle">
â€» é‡/æ™‚é–“å¸¯/æ°—åˆ†/é…”ã„/ä½“èª¿ã¯ã€å…¥åŠ›æ¬„ã®æ˜Ÿã‚„æ•°å­—ãƒœã‚¿ãƒ³ã‹ã‚‰è¨˜éŒ²ã•ã‚ŒãŸå€¤ã‚’ä½¿ã£ã¦é›†è¨ˆã—ã¦ã„ã¾ã™ã€‚
ã€€é‡ï¼‹ä½“èª¿ã§ã¯ã€é‡ãŒã‚ªãƒ¬ãƒ³ã‚¸ã€ä½“èª¿ãŒç·‘ã€ç›®æ¨™ãƒ©ã‚¤ãƒ³ãŒãƒ”ãƒ³ã‚¯ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </div>

            <div class="graph-legend" id="graph-legend">
              <div><span class="legend-dot" style="background:var(--line-amount);"></span>é‡</div>
              <div><span class="legend-dot" style="background:var(--line-condition);"></span>ä½“èª¿</div>
              <div><span class="legend-dot" style="background:var(--line-target);"></span><span id="graph-legend-target-label">ç›®æ¨™ä¸€æ—¥é£²é…’é‡</span></div>
            </div>

            <div class="graph-canvas-wrap">
              <canvas id="graph-canvas" width="600" height="260"></canvas>
            </div>

            <div class="graph-list" id="graph-list"></div>
          </div>

          <div class="graph-side-card">
            <div class="wine-ranking-box">
              <div class="wine-ranking-header">
                <span class="icon">ğŸ†</span><span>WINE RANKING</span>
              </div>
              <div class="wine-ranking-list" id="wine-ranking-list"></div>
            </div>

            <button class="diary-small-button" id="wine-detail-button" style="margin-bottom:6px;">
              ãƒ¯ã‚¤ãƒ³ä¸€è¦§
            </button>
            <div class="wine-detail-list" id="wine-detail-list"></div>

            <div class="wine-radar-title">TASTING RADAR</div>
            <div class="wine-radar-wrap" id="wine-radar-wrap"></div>
          </div>
        </div>

        <button class="graph-back-btn" id="graph-back-button">â† DIARY â€“ VIEW</button>
      </div>
    </div>

    <div class="home-button" id="home-button">
      <div class="home-button-icon"></div>
    </div>

    <!-- Wine QR Overlay -->
    <div class="overlay" id="qr-overlay">
      <div class="overlay-inner">
        <div class="overlay-header">
          <div class="overlay-title">Bottle Index</div>
          <div class="overlay-close" id="qr-close">Close</div>
        </div>
        <div class="overlay-bottle-list" id="overlay-bottle-list"></div>
        <div class="overlay-footer-note">
Tap QR to preview / Save to download the image.
        </div>
      </div>
    </div>

    <div class="audio-control">
      <div class="audio-icon">â™ª</div>
      <div class="audio-label">Ambient</div>
      <input type="range" min="0" max="1" step="0.01" value="0.5" class="audio-slider" id="bgm-volume" />
    </div>
  </div>

  <audio id="bgm-audio" src="Somehow.mp3" loop></audio>
  <audio id="se-wine1" src="s1.mp3"></audio>
  <audio id="nya-audio" src="nya.mp3"></audio>

  <script>
    const BASE_URL = "https://yumemiru28000.github.io/zzHBD1/index.html";

    const wines = [
      {
        id: "wine1",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "é’ã®å®‰ã‚‰ã",
        q2_producer: "ãƒ¦ãƒ¡ãƒŸã‚‹ãƒ¯ã‚¤ãƒŠãƒªãƒ¼",
        q3_origin: "ã‚ºã‚ºã«ã‚ƒã‚“å³¶",
        q4_variety: "ã‚ºã‚ºã«ã‚ƒã‚“å³¶ç”£ã¶ã©ã†",
        q5_vintage: "2026",
        q6_style: "Signature",
        q7_alcohol: "12.5%",
        q8_world_phrase: "ç©ã‚„ã‹ãªæ³¢ã®ã‚ˆã†ãªå®‰å¯§",
        q9_world_line: "é™ã‘ã•ã¨å®‰ã‚‰ãã‚’ã‚ãªãŸã«",
        q10_message_lines: [
          "ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼",
          "ç´ æ•µãª1å¹´ã«ãªã‚Šã¾ã™ã‚ˆã†ã«âœ¨",
          "ãã—ã¦ã€ãŠã„ã—ã„ãŠé…’ã«å·¡ã‚Šã‚ãˆã¾ã™ã‚ˆã†ã«ğŸ·"
        ],
        q11_pairing: "ãªã‚“ã§ã‚‚",
        q12_storage: "ã‚ãªãŸã«ã¨ã£ã¦å¤§åˆ‡ãªå ´æ‰€",
        q13_craft: "æ³¢ã®ç©ã‚„ã‹ãªæµ·ã§æµ·åº•ç†Ÿæˆã•ã›ãŸã‚‚ã®",
        display_en: "CALM OF BLUE",
        tagline: "ISLAND NIGHT SELECTION",
        openCount: 0
      },
      {
        id: "wine2",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "Orseille Rose Wine",
        q2_producer: "æ˜Ÿãƒãƒ¯ã‚¤ãƒŠãƒªãƒ¼",
        q3_origin: "æ—¥æœ¬",
        q4_variety: "æ˜Ÿãƒãƒ‘ãƒ¼ãƒ—ãƒ«",
        q5_vintage: "1980",
        q6_style: "Signature",
        q7_alcohol: "12.0%",
        q8_world_phrase: "æ°—åˆ†ä¸Šã€…",
        q9_world_line: "æ¥½ã—ã„æ™‚é–“ã‚’å…±ã«",
        q10_message_lines: [
          "ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼"
        ],
        q11_pairing: "ã‚¤ã‚¿ãƒªã‚¢ãƒ³",
        q12_storage: "æ¶¼ã—ãã¦æš—ã„ã¨ã“ã‚",
        q13_craft: "è·äººãŒä¸å¯§ã«ä½œã‚Šã¾ã—ãŸ",
        display_en: "ROSE MOMENT",
        tagline: "A PERFECT MATCH WITH ITALIAN CUISINE",
        openCount: 0
      },
      {
        id: "wine3",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "è’¼æµ·ã®çœ ã‚Š",
        q2_producer: "ç€¬æˆ¸å†…ãƒ»ä¿¡é•·ã‚¢ãƒãƒé†¸é€ æ‰€",
        q3_origin: "æ—¥æœ¬ãƒ»ç€¬æˆ¸å†…æµ·æ²–",
        q4_variety: "ç”²å·ç¨® 100%ã€ã‚·ãƒ£ãƒ«ãƒ‰ãƒãƒ–ãƒ¬ãƒ³ãƒ‰",
        q5_vintage: "2020",
        q6_style: "Premium",
        q7_alcohol: "12.0%",
        q8_world_phrase: "è’ç«‹ã£ãŸå¿ƒã‚’é®ã‚ã€æ·±æµ·ã«æŠ±ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªæ·±ã„å®‰ã‚‰ãã¨çœ ã‚Šã‚’ã‚‚ãŸã‚‰ã™ã€‚",
        q9_world_line: "ã€Œæ³¢ã®ã‚†ã‚‰ããŒè‚²ã¦ãŸã€æ·±æµ·ã®ã‚¢ãƒ¼ãƒˆãƒ”ãƒ¼ã‚¹ã€‚ã€",
        q10_message_lines: [
          "ã¾ã‚‹ã§æµ·åº•ã§ç†Ÿæˆã•ã‚ŒãŸãƒ¯ã‚¤ãƒ³ã®ã‚ˆã†ã«ã€",
          "æ™‚ã¨ã„ã†æ³¢ã«æ‰ã¾ã‚Œã‚‹ã“ã¨ã§ã€",
          "ã‹ã¹ã‚‹ã­ãµã‚‰ã‚“ã•ã‚“ã®ä¸­ã§è‰¯ã„æ„å‘³ã§è§’ãŒå–ã‚Œã€",
          "ã‹ã‘ãŒãˆã®ãªã„äººé–“çš„ãªåšã¿ã‚„ã¾ã‚ã‚„ã‹ã•ãŒç”Ÿã¾ã‚Œã¦ã„ã‚‹ã®ã‚’æ„Ÿã˜ã¾ã™ã€‚",
          "å¹´é½¢ã¨ã¨ã‚‚ã«é‡ã­ã¦ã„ãçµŒé¨“ã®è·¡ã¯ã€",
          "ã¾ã•ã«è±Šã‹ãªäººç”Ÿã®æµ·ã‚’æ³³ã„ã§ããŸæ™‚é–“ã®è¨¼æ˜ã§ã™ã­ã€‚",
          "ãã‚“ãªç´ æ•µãªå¹´ã®é‡ã­æ–¹ã‚’ã•ã‚Œã¦ã„ã‚‹ã‹ã¹ã‚‹ã­ãµã‚‰ã‚“ã•ã‚“ã«ã€",
          "ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã€‚"
        ],
        q11_pairing: "ç”Ÿç‰¡è £ï¼ˆãƒ¬ãƒ¢ãƒ³æ·»ãˆï¼‰ã€ç™½èº«é­šã®æ˜†å¸ƒç· ã‚ã€ä¼Šå‹¢æµ·è€ã®ã‚°ãƒªãƒ«ã€‚",
        q12_storage: "ç›´å°„æ—¥å…‰ã‚’é¿ã‘ã€æš—ãé™ã‹ãªå ´æ‰€",
        q13_craft: "æµ·åº•ç†Ÿæˆ",
        display_en: "SILENCE OF THE DEEP",
        tagline: "PAIRING WITH OCEAN DELICACIES",
        openCount: 0
      },
      {
        id: "wine4",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "Nyadal",
        q2_producer: "ã›ã´ã‚ã‚ã„ãªã‚Šãƒ¼",
        q3_origin: "ã‹ã«ã‚ƒã ",
        q4_variety: "Nyadal Blanc",
        q5_vintage: "2025",
        q6_style: "Premium",
        q7_alcohol: "12.5%",
        q8_world_phrase: "ã‚ã¾ãˆã­ã“ã«ãªã‚‹",
        q9_world_line: "ã­ã“ã«ãŠã™ã™ã‚ï¼",
        q10_message_lines: [
          "ã‹ã¹ã‚‹ã­ã•ã‚“ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ï½ï½ï½â™¡â™¡â™¡â™¡â™¡"
        ],
        q11_pairing: "ã¡ãƒ¼ãšã¨ã‹ã‘ãƒ¼ã",
        q12_storage: "ã¤ã‚ãŸã„ã¯ã“ï¼",
        q13_craft: "ã­ã“ãŸã¡ãŒã“ãŠã£ãŸã¶ã©ã†ã‚’ã‚ã£ã•ãã—ã¾ã—ãŸï¼",
        display_en: "NYADAL SWEET TIME",
        tagline: "A GIFT FOR CAT LOVERS",
        openCount: 0
      },
      {
        id: "wine5",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "ã™ã£ã”ãç¾å‘³ã—ã„ãƒ¯ã‚¤ãƒ³",
        q2_producer: "NEKOmata Vineyard",
        q3_origin: "Neko island",
        q4_variety: "æ˜Ÿã‚’å®¿ã™ãƒ¦ãƒ‹ãƒ»ãƒ–ãƒ©ãƒ³",
        q5_vintage: "1900",
        q6_style: "Casual Sip",
        q7_alcohol: "12.0%",
        q8_world_phrase: "ä¸–ç•ŒãŒç¾ã—ãè¦‹ãˆã‚‹",
        q9_world_line: "ã‚ãªãŸã®æ˜Ÿã‚’è¦‹ä¸Šã’ã¦ãã ã•ã„",
        q10_message_lines: [
          "ğŸ‡ã‹ã¹ã‚‹ã­ãµã‚‰ã‚“ã•ã‚“ï¼",
          "å¿ƒã‹ã‚‰ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼",
          "ã“ã‚Œã‹ã‚‰ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ğŸ’•ğŸ‚âœ¨"
        ],
        q11_pairing: "ã“ã®ä¸–ç•Œã®é£Ÿã¹ç‰©ã¯ã™ã¹ã¦",
        q12_storage: "ã‚ãªãŸã®å¿ƒã®å¥¥",
        q13_craft: "æ¥­ç•Œã®ç§˜å¯†ã§ã™ï¼ğŸ˜†",
        display_en: "YOUR STAR MOMENT",
        tagline: "A CELEBRATION JUST FOR YOU",
        openCount: 0
      }
    ];

    let currentIndex = 2;
    let activeWineIndex = null;
    let homeIsVisible = true;
    let interactionLocked = false;
    let revisitCountKeyPrefix = "wine-open-count-";

    const homeScreen = document.getElementById("home-screen");
    const winexpScreen = document.getElementById("winexp-screen");
    const diaryHomeScreen = document.getElementById("diary-home-screen");
    const diaryNewScreen = document.getElementById("diary-new-screen");
    const diaryAppendScreen = document.getElementById("diary-append-screen");
    const diaryViewScreen = document.getElementById("diary-view-screen");
    const calendarMonthScreen = document.getElementById("calendar-month-screen");
    const graphScreen = document.getElementById("graph-screen");

    const diaryButton = document.getElementById("diary-button");
    const bottleStrip = document.getElementById("bottle-strip");
    const qrToggle = document.getElementById("qr-toggle");
    const qrOverlay = document.getElementById("qr-overlay");
    const qrClose = document.getElementById("qr-close");
    const overlayBottleList = document.getElementById("overlay-bottle-list");

    const winexpTitleJp = document.getElementById("winexp-title-jp");
    const winexpTitleEn = document.getElementById("winexp-title-en");
    const basicInfoSection = document.getElementById("basic-info-section");
    const worldSection = document.getElementById("world-section");
    const worldLinePrimary = document.getElementById("world-line-primary");
    const worldLineSecondary = document.getElementById("world-line-secondary");
    const messageWax = document.getElementById("message-wax");
    const messageCard = document.getElementById("message-card");
    const messageBody = document.getElementById("message-body");
    const accordionList = document.getElementById("accordion-list");
    const winexpBgLayer = document.getElementById("winexp-bg-layer");
    const nightStars = document.getElementById("night-stars");
    const homeButton = document.getElementById("home-button");

    const wineTitleBubble = document.getElementById("wine-title-bubble");
    const wineTitleBubbleText = document.getElementById("wine-title-bubble-text");
    const winexpBottleHero = document.getElementById("winexp-bottle-hero");
    const winexpBottleHeroImg = document.getElementById("winexp-bottle-hero-img");
    const pawButton = document.getElementById("paw-button");

    const bgmAudio = document.getElementById("bgm-audio");
    const bgmVolumeSlider = document.getElementById("bgm-volume");
    const seWine1 = document.getElementById("se-wine1");
    const nyaAudio = document.getElementById("nya-audio");

    const homeCalendarFile = document.getElementById("home-calendar-file");
    const homeAppendFile = document.getElementById("home-append-file");

    // Diary DOM (New)
    const diaryNewBackButton = document.getElementById("diary-new-back-button");
    const diaryAppendBackButton = document.getElementById("diary-append-back-button");
    const diaryDateInput = document.getElementById("diary-date");
    const diaryNameInput = document.getElementById("diary-name");
    const diaryBrandInput = document.getElementById("diary-brand");
    const diaryAmountInput = document.getElementById("diary-amount");
    const diaryAbvInput = document.getElementById("diary-abv");
    const diaryTasteInput = document.getElementById("diary-taste");
    const diaryAromaInput = document.getElementById("diary-aroma");
    const diaryColorInput = document.getElementById("diary-color");
    const diaryCommentInput = document.getElementById("diary-comment");
    const diaryTimezoneInput = document.getElementById("diary-timezone");
    const diaryMoodInput = document.getElementById("diary-mood");
    const diaryFoodInput = document.getElementById("diary-food");
    const diaryPlaceInput = document.getElementById("diary-place");
    const diaryDrunkenInput = document.getElementById("diary-drunken");
    const diaryNextdayInput = document.getElementById("diary-nextday");
    const diaryColorPicker = document.getElementById("diary-color-picker");

    const diaryTargetAmountInput = document.getElementById("diary-target-amount");
    const diaryTargetTimeInput = document.getElementById("diary-target-time");
    const diaryWeekAmountInput = document.getElementById("diary-week-amount");
    const diaryWeekDaysInput = document.getElementById("diary-week-days");

    const diaryGenerateQrButton = document.getElementById("diary-generate-qr-button");
    const diaryQrPreview = document.getElementById("diary-qr-preview");
    const diaryQrCanvas = document.getElementById("diary-qr-canvas");
    const diaryQrSaveButton = document.getElementById("diary-qr-save-button");

    // Diary DOM (Append)
    const diaryAppendFile = document.getElementById("diary-append-file");
    const diaryAppendStatus = document.getElementById("diary-append-status");
    const diaryAppendFormRow = document.getElementById("diary-append-form-row");

    const diaryDateAppendInput = document.getElementById("diary-date-append");
    const diaryNameAppendInput = document.getElementById("diary-name-append");
    const diaryBrandAppendInput = document.getElementById("diary-brand-append");
    const diaryAmountAppendInput = document.getElementById("diary-amount-append");
    const diaryAbvAppendInput = document.getElementById("diary-abv-append");
    const diaryTasteAppendInput = document.getElementById("diary-taste-append");
    const diaryAromaAppendInput = document.getElementById("diary-aroma-append");
    const diaryColorAppendInput = document.getElementById("diary-color-append");
    const diaryCommentAppendInput = document.getElementById("diary-comment-append");
    const diaryTimezoneAppendInput = document.getElementById("diary-timezone-append");
    const diaryMoodAppendInput = document.getElementById("diary-mood-append");
    const diaryFoodAppendInput = document.getElementById("diary-food-append");
    const diaryPlaceAppendInput = document.getElementById("diary-place-append");
    const diaryDrunkenAppendInput = document.getElementById("diary-drunken-append");
    const diaryNextdayAppendInput = document.getElementById("diary-nextday-append");
    const diaryColorPickerAppend = document.getElementById("diary-color-picker-append");

    const diaryTargetAmountAppendInput = document.getElementById("diary-target-amount-append");
    const diaryTargetTimeAppendInput = document.getElementById("diary-target-time-append");
    const diaryWeekAmountAppendInput = document.getElementById("diary-week-amount-append");
    const diaryWeekDaysAppendInput = document.getElementById("diary-week-days-append");

    const diaryAppendGenerateButton = document.getElementById("diary-append-generate-button");
    const diaryAppendQrPreview = document.getElementById("diary-append-qr-preview");
    const diaryAppendQrCanvas = document.getElementById("diary-append-qr-canvas");
    const diaryAppendQrSaveButton = document.getElementById("diary-append-qr-save-button");

    const diaryViewFile = document.getElementById("diary-view-file");
    const diaryViewReadButton = document.getElementById("diary-view-read-button");
    const diaryViewStatus = document.getElementById("diary-view-status");
    const calendarYearCard = document.getElementById("calendar-year-card");
    const calendarYearGrid = document.getElementById("calendar-year-grid");

    const calendarHeaderTitle = document.getElementById("calendar-header-title");
    const calendarHeaderSubtitle = document.getElementById("calendar-header-subtitle");
    const calendarMonthTitle = document.getElementById("calendar-month-title");
    const calendarWeeks = document.getElementById("calendar-weeks");
    const calendarPrevMonthButton = document.getElementById("calendar-prev-month");
    const calendarNextMonthButton = document.getElementById("calendar-next-month");
    const calendarDetailsTitle = document.getElementById("calendar-details-title");
    const calendarDetailsBody = document.getElementById("calendar-details-body");
    const calendarBackYearButton = document.getElementById("calendar-back-year-button");
    const calendarBackViewButton = document.getElementById("calendar-back-view-button");

    const diaryNewEntryButton = document.getElementById("diary-new-entry-button");
    const diaryAppendButton = document.getElementById("diary-append-button");
    const diaryViewButton = document.getElementById("diary-view-button");

    const graphCanvas = document.getElementById("graph-canvas");
    const graphCtx = graphCanvas.getContext("2d");
    const graphRangeGroup = document.getElementById("graph-range-group");
    const graphMetricGroup = document.getElementById("graph-metric-group");
    const graphList = document.getElementById("graph-list");
    const graphLegend = document.getElementById("graph-legend");
    const graphLegendTargetLabel = document.getElementById("graph-legend-target-label");
    const wineRankingList = document.getElementById("wine-ranking-list");
    const wineDetailButton = document.getElementById("wine-detail-button");
    const wineDetailList = document.getElementById("wine-detail-list");
    const wineRadarWrap = document.getElementById("wine-radar-wrap");
    const graphBackButton = document.getElementById("graph-back-button");
    const graphBackButtonTop = document.getElementById("graph-back-button-top");
    const graphOpenButton = document.getElementById("graph-open-button");

    const homeCalendarShortcut = document.getElementById("home-calendar-shortcut");
    const homeAppendShortcut = document.getElementById("home-append-shortcut");

    let diaryColorSelected = "#f97316";
    let diaryColorSelectedAppend = "#f97316";
    let loadedDiaryEntries = [];
    let loadedDiaryMeta = {
      targetAmount: null,
      targetTime: null,
      weekAmount: null,
      weekDays: null
    };
    let loadedDiaryStruct = null;
    let calendarCurrentYear = null;
    let calendarCurrentMonth = null;
    let graphRange = "7";
    let graphMetric = "amount";
    let originalAppendFileName = "diary_updated.png";

    function hideAllScreensExcept(screen) {
      [
        homeScreen,
        winexpScreen,
        diaryHomeScreen,
        diaryNewScreen,
        diaryAppendScreen,
        diaryViewScreen,
        calendarMonthScreen,
        graphScreen
      ].forEach(s => {
        if (s === screen) return;
        s.classList.add("screen--hidden");
        s.classList.remove("screen--active");
      });
    }

    /* Home / Wine */

    function renderHomeBottles() {
      bottleStrip.innerHTML = "";
      const visibleMain = 3;
      if (wines.length <= visibleMain) {
        for (let i = 0; i < wines.length; i++) appendBottleItem(i, false, false);
        return;
      }
      let start = currentIndex - 1;
      let end = currentIndex + 2;
      if (start < 0) {
        start = 0;
        end = start + visibleMain;
      }
      if (end > wines.length) {
        end = wines.length;
        start = end - visibleMain;
      }
      const leftIndex = start - 1;
      const rightIndex = end;
      if (leftIndex >= 0) appendBottleItem(leftIndex, true, true);
      for (let i = start; i < end; i++) appendBottleItem(i, false, false);
      if (rightIndex < wines.length) appendBottleItem(rightIndex, true, false);
    }

    function appendBottleItem(i, isSide, isLeftSide) {
      const wine = wines[i];
      const item = document.createElement("div");
      item.className = "bottle-item";
      if (isSide) item.classList.add("bottle-item--side");
      else if (i === currentIndex) item.classList.add("bottle-item--focused");
      else item.classList.add("bottle-item--dimmed");

      const wrap = document.createElement("div");
      wrap.className = "bottle-image-wrapper";

      const img = document.createElement("img");
      img.className = "bottle-image";
      img.src = wine.bottleImage;
      img.alt = wine.q1_name;

      const shadow = document.createElement("div");
      shadow.className = "bottle-shadow";

      const reflection = document.createElement("div");
      reflection.className = "bottle-reflection";

      wrap.appendChild(img);
      wrap.appendChild(shadow);
      wrap.appendChild(reflection);
      item.appendChild(wrap);
      bottleStrip.appendChild(item);

      if (isSide) {
        item.addEventListener("click", () => {
          if (!homeIsVisible) return;
          if (isLeftSide) currentIndex = Math.max(0, currentIndex - 1);
          else currentIndex = Math.min(wines.length - 1, currentIndex + 1);
          try { seWine1.currentTime = 0; seWine1.play(); } catch {}
          renderHomeBottles();
        });
      } else {
        item.addEventListener("click", () => {
          if (homeIsVisible) handleBottleTap(i, item);
        });
      }
    }

    function handleBottleTap(index, bottleElement) {
      activeWineIndex = index;
      bottleElement.style.transition = "filter 0.12s var(--transition-standard)";
      bottleElement.style.filter = "brightness(0.92)";
      setTimeout(() => bottleElement.style.filter = "", 120);
      setTimeout(() => {
        homeScreen.style.transition = "filter 0.65s var(--transition-soft)";
        homeScreen.style.filter = "blur(10px) brightness(0.85)";
        showWineXp(index);
      }, 150);
    }

    function showWineXp(index) {
      homeIsVisible = false;
      hideAllScreensExcept(winexpScreen);
      winexpScreen.classList.remove("screen--hidden");
      winexpScreen.classList.add("screen--active");
      document.body.style.overflow = "hidden";
      homeButton.classList.add("home-button--visible");

      const wine = wines[index];
      const key = revisitCountKeyPrefix + wine.id;
      const prevCount = parseInt(localStorage.getItem(key) || "0", 10);
      wine.openCount = prevCount + 1;
      localStorage.setItem(key, String(wine.openCount));

      interactionLocked = true;
      winexpScreen.classList.add("winexp-screen--locked-interaction");
      setTimeout(() => {
        interactionLocked = false;
        winexpScreen.classList.remove("winexp-screen--locked-interaction");
      }, 2500);

      winexpTitleJp.textContent = wine.q1_name || "";
      winexpTitleEn.textContent = wine.display_en || "";
      if (wine.tagline) {
        wineTitleBubble.style.display = "inline-flex";
        wineTitleBubbleText.textContent = wine.tagline;
      } else wineTitleBubble.style.display = "none";

      if (wine.bottleImage) {
        winexpBottleHero.style.display = "flex";
        winexpBottleHeroImg.src = wine.bottleImage;
        winexpBottleHeroImg.alt = wine.q1_name || "";
      } else {
        winexpBottleHero.style.display = "none";
      }

      pawButton.style.display = (wine.id === "wine4") ? "inline-flex" : "none";

      renderBasicInfo(wine);
      worldLinePrimary.textContent = wine.q8_world_phrase || "";
      worldLineSecondary.textContent = wine.q9_world_line || "";
      worldSection.classList.remove("world-section--active");
      worldLinePrimary.classList.remove("world-line-primary--visible");
      worldLineSecondary.classList.remove("world-line-secondary--visible");

      setupMessage(wine);
      renderAccordions(wine);
      updateNightEffects();

      winexpScreen.scrollTop = 0;
      setupScrollAnimations();

      try { seWine1.currentTime = 0; seWine1.play(); } catch {}
    }

    function renderBasicInfo(wine) {
      basicInfoSection.innerHTML = "";
      const blocks = [
        { label: "Wine", value: wine.q1_name },
        { label: "Producer", value: wine.q2_producer },
        { label: "Origin", value: wine.q3_origin },
        { label: "Variety", value: wine.q4_variety },
        { label: "Rank", value: wine.q6_style },
        { label: "Vintage", value: wine.q5_vintage },
        { label: "Alcohol", value: wine.q7_alcohol }
      ];
      blocks.forEach((b, idx) => {
        if (!b.value) return;
        const block = document.createElement("div");
        block.className = "info-block";
        block.style.transitionDelay = `${0.2 * idx}s`;
        const label = document.createElement("div");
        label.className = "info-label";
        label.textContent = b.label;
        const value = document.createElement("div");
        value.className = "info-value";
        value.textContent = b.value;
        block.appendChild(label);
        block.appendChild(value);
        basicInfoSection.appendChild(block);
      });
    }

    function setupMessage(wine) {
      messageWax.classList.remove("message-wax--visible");
      messageCard.classList.remove("message-card--open");
      messageBody.innerHTML = "";
      setTimeout(() => {
        messageWax.classList.add("message-wax--visible");
      }, 600);

      let opened = false;
      const onWaxClick = () => {
        if (opened || interactionLocked) return;
        opened = true;
        messageWax.style.transform = "scale(0.94) translateY(3px)";
        setTimeout(() => {
          messageWax.style.transform = "scale(0.98) translateY(1px)";
        }, 200);
        setTimeout(() => {
          messageCard.classList.add("message-card--open");
          const msgLines = wine.q10_message_lines || [];
          const baseDelay = 200;
          msgLines.forEach((text, idx) => {
            const lineEl = document.createElement("div");
            lineEl.className = "message-line";
            lineEl.textContent = text;
            messageBody.appendChild(lineEl);
            setTimeout(() => {
              lineEl.classList.add("message-line--visible");
            }, baseDelay + idx * 350);
          });
        }, 400);
      };
      messageWax.onclick = onWaxClick;
    }

    function renderAccordions(wine) {
      accordionList.innerHTML = "";
      const accData = [
        { icon: "ğŸ½", title: "Pairing", content: wine.q11_pairing },
        { icon: "ğŸŒ™", title: "Storage", content: wine.q12_storage },
        { icon: "ğŸŒŠ", title: "Craft", content: wine.q13_craft }
      ];
      accData.forEach(item => {
        if (!item.content) return;
        const accItem = document.createElement("div");
        accItem.className = "accordion-item";
        const header = document.createElement("div");
        header.className = "accordion-header";
        const labelWrap = document.createElement("div");
        labelWrap.className = "accordion-label-wrap";
        const iconEl = document.createElement("div");
        iconEl.className = "accordion-icon";
        iconEl.textContent = item.icon;
        const titleEl = document.createElement("div");
        titleEl.className = "accordion-title";
        titleEl.textContent = item.title;
        labelWrap.appendChild(iconEl);
        labelWrap.appendChild(titleEl);
        const arrow = document.createElement("div");
        arrow.className = "accordion-arrow";
        arrow.textContent = ">";
        header.appendChild(labelWrap);
        header.appendChild(arrow);
        const body = document.createElement("div");
        body.className = "accordion-body";
        const text = document.createElement("div");
        text.className = "accordion-text";
        text.textContent = item.content;
        body.appendChild(text);
        accItem.appendChild(header);
        accItem.appendChild(body);
        accordionList.appendChild(accItem);
        header.addEventListener("click", () => {
          accItem.classList.toggle("accordion-item--open");
        });
      });
    }

    function setupScrollAnimations() {
      const infoBlocks = Array.from(basicInfoSection.querySelectorAll(".info-block"));
      const handleScroll = () => {
        const vh = winexpScreen.clientHeight;
        infoBlocks.forEach((block, idx) => {
          const rect = block.getBoundingClientRect();
          if (rect.top < vh - 90) {
            setTimeout(() => block.classList.add("info-block--visible"), idx * 200);
          }
        });
        const worldRect = worldSection.getBoundingClientRect();
        if (worldRect.top < vh - 140) {
          worldSection.classList.add("world-section--active");
          setTimeout(() => worldLinePrimary.classList.add("world-line-primary--visible"), 150);
          setTimeout(() => worldLineSecondary.classList.add("world-line-secondary--visible"), 650);
        }
      };
      winexpScreen.removeEventListener("scroll", handleScroll);
      winexpScreen.addEventListener("scroll", handleScroll);
      handleScroll();
    }

    function isNightTime() {
      const h = new Date().getHours();
      return h >= 22 || h < 5;
    }

    function updateNightEffects() {
      if (isNightTime()) {
        nightStars.classList.add("night-stars--visible");
        winexpBgLayer.style.filter = "brightness(0.9)";
      } else {
        nightStars.classList.remove("night-stars--visible");
        winexpBgLayer.style.filter = "brightness(1)";
      }
    }

    function goHome() {
      if (homeIsVisible) return;
      homeIsVisible = true;
      hideAllScreensExcept(homeScreen);
      homeScreen.classList.add("screen--active");
      document.body.style.overflow = "hidden";
      homeButton.classList.remove("home-button--visible");
      homeScreen.style.filter = "none";
    }

    homeButton.addEventListener("click", () => {
      homeScreen.style.transition = "transform 0.6s var(--transition-standard), opacity 0.6s var(--transition-standard)";
      homeScreen.style.transform = "translateY(0)";
      goHome();
    });

    function openQrOverlay() {
      qrOverlay.classList.add("overlay--open");
    }

    function closeQrOverlay() {
      qrOverlay.classList.remove("overlay--open");
    }

    qrToggle.addEventListener("click", openQrOverlay);
    qrClose.addEventListener("click", closeQrOverlay);
    qrOverlay.addEventListener("click", e => {
      if (e.target === qrOverlay) closeQrOverlay();
    });

    function renderOverlayBottles() {
      overlayBottleList.innerHTML = "";
      wines.forEach(wine => {
        const item = document.createElement("div");
        item.className = "overlay-bottle";
        const imgWrap = document.createElement("div");
        imgWrap.className = "overlay-bottle-img-wrap";
        const img = document.createElement("img");
        img.className = "overlay-bottle-img";
        img.src = wine.bottleImage;
        img.alt = wine.q1_name;
        const shadow = document.createElement("div");
        shadow.className = "overlay-bottle-shadow";
        imgWrap.appendChild(img);
        imgWrap.appendChild(shadow);
        const nameEl = document.createElement("div");
        nameEl.className = "overlay-name";
        nameEl.textContent = wine.q1_name;
        const qrArea = document.createElement("div");
        qrArea.className = "overlay-qr-area";
        const qrCanvasWrap = document.createElement("div");
        qrCanvasWrap.className = "overlay-qr-canvas-wrap";
        qrCanvasWrap.style.width = "120px";
        qrCanvasWrap.style.height = "120px";
        const qrCanvas = document.createElement("canvas");
        qrCanvas.width = 200;
        qrCanvas.height = 200;
        qrCanvasWrap.appendChild(qrCanvas);
        const qrUrl = `${BASE_URL}?wine=${encodeURIComponent(wine.id)}`;
        new QRious({
          element: qrCanvas,
          value: qrUrl,
          size: 200,
          level: "H",
          background: "#ffffff",
          foreground: "#000000"
        });
        const actionRow = document.createElement("div");
        actionRow.className = "overlay-qr-action-row";
        const previewBtn = document.createElement("div");
        previewBtn.className = "overlay-qr-icon";
        previewBtn.textContent = "QR";
        const saveBtn = document.createElement("div");
        saveBtn.className = "overlay-qr-icon";
        saveBtn.textContent = "Save";
        previewBtn.addEventListener("click", e => {
          e.stopPropagation();
          const dataUrl = qrCanvas.toDataURL("image/png");
          const win = window.open();
          if (win) {
            win.document.write('<img src="' + dataUrl + '" style="width:100%;height:auto;"/>');
          }
        });
        saveBtn.addEventListener("click", e => {
          e.stopPropagation();
          const dataUrl = qrCanvas.toDataURL("image/png");
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = `${wine.id}_qr.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });
        actionRow.appendChild(previewBtn);
        actionRow.appendChild(saveBtn);
        qrArea.appendChild(qrCanvasWrap);
        qrArea.appendChild(actionRow);
        item.appendChild(imgWrap);
        item.appendChild(nameEl);
        item.appendChild(qrArea);
        overlayBottleList.appendChild(item);
      });
    }

    function setupBgm() {
      bgmAudio.volume = parseFloat(bgmVolumeSlider.value || "0.5");
      bgmVolumeSlider.addEventListener("input", () => {
        bgmAudio.volume = parseFloat(bgmVolumeSlider.value || "0.5");
      });
      const tryStart = () => {
        bgmAudio.play().catch(() => {});
        document.removeEventListener("click", tryStart);
        document.removeEventListener("touchstart", tryStart);
      };
      document.addEventListener("click", tryStart);
      document.addEventListener("touchstart", tryStart);
    }

    function getWineIdFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get("wine");
    }

    function openWineFromQueryIfNeeded() {
      const wineId = getWineIdFromQuery();
      if (!wineId) return;
      const idx = wines.findIndex(w => w.id === wineId);
      if (idx >= 0) {
        currentIndex = idx;
        renderHomeBottles();
        setTimeout(() => showWineXp(idx), 200);
      }
    }

    pawButton.addEventListener("click", () => {
      try { nyaAudio.currentTime = 0; nyaAudio.play(); } catch {}
    });

    /* Diary Navigation */

    diaryButton.addEventListener("click", () => {
      homeIsVisible = false;
      hideAllScreensExcept(diaryHomeScreen);
      diaryHomeScreen.classList.remove("screen--hidden");
      diaryHomeScreen.classList.add("screen--active");
      homeButton.classList.add("home-button--visible");
    });

    diaryNewEntryButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryNewScreen);
      diaryNewScreen.classList.remove("screen--hidden");
      diaryNewScreen.classList.add("screen--active");
      diaryQrPreview.style.display = "none";
    });

    diaryAppendButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryAppendScreen);
      diaryAppendScreen.classList.remove("screen--hidden");
      diaryAppendScreen.classList.add("screen--active");
      diaryAppendFormRow.style.display = "none";
      diaryAppendQrPreview.style.display = "none";
      diaryAppendStatus.textContent = "";
      diaryAppendFile.value = "";
    });

    diaryViewButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryViewScreen);
      diaryViewScreen.classList.remove("screen--hidden");
      diaryViewScreen.classList.add("screen--active");
      diaryViewStatus.textContent = "";
      calendarYearCard.style.display = "none";
      diaryViewFile.value = "";
    });

    diaryNewBackButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryHomeScreen);
      diaryHomeScreen.classList.remove("screen--hidden");
      diaryHomeScreen.classList.add("screen--active");
    });

    diaryAppendBackButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryHomeScreen);
      diaryHomeScreen.classList.remove("screen--hidden");
      diaryHomeScreen.classList.add("screen--active");
    });

    calendarBackYearButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryViewScreen);
      diaryViewScreen.classList.remove("screen--hidden");
      diaryViewScreen.classList.add("screen--active");
    });

    calendarBackViewButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryViewScreen);
      diaryViewScreen.classList.remove("screen--hidden");
      diaryViewScreen.classList.add("screen--active");
    });

    /* Color Picker */

    function setupColorPicker(container, initial, setter) {
      let active = initial;
      Array.from(container.querySelectorAll(".color-dot-option")).forEach(opt => {
        const color = opt.getAttribute("data-color");
        if (color === active) opt.classList.add("color-dot-option--active");
        opt.addEventListener("click", () => {
          active = color;
          setter(color);
          Array.from(container.querySelectorAll(".color-dot-option")).forEach(o => {
            o.classList.toggle("color-dot-option--active", o === opt);
          });
        });
      });
      setter(active);
    }

    setupColorPicker(diaryColorPicker, "#f97316", c => diaryColorSelected = c);
    setupColorPicker(diaryColorPickerAppend, "#f97316", c => diaryColorSelectedAppend = c);

    /* Star Rating */

    function setupStarRatings() {
      const containers = document.querySelectorAll(".star-rating");
      containers.forEach(container => {
        const field = container.getAttribute("data-field");
        const stars = Array.from(container.querySelectorAll("span"));
        const idMap = {
          taste: "diary-taste",
          aroma: "diary-aroma",
          color: "diary-color",
          mood: "diary-mood",
          drunken: "diary-drunken",
          nextday: "diary-nextday",
          "taste-append": "diary-taste-append",
          "aroma-append": "diary-aroma-append",
          "color-append": "diary-color-append",
          "mood-append": "diary-mood-append",
          "drunken-append": "diary-drunken-append",
          "nextday-append": "diary-nextday-append"
        };
        const hiddenInput = document.getElementById(idMap[field]);
        if (!hiddenInput) return;

        const setValue = v => {
          hiddenInput.value = v ? String(v) : "";
          stars.forEach(s => {
            const sv = parseInt(s.getAttribute("data-value"), 10);
            s.classList.toggle("star-active", sv <= v);
          });
        };

        stars.forEach(star => {
          star.addEventListener("click", () => {
            const v = parseInt(star.getAttribute("data-value"), 10);
            if (hiddenInput.value === String(v)) {
              setValue(0);
            } else {
              setValue(v);
            }
          });
        });
      });
    }

    /* Numeric Pickers */

    function createDigitButtons(targetEl, digits) {
      targetEl.innerHTML = "";
      digits.forEach(d => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "numeric-digit-btn";
        btn.textContent = d;
        btn.dataset.value = d;
        targetEl.appendChild(btn);
      });
    }

    function setupAmountPicker(displayId, hiddenId, hundredsTarget, tensTarget, onesTarget) {
      const hundredsEl = document.querySelector(`[data-target="${hundredsTarget}"]`);
      const tensEl = document.querySelector(`[data-target="${tensTarget}"]`);
      const onesEl = document.querySelector(`[data-target="${onesTarget}"]`);
      if (!hundredsEl || !tensEl || !onesEl) return;
      createDigitButtons(hundredsEl, ["0","1","2","3","4","5","6","7","8","9"]);
      createDigitButtons(tensEl, ["0","1","2","3","4","5","6","7","8","9"]);
      createDigitButtons(onesEl, ["0","1","2","3","4","5","6","7","8","9"]);
      let h = "0", t = "0", o = "0";
      const display = document.getElementById(displayId);
      const hidden = document.getElementById(hiddenId);

      function update() {
        const val = h + t + o;
        const n = parseInt(val,10) || 0;
        hidden.value = String(n);
        display.textContent = `${n} ml`;
      }

      const bind = (el, setter) => {
        el.addEventListener("click", e => {
          const btn = e.target.closest(".numeric-digit-btn");
          if (!btn) return;
          setter(btn.dataset.value);
          Array.from(el.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b === btn));
          update();
        });
      };
      bind(hundredsEl, v => h = v);
      bind(tensEl, v => t = v);
      bind(onesEl, v => o = v);
      update();

      return {
        setValue(n) {
          n = Math.max(0, Math.min(999, n|0));
          const s = String(n).padStart(3,"0");
          h = s[0]; t = s[1]; o = s[2];
          Array.from(hundredsEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===h));
          Array.from(tensEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===t));
          Array.from(onesEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===o));
          update();
        }
      };
    }

    function setupAbvPicker(displayId, hiddenId, tTarget, oTarget, dTarget) {
      const tEl = document.querySelector(`[data-target="${tTarget}"]`);
      const oEl = document.querySelector(`[data-target="${oTarget}"]`);
      const dEl = document.querySelector(`[data-target="${dTarget}"]`);
      if (!tEl || !oEl || !dEl) return;
      createDigitButtons(tEl, ["0","1","2","3","4"]);
      createDigitButtons(oEl, ["0","1","2","3","4","5","6","7","8","9"]);
      createDigitButtons(dEl, ["0","1","2","3","4","5","6","7","8","9"]);
      let it = "0", io = "0", dec = "0";
      const display = document.getElementById(displayId);
      const hidden = document.getElementById(hiddenId);

      function update() {
        const val = `${it}${io}.${dec}`;
        hidden.value = val;
        display.textContent = `${val} %`;
      }

      const bind = (el, setter) => {
        el.addEventListener("click", e => {
          const btn = e.target.closest(".numeric-digit-btn");
          if (!btn) return;
          setter(btn.dataset.value);
          Array.from(el.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b === btn));
          update();
        });
      };
      bind(tEl, v => it = v);
      bind(oEl, v => io = v);
      bind(dEl, v => dec = v);
      update();

      return {
        setValue(v) {
          const n = parseFloat(v);
          if (isNaN(n)) return;
          const s = n.toFixed(1).padStart(4,"0");
          it = s[0]; io = s[1]; dec = s[3];
          Array.from(tEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===it));
          Array.from(oEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===io));
          Array.from(dEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===dec));
          update();
        }
      };
    }

    function setupTimePicker(displayId, hiddenId, htTarget, hoTarget, mtTarget, moTarget) {
      const htEl = document.querySelector(`[data-target="${htTarget}"]`);
      const hoEl = document.querySelector(`[data-target="${hoTarget}"]`);
      const mtEl = document.querySelector(`[data-target="${mtTarget}"]`);
      const moEl = document.querySelector(`[data-target="${moTarget}"]`);
      if (!htEl || !hoEl || !mtEl || !moEl) return;
      createDigitButtons(htEl, ["0","1","2"]);
      createDigitButtons(hoEl, ["0","1","2","3","4","5","6","7","8","9"]);
      createDigitButtons(mtEl, ["0","1","2","3","4","5"]);
      createDigitButtons(moEl, ["0","1","2","3","4","5","6","7","8","9"]);
      let ht = "0", ho = "0", mt = "0", mo = "0";
      const display = document.getElementById(displayId);
      const hidden = document.getElementById(hiddenId);

      function update() {
        let hour = parseInt(ht + ho,10);
        if (hour > 23) hour = 23;
        let min = parseInt(mt + mo,10);
        if (min > 59) min = 59;
        const hs = hour.toString().padStart(2,"0");
        const ms = min.toString().padStart(2,"0");
        hidden.value = `${hs}:${ms}`;
        display.textContent = `${hs}:${ms}`;
      }

      const bind = (el, setter) => {
        el.addEventListener("click", e => {
          const btn = e.target.closest(".numeric-digit-btn");
          if (!btn) return;
          setter(btn.dataset.value);
          Array.from(el.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b === btn));
          update();
        });
      };
      bind(htEl, v => ht = v);
      bind(hoEl, v => ho = v);
      bind(mtEl, v => mt = v);
      bind(moEl, v => mo = v);
      update();

      return {
        setValue(str) {
          if (!str) return;
          const m = String(str).match(/(\d{1,2})[:ï¼š](\d{1,2})/);
          if (!m) return;
          let h = Math.max(0, Math.min(23, parseInt(m[1],10)));
          let mn = Math.max(0, Math.min(59, parseInt(m[2],10)));
          const hs = h.toString().padStart(2,"0");
          const ms = mn.toString().padStart(2,"0");
          ht = hs[0]; ho = hs[1];
          mt = ms[0]; mo = ms[1];
          Array.from(htEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===ht));
          Array.from(hoEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===ho));
          Array.from(mtEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===mt));
          Array.from(moEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===mo));
          update();
        }
      };
    }

    function setupWeekAmountPicker(displayId, hiddenId, hTarget, tTarget, oTarget) {
      const hEl = document.querySelector(`[data-target="${hTarget}"]`);
      const tEl = document.querySelector(`[data-target="${tTarget}"]`);
      const oEl = document.querySelector(`[data-target="${oTarget}"]`);
      if (!hEl || !tEl || !oEl) return;
      createDigitButtons(hEl, ["0","1","2","3","4","5","6","7","8","9"]);
      createDigitButtons(tEl, ["0","1","2","3","4","5","6","7","8","9"]);
      createDigitButtons(oEl, ["0","1","2","3","4","5","6","7","8","9"]);
      let h = "0", t = "0", o = "0";
      const display = document.getElementById(displayId);
      const hidden = document.getElementById(hiddenId);

      function update() {
        const val = h + t + o;
        const n = parseInt(val,10) || 0;
        hidden.value = String(n);
        display.textContent = `${n} g`;
      }

      const bind = (el, setter) => {
        el.addEventListener("click", e => {
          const btn = e.target.closest(".numeric-digit-btn");
          if (!btn) return;
          setter(btn.dataset.value);
          Array.from(el.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b === btn));
          update();
        });
      };
      bind(hEl, v => h = v);
      bind(tEl, v => t = v);
      bind(oEl, v => o = v);
      update();

      return {
        setValue(n) {
          n = Math.max(0, Math.min(999, n|0));
          const s = String(n).padStart(3,"0");
          h = s[0]; t = s[1]; o = s[2];
          Array.from(hEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===h));
          Array.from(tEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===t));
          Array.from(oEl.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b.dataset.value===o));
          update();
        }
      };
    }

    function setupWeekDaysPicker(displayId, hiddenId, containerId) {
      const container = document.getElementById(containerId);
      const display = document.getElementById(displayId);
      const hidden = document.getElementById(hiddenId);
      if (!container) return;
      container.innerHTML = "";
      for (let i=0;i<=7;i++) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "numeric-digit-btn";
        btn.textContent = String(i);
        btn.dataset.value = String(i);
        container.appendChild(btn);
      }
      let val = 0;
      function update() {
        hidden.value = String(val);
        display.textContent = `${val} æ—¥`;
      }
      container.addEventListener("click", e => {
        const btn = e.target.closest(".numeric-digit-btn");
        if (!btn) return;
        val = parseInt(btn.dataset.value,10);
        Array.from(container.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", b===btn));
        update();
      });
      update();
      return {
        setValue(n) {
          n = Math.max(0, Math.min(7, n|0));
          val = n;
          Array.from(container.children).forEach(b => b.classList.toggle("numeric-digit-btn--active", parseInt(b.dataset.value,10)===n));
          update();
        }
      };
    }

    let amountPicker, abvPicker, timePicker;
    let targetAmountPicker, targetTimePicker, weekAmountPicker, weekDaysPicker;
    let amountAppendPicker, abvAppendPicker, timeAppendPicker;
    let targetAmountAppendPicker, targetTimeAppendPicker, weekAmountAppendPicker, weekDaysAppendPicker;

    function setupNumericPickers() {
      amountPicker = setupAmountPicker("amount-display", "diary-amount", "amount-hundreds", "amount-tens", "amount-ones");
      abvPicker = setupAbvPicker("abv-display", "diary-abv", "abv-int-tens", "abv-int-ones", "abv-decimal");
      timePicker = setupTimePicker("time-display", "diary-timezone", "time-hour-tens", "time-hour-ones", "time-min-tens", "time-min-ones");

      targetAmountPicker = setupAmountPicker("target-amount-display", "diary-target-amount", "target-amount-hundreds", "target-amount-tens", "target-amount-ones");
      targetTimePicker = setupTimePicker("target-time-display", "diary-target-time", "target-time-hour-tens", "target-time-hour-ones", "target-time-min-tens", "target-time-min-ones");
      weekAmountPicker = setupWeekAmountPicker("week-amount-display", "diary-week-amount", "week-amount-hundreds", "week-amount-tens", "week-amount-ones");
      weekDaysPicker = setupWeekDaysPicker("week-days-display", "diary-week-days", "week-days-buttons");

      amountAppendPicker = setupAmountPicker("amount-append-display", "diary-amount-append", "amount-append-hundreds", "amount-append-tens", "amount-append-ones");
      abvAppendPicker = setupAbvPicker("abv-append-display", "diary-abv-append", "abv-append-int-tens", "abv-append-int-ones", "abv-append-decimal");
      timeAppendPicker = setupTimePicker("time-append-display", "diary-timezone-append", "time-append-hour-tens", "time-append-hour-ones", "time-append-min-tens", "time-append-min-ones");

      targetAmountAppendPicker = setupAmountPicker("target-amount-append-display", "diary-target-amount-append", "target-amount-append-hundreds", "target-amount-append-tens", "target-amount-append-ones");
      targetTimeAppendPicker = setupTimePicker("target-time-append-display", "diary-target-time-append", "target-time-append-hour-tens", "target-time-append-hour-ones", "target-time-append-min-tens", "target-time-append-min-ones");
      weekAmountAppendPicker = setupWeekAmountPicker("week-amount-append-display", "diary-week-amount-append", "week-amount-append-hundreds", "week-amount-append-tens", "week-amount-append-ones");
      weekDaysAppendPicker = setupWeekDaysPicker("week-days-append-display", "diary-week-days-append", "week-days-append-buttons");
    }

    /* UTF-8 Base64 Diary Encode/Decode */

    function utf8ToBase64(str) {
      const encoder = new TextEncoder();
      const bytes = encoder.encode(str);
      let binary = "";
      bytes.forEach(b => binary += String.fromCharCode(b));
      return btoa(binary);
    }

    function base64ToUtf8(b64) {
      const binary = atob(b64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      const decoder = new TextDecoder();
      return decoder.decode(bytes);
    }

    function buildDiaryEntryFromInputs(isAppend = false) {
      const date = isAppend ? diaryDateAppendInput.value : diaryDateInput.value;
      if (!date) return null;

      return {
        date,
        name: isAppend ? diaryNameAppendInput.value : diaryNameInput.value,
        brand: isAppend ? diaryBrandAppendInput.value : diaryBrandInput.value,
        amount: isAppend ? diaryAmountAppendInput.value : diaryAmountInput.value,
        abv: isAppend ? diaryAbvAppendInput.value : diaryAbvInput.value,
        taste: isAppend ? diaryTasteAppendInput.value : diaryTasteInput.value,
        aroma: isAppend ? diaryAromaAppendInput.value : diaryAromaInput.value,
        colorNote: isAppend ? diaryColorAppendInput.value : diaryColorInput.value,
        comment: isAppend ? diaryCommentAppendInput.value : diaryCommentInput.value,
        timezone: isAppend ? diaryTimezoneAppendInput.value : diaryTimezoneInput.value,
        mood: isAppend ? diaryMoodAppendInput.value : diaryMoodInput.value,
        food: isAppend ? diaryFoodAppendInput.value : diaryFoodInput.value,
        place: isAppend ? diaryPlaceAppendInput.value : diaryPlaceInput.value,
        drunken: isAppend ? diaryDrunkenAppendInput.value : diaryDrunkenInput.value,
        nextday: isAppend ? diaryNextdayAppendInput.value : diaryNextdayInput.value,
        dotColor: isAppend ? diaryColorSelectedAppend : diaryColorSelected
      };
    }

    function readGoalsFromInputs(isAppend = false) {
      if (isAppend) {
        return {
          targetAmount: diaryTargetAmountAppendInput.value || null,
          targetTime: diaryTargetTimeAppendInput.value || null,
          weekAmount: diaryWeekAmountAppendInput.value || null,
          weekDays: diaryWeekDaysAppendInput.value || null
        };
      }
      return {
        targetAmount: diaryTargetAmountInput.value || null,
        targetTime: diaryTargetTimeInput.value || null,
        weekAmount: diaryWeekAmountInput.value || null,
        weekDays: diaryWeekDaysInput.value || null
      };
    }

    function buildDiaryStruct(entries, goals) {
      return {
        type: "diary",
        version: 2,
        goals: goals || null,
        entries
      };
    }

    function encodeDiaryToQR(canvas, struct) {
      const innerJson = JSON.stringify(struct);
      const b64 = utf8ToBase64(innerJson);
      const wrapper = { type: "diary-base64", data: b64 };
      const finalJson = JSON.stringify(wrapper);
      new QRious({
        element: canvas,
        value: finalJson,
        size: 512,
        level: "H",
        background: "#ffffff",
        foreground: "#000000"
      });
    }

    function tryParseDiaryFromQrString(str) {
      const outer = JSON.parse(str);
      if (outer.type === "diary-base64" && outer.data) {
        const innerStr = base64ToUtf8(outer.data);
        const inner = JSON.parse(innerStr);
        if (inner.type === "diary" && Array.isArray(inner.entries)) {
          return inner;
        }
      }
      const maybeDiary = JSON.parse(str);
      if (maybeDiary.type === "diary" && Array.isArray(maybeDiary.entries)) {
        return maybeDiary;
      }
      throw new Error("æ—¥è¨˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    }

    diaryGenerateQrButton.addEventListener("click", () => {
      const entry = buildDiaryEntryFromInputs(false);
      if (!entry) {
        alert("æ—¥ä»˜ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }
      const goals = readGoalsFromInputs(false);
      const struct = buildDiaryStruct([entry], goals);
      encodeDiaryToQR(diaryQrCanvas, struct);
      diaryQrPreview.style.display = "none";

      const dataUrl = diaryQrCanvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "diary_entry.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    diaryQrSaveButton.addEventListener("click", () => {
      const dataUrl = diaryQrCanvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "diary_entry.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    /* QR Reader */

    function readQrImageFile(file, callback) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const size = 512;
          const canvas = document.createElement("canvas");
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, size, size);
          const imageData = ctx.getImageData(0, 0, size, size);
          const code = jsQR(imageData.data, size, size);
          if (code) callback(null, code.data);
          else callback(new Error("QRã‚³ãƒ¼ãƒ‰ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"));
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    /* Diary Append */

    diaryAppendFile.addEventListener("change", () => {
      const file = diaryAppendFile.files[0];
      if (!file) return;
      originalAppendFileName = file.name || "diary_updated.png";
      diaryAppendStatus.textContent = "èª­ã¿å–ã‚Šä¸­â€¦";
      diaryAppendFormRow.style.display = "none";
      diaryAppendQrPreview.style.display = "none";
      readQrImageFile(file, (err, data) => {
        if (err) {
          diaryAppendStatus.textContent = "ã‚¨ãƒ©ãƒ¼: " + err.message;
          return;
        }
        try {
          const parsedDiary = tryParseDiaryFromQrString(data);
          loadedDiaryStruct = parsedDiary;
          loadedDiaryEntries = parsedDiary.entries || [];
          loadedDiaryMeta = parsedDiary.goals || {
            targetAmount: null,
            targetTime: null,
            weekAmount: null,
            weekDays: null
          };

          diaryAppendStatus.textContent = "ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚æ–°ã—ã„1æ—¥ã¨ç›®æ¨™ã‚’ç·¨é›†ã§ãã¾ã™ã€‚";
          diaryAppendFormRow.style.display = "flex";

          if (loadedDiaryMeta.targetAmount && targetAmountAppendPicker) {
            targetAmountAppendPicker.setValue(parseInt(loadedDiaryMeta.targetAmount,10) || 0);
          }
          if (loadedDiaryMeta.targetTime && targetTimeAppendPicker) {
            targetTimeAppendPicker.setValue(loadedDiaryMeta.targetTime);
          }
          if (loadedDiaryMeta.weekAmount && weekAmountAppendPicker) {
            weekAmountAppendPicker.setValue(parseInt(loadedDiaryMeta.weekAmount,10) || 0);
          }
          if (loadedDiaryMeta.weekDays && weekDaysAppendPicker) {
            weekDaysAppendPicker.setValue(parseInt(loadedDiaryMeta.weekDays,10) || 0);
          }
        } catch (e) {
          diaryAppendStatus.textContent = "QRã®ä¸­èº«ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
        }
      });
    });

    diaryAppendGenerateButton.addEventListener("click", () => {
      if (!loadedDiaryStruct || !Array.isArray(loadedDiaryStruct.entries)) {
        alert("å…ˆã«æ—¥è¨˜QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }
      const entry = buildDiaryEntryFromInputs(true);
      if (!entry) {
        alert("æ—¥ä»˜ã¯å¿…é ˆã§ã™ã€‚");
        return;
      }
      const newEntries = loadedDiaryStruct.entries.concat(entry);
      const goalsAppend = readGoalsFromInputs(true);
      const struct = buildDiaryStruct(newEntries, goalsAppend);
      encodeDiaryToQR(diaryAppendQrCanvas, struct);
      diaryAppendQrPreview.style.display = "none";

      const dataUrl = diaryAppendQrCanvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = originalAppendFileName || "diary_updated.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    diaryAppendQrSaveButton.addEventListener("click", () => {
      const dataUrl = diaryAppendQrCanvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = originalAppendFileName || "diary_updated.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    /* Diary View & Calendar */

    diaryViewReadButton.addEventListener("click", () => {
      const file = diaryViewFile.files[0];
      if (!file) {
        alert("æ—¥è¨˜QRç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      diaryViewStatus.textContent = "èª­ã¿å–ã‚Šä¸­â€¦";
      calendarYearCard.style.display = "none";
      readQrImageFile(file, (err, data) => {
        if (err) {
          diaryViewStatus.textContent = "ã‚¨ãƒ©ãƒ¼: " + err.message;
          return;
        }
        try {
          const parsedDiary = tryParseDiaryFromQrString(data);
          loadedDiaryStruct = parsedDiary;
          loadedDiaryEntries = parsedDiary.entries || [];
          loadedDiaryMeta = parsedDiary.goals || {
            targetAmount: null,
            targetTime: null,
            weekAmount: null,
            weekDays: null
          };
          if (!loadedDiaryEntries.length) {
            diaryViewStatus.textContent = "æ—¥è¨˜ã®è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
            return;
          }
          diaryViewStatus.textContent = "èª­ã¿å–ã‚ŠæˆåŠŸã€‚Graph ã‹å¹´ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
          calendarYearCard.style.display = "block";
          renderCalendarYearChoices();
        } catch (e) {
          diaryViewStatus.textContent = "QRã®ä¸­èº«ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
        }
      });
    });

    homeCalendarFile.addEventListener("change", () => {
      const file = homeCalendarFile.files[0];
      if (!file) return;
      hideAllScreensExcept(diaryViewScreen);
      diaryViewScreen.classList.remove("screen--hidden");
      diaryViewScreen.classList.add("screen--active");
      diaryViewFile.files = homeCalendarFile.files;
      diaryViewReadButton.click();
    });

    homeAppendFile.addEventListener("change", () => {
      const file = homeAppendFile.files[0];
      if (!file) return;
      hideAllScreensExcept(diaryAppendScreen);
      diaryAppendScreen.classList.remove("screen--hidden");
      diaryAppendScreen.classList.add("screen--active");
      diaryAppendFile.files = homeAppendFile.files;
      diaryAppendFile.dispatchEvent(new Event("change"));
    });

    function renderCalendarYearChoices() {
      calendarYearGrid.innerHTML = "";
      const years = new Set();
      loadedDiaryEntries.forEach(entry => {
        if (!entry.date) return;
        const d = new Date(entry.date);
        const y = d.getFullYear();
        if (!isNaN(y)) years.add(y);
      });
      const yearList = Array.from(years).sort((a,b) => a-b);
      yearList.forEach(y => {
        const card = document.createElement("div");
        card.className = "year-card";
        card.textContent = y;
        card.style.borderColor = "rgba(249,115,22,0.8)";
        card.style.color = "#fed7aa";
        card.addEventListener("click", () => openCalendarForYear(y));
        calendarYearGrid.appendChild(card);
      });
    }

    function openCalendarForYear(year) {
      calendarCurrentYear = year;
      calendarCurrentMonth = 0;
      hideAllScreensExcept(calendarMonthScreen);
      calendarMonthScreen.classList.remove("screen--hidden");
      calendarMonthScreen.classList.add("screen--active");
      calendarHeaderTitle.textContent = `DIARY â€“ ${year}`;
      calendarHeaderSubtitle.textContent = "çŸ¢å°ã§æœˆã‚’ç§»å‹•ã—ã¦ã€ãã®å¹´ã®é£²é…’ã®è¶³è·¡ã‚’çœºã‚ã¾ã™ã€‚";
      renderCalendarMonth();
    }

    function parseNumberOrNull(value) {
      if (!value) return null;
      const n = parseFloat(String(value).replace(/[^\d.\-]/g, ""));
      return isNaN(n) ? null : n;
    }

    function parseRating1to5OrNull(value) {
      const n = parseNumberOrNull(value);
      if (n == null) return null;
      if (n < 1 || n > 5) return null;
      return n;
    }

    function parseTime0to24OrNull(value) {
      if (!value) return null;
      const m = String(value).match(/(\d{1,2})[:ï¼š](\d{1,2})/);
      if (!m) {
        const n = parseNumberOrNull(value);
        if (n != null && n >= 0 && n <= 24) return n;
        return null;
      }
      const h = parseInt(m[1], 10);
      if (h < 0 || h > 24) return null;
      return h;
    }

    function getEntriesSortedByDateAsc() {
      const arr = (loadedDiaryEntries || []).slice();
      arr.sort((a, b) => {
        const da = new Date(a.date || "1970-01-01");
        const db = new Date(b.date || "1970-01-01");
        return da - db;
      });
      return arr;
    }

    function renderCalendarMonth() {
      if (calendarCurrentYear == null || calendarCurrentMonth == null) return;
      const year = calendarCurrentYear;
      const month = calendarCurrentMonth;
      calendarMonthTitle.textContent = `${year} / ${month+1}`;

      calendarWeeks.innerHTML = "";
      calendarDetailsTitle.textContent = "è¨˜éŒ²ã®ã‚ã‚‹æ—¥ã‚’é¸ã¶ã¨ã€ã“ã“ã«ä¸€è¦§ãŒå‡ºã¾ã™ã€‚";
      calendarDetailsBody.innerHTML = "";

      const firstDay = new Date(year, month, 1);
      const startWeekday = firstDay.getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      const entriesByDate = {};
      loadedDiaryEntries.forEach(entry => {
        if (!entry.date) return;
        const d = new Date(entry.date);
        if (d.getFullYear() === year && d.getMonth() === month) {
          const day = d.getDate();
          const key = `${year}-${month+1}-${day}`;
          if (!entriesByDate[key]) entriesByDate[key] = [];
          entriesByDate[key].push(entry);
        }
      });

      // é€±ã”ã¨ã®å®Ÿç¸¾ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é‡ãƒ»é£²ã‚“ã æ—¥æ•°ãƒ»ä½“èª¿å¹³å‡ã‚’è¨ˆç®—
      const weekStats = [];
      let weekIndex = 0;
      let currentDay = 1;
      let dayPointer = 0;

      // è¡Œã”ã¨ã®7æ—¥ã‚°ãƒªãƒƒãƒ‰ï¼‹é€±ã‚µãƒãƒªã‚’æç”»
      while (dayPointer < 42) {
        const weekRow = document.createElement("div");
        weekRow.className = "calendar-week-row";
        const weekSummary = document.createElement("div");
        weekSummary.className = "calendar-week-summary";
        const datesRow = document.createElement("div");
        datesRow.className = "calendar-dates";

        let weekTotalAlcohol = 0;
        let weekDrinkDays = 0;
        let weekNextdayRatings = [];

        for (let col = 0; col < 7; col++) {
          const cellIndex = dayPointer;
          const cell = document.createElement("div");
          cell.className = "calendar-day";
          if (cellIndex < startWeekday || currentDay > daysInMonth) {
            cell.classList.add("calendar-day--inactive");
            datesRow.appendChild(cell);
            dayPointer++;
            continue;
          }
          const day = currentDay;
          cell.textContent = day;
          const key = `${year}-${month+1}-${day}`;
          if (entriesByDate[key]) {
            cell.classList.add("calendar-day--has-entry");
            const entries = entriesByDate[key];

            // Dot & label
            const dot = document.createElement("div");
            dot.className = "calendar-dot";
            const colors = entries.map(e => e.dotColor || "#f97316");
            dot.style.background = colors[0];
            cell.appendChild(dot);
            const label = document.createElement("div");
            label.className = "calendar-day-wine-label";
            const firstBrand = (entries[0].name || entries[0].brand || "").trim();
            label.textContent = firstBrand || "";
            cell.appendChild(label);

            // ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«é‡(g)ãƒ»ä½“èª¿
            let dayAlcohol = 0;
            let hasDrink = false;
            entries.forEach(e => {
              const amount = parseNumberOrNull(e.amount) || 0;
              const abv = parseNumberOrNull(e.abv) || 0;
              const pure = amount * (abv/100) * 0.8;
              dayAlcohol += pure;
              if (amount > 0) hasDrink = true;
              const nd = parseRating1to5OrNull(e.nextday);
              if (nd != null) weekNextdayRatings.push(nd);
            });
            weekTotalAlcohol += dayAlcohol;
            if (hasDrink) weekDrinkDays++;

            cell.addEventListener("click", () => {
              showCalendarDetails(year, month, day, entries);
            });
          } else {
            cell.classList.add("calendar-day--inactive");
          }
          datesRow.appendChild(cell);
          currentDay++;
          dayPointer++;
        }

        // é€±ã«1ä»¶ã‚‚ã‚¨ãƒ³ãƒˆãƒªãŒãªã‘ã‚Œã°ã‚µãƒãƒªã¯ç©º
        let summaryLine1 = "â€“";
        let summaryLine2 = "";
        if (weekTotalAlcohol > 0 || weekDrinkDays > 0) {
          const weekAmountTarget = parseNumberOrNull(loadedDiaryMeta.weekAmount);
          if (weekAmountTarget != null && weekAmountTarget > 0) {
            const diff = weekAmountTarget - weekTotalAlcohol;
            if (diff >= 0) {
              summaryLine1 = `æ®‹ã‚Š ${diff.toFixed(0)} g`;
            } else {
              summaryLine1 = `${Math.abs(diff).toFixed(0)} g ã‚ªãƒ¼ãƒãƒ¼`;
            }
          } else {
            summaryLine1 = `${weekTotalAlcohol.toFixed(0)} g`;
          }
          const weekDaysTarget = parseNumberOrNull(loadedDiaryMeta.weekDays);
          if (weekDaysTarget != null && weekDaysTarget > 0) {
            const remainDays = weekDaysTarget - weekDrinkDays;
            if (remainDays >= 0) summaryLine2 = `ã‚ã¨ ${remainDays} æ—¥`;
            else summaryLine2 = `${Math.abs(remainDays)} æ—¥ã‚ªãƒ¼ãƒãƒ¼`;
          } else {
            summaryLine2 = `é£²ã‚“ã æ—¥: ${weekDrinkDays} æ—¥`;
          }
        }
        weekSummary.innerHTML = `<span>${summaryLine1}</span><span>${summaryLine2}</span>`;

        calendarWeeks.appendChild(weekRow);
        weekRow.appendChild(weekSummary);
        weekRow.appendChild(datesRow);

        weekStats.push({
          weekIndex,
          totalAlcohol: weekTotalAlcohol,
          drinkDays: weekDrinkDays,
          avgNextday: weekNextdayRatings.length ? weekNextdayRatings.reduce((s,v)=>s+v,0)/weekNextdayRatings.length : null
        });

        weekIndex++;
        if (currentDay > daysInMonth && dayPointer >= startWeekday+daysInMonth) break;
      }

      // æœ€æ–°é€±ã®ä½“èª¿å¹³å‡ï¼†å‰é€±ã¨ã®å·®ï¼†æ®‹ã‚Šé£²ã‚ã‚‹æ—¥æ•°
      const statsWithData = weekStats.filter(w => w.avgNextday != null);
      if (statsWithData.length > 0) {
        const last = statsWithData[statsWithData.length-1];
        const prev = statsWithData.length > 1 ? statsWithData[statsWithData.length-2] : null;
        const avgNow = last.avgNextday.toFixed(1);
        let diffText = "å‰é€±ãªã—";
        if (prev && prev.avgNextday != null) {
          const diff = (avgNow - prev.avgNextday).toFixed(1);
          const sign = diff >= 0 ? "+" : "";
          diffText = `å‰é€± ${sign}${diff}`;
        }
        const weekDaysTarget = parseNumberOrNull(loadedDiaryMeta.weekDays);
        let remainDaysMark = "";
        if (weekDaysTarget != null && weekDaysTarget > 0) {
          const remain = weekDaysTarget - last.drinkDays;
          if (remain >= 0) remainDaysMark = `â— ã‚ã¨ ${remain} æ—¥`;
          else remainDaysMark = `â–² ${Math.abs(remain)} æ—¥ã‚ªãƒ¼ãƒãƒ¼`;
        }

        const extraSpan = document.createElement("div");
        extraSpan.className = "calendar-month-extra";
        extraSpan.innerHTML =
          `<span class="calendar-tag">ä»Šé€±ã®å¹³å‡ä½“èª¿: ${avgNow}${prev ? ` (${diffText})` : ""}</span>` +
          (remainDaysMark ? `<span class="calendar-tag">${remainDaysMark}</span>` : "");

        const titleEl = calendarMonthTitle;
        titleEl.innerHTML = `${year} / ${month+1}`;
        titleEl.appendChild(extraSpan);
      }
    }

    function showCalendarDetails(year, month, day, entries) {
      calendarDetailsTitle.textContent = `${year}/${month+1}/${day} ã®è¨˜éŒ²`;
      calendarDetailsBody.innerHTML = "";
      entries.forEach(entry => {
        const card = document.createElement("div");
        card.className = "calendar-entry-card";

        const nameTitle = document.createElement("div");
        nameTitle.className = "calendar-entry-name";
        nameTitle.textContent = entry.name || entry.brand || "(è¨˜éŒ²)";
        card.appendChild(nameTitle);

        const rows = [
          ["ãŠé…’ã®åå‰", entry.name],
          ["éŠ˜æŸ„ / ãƒ–ãƒ©ãƒ³ãƒ‰", entry.brand],
          ["é‡", entry.amount],
          ["ABV%", entry.abv],
          ["å‘³ã®è©•ä¾¡", entry.taste],
          ["é¦™ã‚Š", entry.aroma],
          ["è‰²ãƒ»è¦‹ãŸç›®", entry.colorNote],
          ["ç·åˆã‚³ãƒ¡ãƒ³ãƒˆ", entry.comment],
          ["æ™‚é–“å¸¯", entry.timezone],
          ["æ°—åˆ†", entry.mood],
          ["ãƒšã‚¢ãƒªãƒ³ã‚°", entry.food],
          ["å ´æ‰€", entry.place],
          ["é…”ã„ã®ç¨‹åº¦", entry.drunken],
          ["ç¿Œæ—¥ã®ä½“èª¿", entry.nextday],
          ["ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è‰²", entry.dotColor]
        ];

        rows.forEach(([label, value]) => {
          if (!value) return;
          const row = document.createElement("div");
          row.className = "calendar-entry-row";
          const l = document.createElement("div");
          l.className = "calendar-entry-label";
          l.textContent = label + "ï¼š";
          const v = document.createElement("div");
          v.className = "calendar-entry-value";
          if (["å‘³ã®è©•ä¾¡","é¦™ã‚Š","è‰²ãƒ»è¦‹ãŸç›®","æ°—åˆ†","é…”ã„ã®ç¨‹åº¦","ç¿Œæ—¥ã®ä½“èª¿"].includes(label)) {
            const rating = parseRating1to5OrNull(value);
            if (rating != null) {
              const full = "â˜…â˜…â˜…â˜…â˜…";
              const empty = "â˜†â˜†â˜†â˜†â˜†";
              const stars = full.slice(0,rating) + empty.slice(rating);
              v.textContent = `${stars} (${rating})`;
            } else {
              v.textContent = value;
            }
          } else {
            v.textContent = value;
          }
          row.appendChild(l);
          row.appendChild(v);
          card.appendChild(row);
        });

        calendarDetailsBody.appendChild(card);
      });
    }

    calendarPrevMonthButton.addEventListener("click", () => {
      if (calendarCurrentMonth == null) return;
      calendarCurrentMonth--;
      if (calendarCurrentMonth < 0) {
        calendarCurrentMonth = 11;
        calendarCurrentYear--;
      }
      renderCalendarMonth();
    });

    calendarNextMonthButton.addEventListener("click", () => {
      if (calendarCurrentMonth == null) return;
      calendarCurrentMonth++;
      if (calendarCurrentMonth > 11) {
        calendarCurrentMonth = 0;
        calendarCurrentYear++;
      }
      renderCalendarMonth();
    });

    /* Graph */

    function applyRange(entries) {
      if (graphRange === "all") return entries;
      const limit = graphRange === "7" ? 7 : 30;
      if (entries.length <= limit) return entries;
      return entries.slice(entries.length - limit);
    }

    function getMetricLabel(metric) {
      switch (metric) {
        case "amount": return "é‡ï¼ˆmlãªã©ï¼‰";
        case "time": return "æ™‚é–“å¸¯ï¼ˆ0ï½24æ™‚ï¼‰";
        case "mood": return "æ°—åˆ†ï¼ˆ1ï½5ï¼‰";
        case "drunken": return "é…”ã„ï¼ˆ1ï½5ï¼‰";
        case "nextday": return "ä½“èª¿ï¼ˆ1ï½5ï¼‰";
        case "amount+nextday": return "é‡ï¼‹ä½“èª¿";
        default: return "";
      }
    }

    function extractMetricValue(entry, metric) {
      switch (metric) {
        case "amount":
        case "amount+nextday":
          return parseNumberOrNull(entry.amount);
        case "time":
          return parseTime0to24OrNull(entry.timezone);
        case "mood":
          return parseRating1to5OrNull(entry.mood);
        case "drunken":
          return parseRating1to5OrNull(entry.drunken);
        case "nextday":
          return parseRating1to5OrNull(entry.nextday);
      }
      return null;
    }

    function parseTargetAmount() {
      if (!loadedDiaryMeta || !loadedDiaryMeta.targetAmount) return null;
      return parseNumberOrNull(loadedDiaryMeta.targetAmount);
    }

    function parseTargetTime() {
      if (!loadedDiaryMeta || !loadedDiaryMeta.targetTime) return null;
      return parseTime0to24OrNull(loadedDiaryMeta.targetTime);
    }

    function varLineAmount() { return getComputedStyle(document.documentElement).getPropertyValue("--line-amount") || "#f97316"; }
    function varLineCondition() { return getComputedStyle(document.documentElement).getPropertyValue("--line-condition") || "#22c55e"; }
    function varLineTarget() { return getComputedStyle(document.documentElement).getPropertyValue("--line-target") || "#ec4899"; }

    function drawGraph() {
      graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
      const allAsc = getEntriesSortedByDateAsc();
      const entries = applyRange(allAsc);
      const mainMetric = graphMetric === "amount+nextday" ? "amount" : graphMetric;
      const points = [];
      entries.forEach((e, idx) => {
        const val = extractMetricValue(e, mainMetric);
        if (val != null) {
          points.push({ entry: e, index: idx, value: val });
        }
      });
      let secPoints = [];
      let targetValue = null;
      let targetLabel = "";
      if (graphMetric === "amount+nextday") {
        secPoints = [];
        entries.forEach((e, idx) => {
          const val = extractMetricValue(e, "nextday");
          if (val != null) secPoints.push({ entry: e, index: idx, value: val });
        });
        targetValue = parseTargetAmount();
        targetLabel = "ç›®æ¨™ä¸€æ—¥é£²é…’é‡";
      } else if (graphMetric === "amount") {
        targetValue = parseTargetAmount();
        targetLabel = "ç›®æ¨™ä¸€æ—¥é£²é…’é‡";
      } else if (graphMetric === "time") {
        targetValue = parseTargetTime();
        targetLabel = "ç›®æ¨™æ™‚é–“å¸¯";
      } else {
        targetValue = null;
        targetLabel = "";
      }
      graphLegendTargetLabel.textContent = targetLabel || "ç›®æ¨™";

      if (!points.length) {
        graphCtx.fillStyle = "#9ca3af";
        graphCtx.font = "12px system-ui";
        graphCtx.fillText("ã“ã®æŒ‡æ¨™ã§æ•°å€¤ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", 20, graphCanvas.height / 2);
        graphList.innerHTML = "";
        return;
      }

      let minY, maxY;
      if (graphMetric === "time") {
        minY = 0; maxY = 24;
      } else if (["mood","drunken","nextday"].includes(graphMetric) || graphMetric === "amount+nextday") {
        minY = 1; maxY = 5;
      } else {
        const vs = points.map(p => p.value);
        minY = 0;
        maxY = Math.max(...vs) || 1;
      }

      const paddingLeft = 40;
      const paddingRight = 10;
      const paddingTop = 20;
      const paddingBottom = 40;
      const w = graphCanvas.width - paddingLeft - paddingRight;
      const h = graphCanvas.height - paddingTop - paddingBottom;

      const stepX = points.length > 1 ? w / (points.length - 1) : 0;

      function mapX(i) {
        return paddingLeft + stepX * i;
      }

      function mapY(v) {
        if (maxY === minY) return paddingTop + h / 2;
        const t = (v - minY) / (maxY - minY);
        return paddingTop + h * (1 - t);
      }

      graphCtx.strokeStyle = "rgba(75,85,99,0.9)";
      graphCtx.lineWidth = 1;
      graphCtx.beginPath();
      graphCtx.moveTo(paddingLeft, paddingTop);
      graphCtx.lineTo(paddingLeft, paddingTop + h);
      graphCtx.lineTo(paddingLeft + w, paddingTop + h);
      graphCtx.stroke();

      // ãƒ¡ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆé‡ãƒ»æ™‚é–“ãªã©ï¼‰
      graphCtx.strokeStyle = varLineAmount();
      graphCtx.lineWidth = 2;
      graphCtx.beginPath();
      points.forEach((p, idx) => {
        const x = mapX(idx);
        const y = mapY(p.value);
        if (idx === 0) graphCtx.moveTo(x, y);
        else graphCtx.lineTo(x, y);
      });
      graphCtx.stroke();

      graphCtx.fillStyle = "#fed7aa";
      points.forEach((p, idx) => {
        const x = mapX(idx);
        const y = mapY(p.value);
        graphCtx.beginPath();
        graphCtx.arc(x, y, 3, 0, Math.PI * 2);
        graphCtx.fill();
      });

      if (graphMetric === "amount+nextday" && secPoints.length) {
        graphCtx.strokeStyle = varLineCondition();
        graphCtx.lineWidth = 2;
        graphCtx.beginPath();
        secPoints.forEach((p, idx) => {
          const x = mapX(idx);
          const y = mapY(p.value);
          if (idx === 0) graphCtx.moveTo(x, y);
          else graphCtx.lineTo(x, y);
        });
        graphCtx.stroke();
        graphCtx.fillStyle = "#bbf7d0";
        secPoints.forEach((p, idx) => {
          const x = mapX(idx);
          const y = mapY(p.value);
          graphCtx.beginPath();
          graphCtx.arc(x, y, 3, 0, Math.PI * 2);
          graphCtx.fill();
        });
      }

      if (targetValue != null) {
        graphCtx.strokeStyle = varLineTarget();
        graphCtx.setLineDash([4,4]);
        graphCtx.lineWidth = 1.5;
        graphCtx.beginPath();
        const y = mapY(targetValue);
        graphCtx.moveTo(paddingLeft, y);
        graphCtx.lineTo(paddingLeft + w, y);
        graphCtx.stroke();
        graphCtx.setLineDash([]);
      }

      graphCtx.fillStyle = "#9ca3af";
      graphCtx.font = "10px system-ui";
      graphCtx.textAlign = "right";
      graphCtx.textBaseline = "middle";
      const ticks = 4;
      for (let i = 0; i <= ticks; i++) {
        const t = i / ticks;
        const v = minY + (maxY - minY) * (1 - t);
        const y = paddingTop + h * t;
        graphCtx.fillText(v.toFixed(1), paddingLeft - 6, y);
      }

      graphCtx.textAlign = "center";
      graphCtx.textBaseline = "top";
      points.forEach((p, idx) => {
        const x = mapX(idx);
        const d = new Date(p.entry.date || "1970-01-01");
        const dateLabel = `${d.getMonth()+1}/${d.getDate()}`;
        const brandLabel = (p.entry.name || p.entry.brand || "").trim();
        const label = brandLabel ? `${dateLabel}\n${brandLabel}` : dateLabel;
        graphCtx.fillText(label, x, paddingTop + h + 4);
      });

      graphList.innerHTML = "";
      points.forEach(p => {
        const d = new Date(p.entry.date || "1970-01-01");
        const row = document.createElement("div");
        row.className = "graph-list-item";
        const left = document.createElement("div");
        left.className = "graph-list-date";
        const brand = (p.entry.name || p.entry.brand || "").trim();
        left.textContent = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${brand ? ` â€“ ${brand}` : ""}`;
        const right = document.createElement("div");
        right.className = "graph-list-value";
        right.textContent = `${p.value} (${getMetricLabel(graphMetric)})`;
        row.appendChild(left);
        row.appendChild(right);
        graphList.appendChild(row);
      });
    }

    function ratingFromText(text) {
      if (!text) return null;
      const n = parseFloat(String(text).replace(/[^\d.\-]/g,""));
      if (isNaN(n)) return null;
      if (n < 1 || n > 5) return null;
      return n;
    }

    function buildWineRankingAndDetail() {
      const map = new Map();
      (loadedDiaryEntries || []).forEach(e => {
        const key = (e.name || e.brand || "").trim();
        if (!key) return;
        if (!map.has(key)) {
          map.set(key, {
            name: key,
            count: 0,
            taste: [],
            aroma: [],
            colorNote: [],
            food: [],
            abv: [],
            tasteRatings: [],
            aromaRatings: [],
            colorRatings: []
          });
        }
        const w = map.get(key);
        w.count++;
        if (e.taste) {
          w.taste.push(e.taste);
          const r = ratingFromText(e.taste);
          if (r != null) w.tasteRatings.push(r);
        }
        if (e.aroma) {
          w.aroma.push(e.aroma);
          const r = ratingFromText(e.aroma);
          if (r != null) w.aromaRatings.push(r);
        }
        if (e.colorNote) {
          w.colorNote.push(e.colorNote);
          const r = ratingFromText(e.colorNote);
          if (r != null) w.colorRatings.push(r);
        }
        if (e.food) w.food.push(e.food);
        if (e.abv) w.abv.push(e.abv);
      });

      const list = Array.from(map.values());
      const byCount = list.slice().sort((a, b) => b.count - a.count);
      const avg = arr => arr.length ? arr.reduce((s,v)=>s+v,0)/arr.length : null;
      const byTaste = list.slice().filter(w => w.tasteRatings.length > 0);
      byTaste.forEach(w => { w.avgTaste = avg(w.tasteRatings); });
      byTaste.sort((a,b) => (b.avgTaste||0) - (a.avgTaste||0));

      wineRankingList.innerHTML = "";
      const section1Title = document.createElement("div");
      section1Title.textContent = "å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP5";
      section1Title.style.marginBottom = "4px";
      section1Title.style.color = "#e5e7eb";
      section1Title.style.fontSize = "11px";
      wineRankingList.appendChild(section1Title);

      byCount.slice(0,5).forEach((w, i) => {
        const row = document.createElement("div");
        row.className = "wine-ranking-row";
        const left = document.createElement("div");
        left.className = "wine-ranking-name";
        left.textContent = `${i+1}. ${w.name}`;
        const right = document.createElement("div");
        right.className = "wine-ranking-count";
        right.textContent = `${w.count} å›`;
        row.appendChild(left);
        row.appendChild(right);
        wineRankingList.appendChild(row);
      });

      const divider = document.createElement("div");
      divider.style.margin = "6px 0 4px";
      divider.style.borderTop = "1px solid rgba(55,65,81,0.8)";
      wineRankingList.appendChild(divider);

      const section2Title = document.createElement("div");
      section2Title.textContent = "å‘³è©•ä¾¡ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP5";
      section2Title.style.marginBottom = "4px";
      section2Title.style.color = "#e5e7eb";
      section2Title.style.fontSize = "11px";
      wineRankingList.appendChild(section2Title);

      byTaste.slice(0,5).forEach((w, i) => {
        const row = document.createElement("div");
        row.className = "wine-ranking-row";
        const left = document.createElement("div");
        left.className = "wine-ranking-name";
        left.textContent = `${i+1}. ${w.name}`;
        const right = document.createElement("div");
        right.className = "wine-ranking-count";
        right.textContent = `${w.avgTaste.toFixed(1)} / 5`;
        row.appendChild(left);
        row.appendChild(right);
        wineRankingList.appendChild(row);
      });

      wineDetailList.innerHTML = "";
      wineRadarWrap.innerHTML = "";

      wineDetailButton.onclick = () => {
        wineDetailList.innerHTML = "";
        list.forEach(w => {
          const item = document.createElement("div");
          item.className = "wine-detail-item";
          const title = document.createElement("div");
          title.className = "wine-detail-title";
          title.textContent = w.name + `ï¼ˆ${w.count}å›ï¼‰`;
          const body = document.createElement("div");
          body.className = "wine-detail-body";
          body.textContent =
            `å‘³ã®è©•ä¾¡: ${w.taste.join(" / ") || "-"}\n` +
            `é¦™ã‚Š: ${w.aroma.join(" / ") || "-"}\n` +
            `è‰²ãƒ»è¦‹ãŸç›®: ${w.colorNote.join(" / ") || "-"}\n` +
            `ãƒšã‚¢ãƒªãƒ³ã‚°: ${w.food.join(" / ") || "-"}\n` +
            `åº¦æ•°: ${w.abv.join(" / ") || "-"}`;
          item.appendChild(title);
          item.appendChild(body);
          wineDetailList.appendChild(item);
        });
      };

      list.forEach(w => {
        const rT = avg(w.tasteRatings) || 0;
        const rA = avg(w.aromaRatings) || 0;
        const rC = avg(w.colorRatings) || 0;
        if (!rT && !rA && !rC) return;

        const item = document.createElement("div");
        item.className = "wine-radar-item";
        const title = document.createElement("div");
        title.className = "wine-radar-name";
        title.textContent = w.name;
        const canvas = document.createElement("canvas");
        canvas.width = 120;
        canvas.height = 90;
        canvas.className = "wine-radar-canvas";
        const labelRow = document.createElement("div");
        labelRow.className = "wine-radar-labels";
        labelRow.innerHTML = "<span>å‘³</span><span>é¦™ã‚Š</span><span>è¦‹ãŸç›®</span>";
        item.appendChild(title);
        item.appendChild(canvas);
        item.appendChild(labelRow);
        wineRadarWrap.appendChild(item);

        const ctx = canvas.getContext("2d");
        const cx = canvas.width/2;
        const cy = canvas.height/2 + 4;
        const rMax = 32;

        const axes = [
          {angle: -Math.PI/2, value: rT},
          {angle: (2*Math.PI/3)-Math.PI/2, value: rA},
          {angle: (4*Math.PI/3)-Math.PI/2, value: rC}
        ];

        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.strokeStyle = "rgba(55,65,81,0.8)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        axes.forEach((a,idx) => {
          const x = cx + rMax * Math.cos(a.angle);
          const y = cy + rMax * Math.sin(a.angle);
          if (idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.closePath();
        ctx.stroke();

        ctx.fillStyle = "rgba(249,115,22,0.08)";
        ctx.beginPath();
        axes.forEach((a,idx) => {
          const rr = (a.value/5) * rMax;
          const x = cx + rr * Math.cos(a.angle);
          const y = cy + rr * Math.sin(a.angle);
          if (idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.closePath();
        ctx.fill();

        ctx.strokeStyle = "#f97316";
        ctx.lineWidth = 1.6;
        ctx.beginPath();
        axes.forEach((a,idx) => {
          const rr = (a.value/5) * rMax;
          const x = cx + rr * Math.cos(a.angle);
          const y = cy + rr * Math.sin(a.angle);
          if (idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.closePath();
        ctx.stroke();
      });
    }

    graphOpenButton.addEventListener("click", () => {
      if (!loadedDiaryEntries || !loadedDiaryEntries.length) {
        alert("å…ˆã«æ—¥è¨˜QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }
      hideAllScreensExcept(graphScreen);
      graphScreen.classList.remove("screen--hidden");
      graphScreen.classList.add("screen--active");
      drawGraph();
      buildWineRankingAndDetail();
    });

    function backToView() {
      hideAllScreensExcept(diaryViewScreen);
      diaryViewScreen.classList.remove("screen--hidden");
      diaryViewScreen.classList.add("screen--active");
    }

    graphBackButton.addEventListener("click", backToView);
    graphBackButtonTop.addEventListener("click", backToView);

    graphRangeGroup.addEventListener("click", e => {
      const btn = e.target.closest(".graph-chip");
      if (!btn) return;
      graphRange = btn.getAttribute("data-range");
      Array.from(graphRangeGroup.querySelectorAll(".graph-chip")).forEach(b => {
        b.classList.toggle("graph-chip--active", b === btn);
      });
      drawGraph();
    });

    graphMetricGroup.addEventListener("click", e => {
      const btn = e.target.closest(".graph-chip");
      if (!btn) return;
      graphMetric = btn.getAttribute("data-metric");
      Array.from(graphMetricGroup.querySelectorAll(".graph-chip")).forEach(b => {
        b.classList.toggle("graph-chip--active", b === btn);
      });
      drawGraph();
    });

    /* init */

    function initMain() {
      renderHomeBottles();
      renderOverlayBottles();
      updateNightEffects();
      setupBgm();
      openWineFromQueryIfNeeded();
      setupStarRatings();
      setupNumericPickers();
    }

    document.addEventListener("DOMContentLoaded", initMain);
  </script>
</body>
</html>
