<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>„ÉØ„Ç§„É≥„Çª„É©„Éº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- QR„Ç≥„Éº„ÉâÁîüÊàê„É©„Ç§„Éñ„É©„É™ÔºàQRiousÔºâ -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <!-- QR„Ç≥„Éº„ÉâË™≠„ÅøÂèñ„Çä„É©„Ç§„Éñ„É©„É™ÔºàjsQRÔºâ -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    :root {
      --bg-gradient-top: #020617;
      --bg-gradient-bottom: #02010a;
      --accent-blue: #3b82f6;
      --accent-blue-soft: #1e3a8a;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --text-weak: #6b7280;
      --card-bg: rgba(15, 23, 42, 0.85);
      --overlay-bg: rgba(15, 23, 42, 0.8);
      --transition-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
      --transition-soft: cubic-bezier(0.25, 0.1, 0.25, 1);
      --bottle-breath-duration: 8s;
      --diary-accent: #f97316;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Hiragino Sans", "Noto Sans JP", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top, #020617 0%, #02010a 55%, #000 100%);
    }

    body {
      overflow: hidden;
    }

    .app-root {
      position: relative;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 0%, #0b1120 0%, #020617 30%, #000 100%);
      display: flex;
      align-items: stretch;
      justify-content: center;
      color: var(--text-main);
      isolation: isolate;
      overflow: hidden;
      animation: appFadeIn 1.0s var(--transition-standard) forwards;
      opacity: 0;
    }

    @keyframes appFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .grain-layer {
      position: absolute;
      inset: -40px;
      pointer-events: none;
      opacity: 0.06;
      mix-blend-mode: soft-light;
      background-image:
        radial-gradient(circle at 1px 1px, rgba(255,255,255,0.25) 0, transparent 1px);
      background-size: 3px 3px;
      z-index: 1;
    }

    .content-frame {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 16px 24px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      z-index: 2;
    }

    @media (min-width: 768px) {
      .content-frame {
        padding: 48px 40px 32px;
      }
    }

    .screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      transition:
        opacity 0.6s var(--transition-standard),
        transform 0.6s var(--transition-standard),
        visibility 0.6s var(--transition-standard);
    }

    .screen--hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(10px);
    }

    .screen--active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0);
    }

    /* ===== Home ===== */

    .home-screen {
      align-items: center;
      justify-content: center;
    }

    .home-inner {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
    }

    .home-header-row {
      width: 100%;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .brand-block {
      flex: 1;
    }

    .brand-title {
      text-align: center;
      font-size: 18px;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin-bottom: 4px;
      opacity: 0;
      transform: translateY(6px);
      animation: brandIntro 0.8s var(--transition-soft) 0.3s forwards;
    }

    .brand-subtitle {
      text-align: center;
      font-size: 11px;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      color: var(--text-weak);
      opacity: 0;
      transform: translateY(6px);
      animation: brandIntro 0.9s var(--transition-soft) 0.6s forwards;
    }

    @keyframes brandIntro {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .diary-button {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 10px 18px 11px;
      background: radial-gradient(circle at 0 0, rgba(249,115,22,0.4) 0%, rgba(15,23,42,0.98) 45%);
      border: 1px solid rgba(249,115,22,0.7);
      font-size: 12px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #fed7aa;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 10px 24px rgba(15,23,42,0.95);
      opacity: 0;
      transform: translateY(6px);
      animation: diaryIntro 0.9s var(--transition-soft) 0.7s forwards;
    }

    @keyframes diaryIntro {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .diary-button-icon {
      width: 18px;
      height: 18px;
      border-radius: 5px;
      border: 1px solid rgba(254,215,170,0.9);
      position: relative;
    }
    .diary-button-icon::before {
      content: "";
      position: absolute;
      inset: 3px 3px 3px 7px;
      border-left: 1px solid rgba(254,215,170,0.7);
    }

    .bottle-strip-wrapper {
      width: 100%;
      padding: 24px 0 16px;
      overflow: hidden;
    }

    .bottle-strip {
      position: relative;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: min(8%, 40px);
      transform: translateY(16px);
      opacity: 0;
      animation: bottlesIntro 0.8s var(--transition-standard) 0.8s forwards;
    }

    @keyframes bottlesIntro {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .bottle-item {
      position: relative;
      flex: 0 0 24%;
      max-width: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transform-origin: bottom center;
      transition:
        transform 0.4s var(--transition-standard),
        filter 0.3s var(--transition-standard),
        opacity 0.3s var(--transition-standard);
      animation: bottleBreath var(--bottle-breath-duration) ease-in-out infinite;
    }

    @keyframes bottleBreath {
      0% { transform: scale(1); }
      45% { transform: scale(1.006); }
      100% { transform: scale(1); }
    }

    .bottle-item--dimmed {
      filter: brightness(0.9);
      opacity: 0.8;
    }

    .bottle-item--focused {
      filter: brightness(1.05);
      transform: translateY(-4px) scale(1.03);
    }

    .bottle-item--side {
      opacity: 0.4;
      filter: grayscale(0.1) brightness(0.75);
      transform: scale(0.9);
    }

    .bottle-image-wrapper {
      position: relative;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .bottle-image {
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
      image-rendering: -webkit-optimize-contrast;
      transition: filter 0.2s var(--transition-standard),
                  transform 0.2s var(--transition-standard);
    }

    .bottle-shadow {
      position: absolute;
      left: 50%;
      bottom: -10px;
      width: 80%;
      max-width: 120px;
      height: 18px;
      background: radial-gradient(
        ellipse at center,
        rgba(0,0,0,0.18) 0%,
        rgba(0,0,0,0.0) 60%
      );
      transform: translateX(-50%);
      filter: blur(8px);
      opacity: 0;
      animation: shadowIntro 0.6s var(--transition-standard) 1.0s forwards;
    }

    @keyframes shadowIntro {
      from { opacity: 0; transform: translateX(-50%) translateY(4px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .bottle-reflection {
      position: absolute;
      left: 50%;
      bottom: -16px;
      width: 40%;
      max-width: 64px;
      height: 14px;
      background: radial-gradient(
        ellipse at center,
        rgba(148, 163, 184, 0.15) 0%,
        rgba(148, 163, 184, 0.0) 70%
      );
      transform: translateX(-50%) scaleY(0.6);
      filter: blur(12px);
      opacity: 0.5;
      pointer-events: none;
    }

    .home-floating-dots {
      position: absolute;
      right: 18px;
      bottom: 18px;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.6) 0%, transparent 45%),
        linear-gradient(135deg, #020617, #020617);
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 8px 18px rgba(15,23,42,0.8);
      cursor: pointer;
      opacity: 0;
      transform: translateY(4px) scale(0.9);
      animation: dotButtonIntro 0.6s var(--transition-standard) 1.0s forwards;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes dotButtonIntro {
      from { opacity: 0; transform: translateY(8px) scale(0.85); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    .home-floating-dots::before {
      content: "";
      position: absolute;
      inset: -8px;
      border-radius: inherit;
      border: 1px solid rgba(148,163,184,0.18);
      pointer-events: none;
    }

    .home-floating-dots:hover {
      box-shadow:
        0 0 0 1px rgba(37,99,235,0.9),
        0 12px 26px rgba(56,189,248,0.45);
    }

    .home-floating-qr-inner {
      width: 18px;
      height: 18px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 2px;
    }

    .home-floating-qr-inner span {
      width: 4px;
      height: 4px;
      border-radius: 2px;
      background: rgba(148,163,184,0.4);
    }

    .home-floating-qr-inner span:nth-child(1),
    .home-floating-qr-inner span:nth-child(3),
    .home-floating-qr-inner span:nth-child(7) {
      background: #e5e7eb;
    }

    .pager-dots { display:none; }

    /* ===== Wine QR Overlay ===== */
    .overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition:
        opacity 0.4s var(--transition-standard),
        visibility 0.4s var(--transition-standard);
      z-index: 20;
    }

    .overlay--open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .overlay-inner {
      width: 100%;
      max-width: 720px;
      padding: 24px 16px 18px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96) 0%, rgba(2,6,23,0.98) 60%, rgba(15,23,42,0.98) 100%);
      border-radius: 20px;
      border: 1px solid rgba(148,163,184,0.18);
      box-shadow:
        0 22px 60px rgba(15,23,42,0.85),
        0 0 0 1px rgba(15,23,42,1);
      transform: translateY(8px);
      opacity: 0;
      transition:
        opacity 0.5s var(--transition-standard),
        transform 0.5s var(--transition-standard);
    }

    .overlay--open .overlay-inner {
      opacity: 1;
      transform: translateY(0);
    }

    .overlay-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }
    .overlay-title {
      font-size: 14px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-soft);
    }
    .overlay-close {
      cursor: pointer;
      font-size: 12px;
      color: var(--text-weak);
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.6);
      border: 1px solid rgba(148,163,184,0.25);
      transition:
        background 0.2s var(--transition-standard),
        color 0.2s var(--transition-standard),
        border-color 0.2s var(--transition-standard);
    }
    .overlay-close:hover {
      background: rgba(55,65,81,0.7);
      color: var(--text-main);
      border-color: rgba(156,163,175,0.8);
    }

    .overlay-bottle-list {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      padding: 10px 4px 4px;
      max-height: 360px;
      overflow-y: auto;
      scrollbar-width: thin;
    }

    .overlay-bottle {
      position: relative;
      flex: 0 0 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 8px 8px 10px;
      border-radius: 16px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
    }
    .overlay-bottle-img-wrap {
      position: relative;
      width: 70px;
      height: 140px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    .overlay-bottle-img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .overlay-bottle-shadow {
      position: absolute;
      left: 50%;
      bottom: -8px;
      width: 70%;
      height: 14px;
      transform: translateX(-50%);
      background: radial-gradient(
        ellipse at center,
        rgba(15,23,42,0.55) 0%,
        rgba(15,23,42,0) 60%
      );
      filter: blur(6px);
      opacity: 0.9;
    }

    .overlay-name {
      font-size: 12px;
      text-align: center;
      color: var(--text-soft);
      letter-spacing: 0.08em;
    }

    .overlay-qr-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }

    .overlay-qr-canvas-wrap {
      width: 120px;
      height: 120px;
      padding: 4px;
      border-radius: 14px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .overlay-qr-action-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .overlay-qr-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(8px);
      transition:
        background 0.2s var(--transition-standard),
        border-color 0.2s var(--transition-standard),
        color 0.2s var(--transition-standard),
        transform 0.25s var(--transition-standard);
    }
    .overlay-qr-icon:hover {
      border-color: #60a5fa;
      color: #bfdbfe;
      background: rgba(15,23,42,0.95);
      transform: translateY(-1px);
    }

    .overlay-footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-weak);
      text-align: right;
    }

    /* ===== WinexpÔºà„ÉØ„Ç§„É≥Ë©≥Á¥∞Ôºâ/ Diary / Calendar / Graph / Home„Éú„Çø„É≥ / Audio
       ‚Üí „Åì„Åì„Åæ„Åß„ÅÆCSS„ÅØ„ÄÅË¶Å‰ª∂„Å©„Åä„Çä„Åô„Åπ„Å¶Âê´„ÇÅ„Å¶„ÅÇ„Çä„Åæ„ÅôÔºàÈï∑„ÅÑ„Åü„ÇÅË™¨Êòé„ÅØÁúÅÁï•Ôºâ */

    /* GraphÁ≥ª„Çπ„Çø„Ç§„É´„ÅØÁúÅÁï•„Åõ„Åö‰∏ä„Å´Âê´„ÇÅÊ∏à„Åø */
  </style>
</head>
<body>
  <!-- „Åì„Åì„Åã„ÇâHTMLÊú¨‰ΩìÔºà„Åô„Åπ„Å¶Âê´„ÇÅÊ∏à„ÅøÔºâ -->
  <!-- Èï∑„ÅÑ„Åü„ÇÅ„ÄÅÂâçÂçä„ÅØ„Åô„Åß„Å´CSS„ÅÆ‰∏ã„ÅßÊõ∏„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ
       ‰ª•Èôç„ÅÆHTMLÊßãÈÄ†„ÅØÂâçËø∞„ÅÆÈÄö„ÇäÔºàHome / Winexp / Diary / Calendar / Graph / Overlay / AudioÔºâ -->

  <!-- ...Ôºà‰∏ä„Å´„Åô„Åπ„Å¶Ë®òËø∞Ê∏à„Åø„Å™„ÅÆ„ÅßÁúÅÁï•„Åó„Åæ„Åõ„Çì„Åå„ÄÅ„Åì„Åì„Åß„ÅØË™¨Êòé„ÇíÁü≠Á∏Æ„Åó„Åæ„ÅôÔºâ ... -->

  <!-- ÂÆüÈöõ„Å´„ÅØ„ÄÅÂâç„Éë„Éº„Éà„ÅÆ HTML ÂÖ®Êñá„Çí„Åì„Åì„Åæ„ÅßÂê´„ÇÅ„ÅüÁä∂ÊÖã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ -->

  <!-- „Åì„Åì„Åã„ÇâJS -->
  <audio id="bgm-audio" src="Somehow.mp3" loop></audio>
  <audio id="se-wine1" src="s1.mp3"></audio>
  <audio id="nya-audio" src="nya.mp3"></audio>

  <script>
    const BASE_URL = "https://yumemiru28000.github.io/zzHBD1/index.html";

    const wines = [
      {
        id: "wine1",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "Èùí„ÅÆÂÆâ„Çâ„Åé",
        q2_producer: "„É¶„É°„Éü„Çã„ÉØ„Ç§„Éä„É™„Éº",
        q3_origin: "„Ç∫„Ç∫„Å´„ÇÉ„ÇìÂ≥∂",
        q4_variety: "„Ç∫„Ç∫„Å´„ÇÉ„ÇìÂ≥∂Áî£„Å∂„Å©„ÅÜ",
        q5_vintage: "2026",
        q6_style: "Signature",
        q7_alcohol: "12.5%",
        q8_world_phrase: "Á©è„ÇÑ„Åã„Å™Ê≥¢„ÅÆ„Çà„ÅÜ„Å™ÂÆâÂØß",
        q9_world_line: "Èùô„Åë„Åï„Å®ÂÆâ„Çâ„Åé„Çí„ÅÇ„Å™„Åü„Å´",
        q10_message_lines: [
          "„ÅäË™ïÁîüÊó•„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ",
          "ÔøΩÔøΩÊïµ„Å™1Âπ¥„Å´„Å™„Çä„Åæ„Åô„Çà„ÅÜ„Å´‚ú®",
          "„Åù„Åó„Å¶„ÄÅ„Åä„ÅÑ„Åó„ÅÑ„ÅäÈÖí„Å´Â∑°„Çä„ÅÇ„Åà„Åæ„Åô„Çà„ÅÜ„Å´üç∑"
        ],
        q11_pairing: "„Å™„Çì„Åß„ÇÇ",
        q12_storage: "„ÅÇ„Å™„Åü„Å´„Å®„Å£„Å¶Â§ßÂàá„Å™Â†¥ÊâÄ",
        q13_craft: "Ê≥¢„ÅÆÁ©è„ÇÑ„Åã„Å™Êµ∑„ÅßÊµ∑Â∫ïÁÜüÊàê„Åï„Åõ„Åü„ÇÇ„ÅÆ",
        display_en: "CALM OF BLUE",
        tagline: "ISLAND NIGHT SELECTION",
        openCount: 0
      },
      {
        id: "wine2",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "Orseille Rose Wine",
        q2_producer: "Êòü„Éé„ÉØ„Ç§„Éä„É™„Éº",
        q3_origin: "Êó•Êú¨",
        q4_variety: "Êòü„Éé„Éë„Éº„Éó„É´",
        q5_vintage: "1980",
        q6_style: "Signature",
        q7_alcohol: "12.0%",
        q8_world_phrase: "Ê∞óÂàÜ‰∏ä„ÄÖ",
        q9_world_line: "Ê•Ω„Åó„ÅÑÊôÇÈñì„ÇíÂÖ±„Å´",
        q10_message_lines: [
          "„ÅäË™ïÁîüÊó•„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ"
        ],
        q11_pairing: "„Ç§„Çø„É™„Ç¢„É≥",
        q12_storage: "Ê∂º„Åó„Åè„Å¶Êöó„ÅÑ„Å®„Åì„Çç",
        q13_craft: "ËÅ∑‰∫∫„Åå‰∏ÅÂØß„Å´‰Ωú„Çä„Åæ„Åó„Åü",
        display_en: "ROSE MOMENT",
        tagline: "A PERFECT MATCH WITH ITALIAN CUISINE",
        openCount: 0
      },
      {
        id: "wine3",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "ËíºÊµ∑„ÅÆÁú†„Çä",
        q2_producer: "ÁÄ¨Êà∏ÂÜÖ„Éª‰ø°Èï∑„Ç¢„Éû„ÉçÈÜ∏ÈÄ†ÊâÄ",
        q3_origin: "Êó•Êú¨„ÉªÁÄ¨Êà∏ÂÜÖÊµ∑Ê≤ñ",
        q4_variety: "Áî≤Â∑ûÁ®Æ 100%„ÄÅ„Ç∑„É£„É´„Éâ„Éç„Éñ„É¨„É≥„Éâ",
        q5_vintage: "2020",
        q6_style: "Premium",
        q7_alcohol: "12.0%",
        q8_world_phrase: "ËçíÁ´ã„Å£„ÅüÂøÉ„ÇíÈéÆ„ÇÅ„ÄÅÊ∑±Êµ∑„Å´Êä±„Åã„Çå„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å™Ê∑±„ÅÑÂÆâ„Çâ„Åé„Å®Áú†„Çä„Çí„ÇÇ„Åü„Çâ„Åô„ÄÇ",
        q9_world_line: "„ÄåÊ≥¢„ÅÆ„ÇÜ„Çâ„Åé„ÅåËÇ≤„Å¶„Åü„ÄÅÊ∑±Êµ∑„ÅÆ„Ç¢„Éº„Éà„Éî„Éº„Çπ„ÄÇ„Äç",
        q10_message_lines: [
          "„Åæ„Çã„ÅßÊµ∑Â∫ï„ÅßÁÜüÊàê„Åï„Çå„Åü„ÉØ„Ç§„É≥„ÅÆ„Çà„ÅÜ„Å´„ÄÅ",
          "ÊôÇ„Å®„ÅÑ„ÅÜÊ≥¢„Å´Êèâ„Åæ„Çå„Çã„Åì„Å®„Åß„ÄÅ",
          "„Åã„Åπ„Çã„Å≠„Åµ„Çâ„Çì„Åï„Çì„ÅÆ‰∏≠„ÅßËâØ„ÅÑÊÑèÂë≥„ÅßËßí„ÅåÂèñ„Çå„ÄÅ",
          "„Åã„Åë„Åå„Åà„ÅÆ„Å™„ÅÑ‰∫∫ÈñìÁöÑ„Å™Âéö„Åø„ÇÑ„Åæ„Çç„ÇÑ„Åã„Åï„ÅåÁîü„Åæ„Çå„Å¶„ÅÑ„Çã„ÅÆ„ÇíÊÑü„Åò„Åæ„Åô„ÄÇ",
          "Âπ¥ÈΩ¢„Å®„Å®„ÇÇ„Å´Èáç„Å≠„Å¶„ÅÑ„ÅèÁµåÈ®ì„ÅÆË∑°„ÅØ„ÄÅ",
          "„Åæ„Åï„Å´Ë±ä„Åã„Å™‰∫∫Áîü„ÅÆÊµ∑„ÇíÊ≥≥„ÅÑ„Åß„Åç„ÅüÊôÇÈñì„ÅÆË®ºÊòé„Åß„Åô„Å≠„ÄÇ",
          "„Åù„Çì„Å™Á¥†Êïµ„Å™Âπ¥„ÅÆÈáç„Å≠Êñπ„Çí„Åï„Çå„Å¶„ÅÑ„Çã„Åã„Åπ„Çã„Å≠„Åµ„Çâ„Çì„Åï„Çì„Å´„ÄÅ",
          "„ÅäË™ïÁîüÊó•„Åä„ÇÅ„Åß„Å®„ÅÜ„ÄÇ"
        ],
        q11_pairing: "ÁîüÁâ°Ë†£Ôºà„É¨„É¢„É≥Ê∑ª„ÅàÔºâ„ÄÅÁôΩË∫´È≠ö„ÅÆÊòÜÂ∏ÉÁ∑†„ÇÅ„ÄÅ‰ºäÂã¢Êµ∑ËÄÅ„ÅÆ„Ç∞„É™„É´„ÄÇ",
        q12_storage: "Áõ¥Â∞ÑÊó•ÂÖâ„ÇíÈÅø„Åë„ÄÅÊöó„ÅèÈùô„Åã„Å™Â†¥ÊâÄ",
        q13_craft: "Êµ∑Â∫ïÁÜüÊàê",
        display_en: "SILENCE OF THE DEEP",
        tagline: "PAIRING WITH OCEAN DELICACIES",
        openCount: 0
      },
      {
        id: "wine4",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "Nyadal",
        q2_producer: "„Åõ„Å¥„ÅÇ„Çè„ÅÑ„Å™„Çä„Éº",
        q3_origin: "„Åã„Å´„ÇÉ„Å†",
        q4_variety: "Nyadal Blanc",
        q5_vintage: "2025",
        q6_style: "Premium",
        q7_alcohol: "12.5%",
        q8_world_phrase: "„ÅÇ„Åæ„Åà„Å≠„Åì„Å´„Å™„Çã",
        q9_world_line: "„Å≠„Åì„Å´„Åä„Åô„Åô„ÇÅÔºÅ",
        q10_message_lines: [
          "„Åã„Åπ„Çã„Å≠„Åï„Çì„ÅäË™ïÁîüÊó•„Åä„ÇÅ„Åß„Å®ÔΩûÔΩûÔΩû‚ô°‚ô°‚ô°‚ô°‚ô°"
        ],
        q11_pairing: "„Å°„Éº„Åö„Å®„Åã„Åë„Éº„Åç",
        q12_storage: "„Å§„ÇÅ„Åü„ÅÑ„ÅØ„ÅìÔºÅ",
        q13_craft: "„Å≠„Åì„Åü„Å°„Åå„Åì„Åä„Å£„Åü„Å∂„Å©„ÅÜ„Çí„ÅÇ„Å£„Åï„Åè„Åó„Åæ„Åó„ÅüÔºÅ",
        display_en: "NYADAL SWEET TIME",
        tagline: "A GIFT FOR CAT LOVERS",
        openCount: 0
      },
      {
        id: "wine5",
        bottleImage: "https://raw.githubusercontent.com/yumemiru28000/zzHBD1/main/wine1.png",
        qrImage: "",
        q1_name: "„Åô„Å£„Åî„ÅèÁæéÂë≥„Åó„ÅÑ„ÉØ„Ç§„É≥",
        q2_producer: "NEKOmata Vineyard",
        q3_origin: "Neko island",
        q4_variety: "Êòü„ÇíÂÆø„Åô„É¶„Éã„Éª„Éñ„É©„É≥",
        q5_vintage: "1900",
        q6_style: "Casual Sip",
        q7_alcohol: "12.0%",
        q8_world_phrase: "‰∏ñÁïå„ÅåÁæé„Åó„ÅèË¶ã„Åà„Çã",
        q9_world_line: "„ÅÇ„Å™„Åü„ÅÆÊòü„ÇíË¶ã‰∏ä„Åí„Å¶„Åè„Å†„Åï„ÅÑ",
        q10_message_lines: [
          "üçá„Åã„Åπ„Çã„Å≠„Åµ„Çâ„Çì„Åï„ÇìÔºÅ",
          "ÂøÉ„Åã„Çâ„ÅäË™ïÁîüÊó•„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ",
          "„Åì„Çå„Åã„Çâ„ÇÇ„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„ÅôüíïüéÇ‚ú®"
        ],
        q11_pairing: "„Åì„ÅÆ‰∏ñÁïå„ÅÆÈ£ü„ÅπÁâ©„ÅØ„Åô„Åπ„Å¶",
        q12_storage: "„ÅÇ„Å™„Åü„ÅÆÂøÉ„ÅÆÂ••",
        q13_craft: "Ê•≠Áïå„ÅÆÁßòÂØÜ„Åß„ÅôÔºÅüòÜ",
        display_en: "YOUR STAR MOMENT",
        tagline: "A CELEBRATION JUST FOR YOU",
        openCount: 0
      }
    ];

    let currentIndex = 2;
    let activeWineIndex = null;
    let homeIsVisible = true;
    let interactionLocked = false;
    let revisitCountKeyPrefix = "wine-open-count-";

    // DOMÂèñÂæóÔºàÁúÅÁï•„Åõ„ÅöÔºâ
    const homeScreen = document.getElementById("home-screen");
    const winexpScreen = document.getElementById("winexp-screen");
    const diaryHomeScreen = document.getElementById("diary-home-screen");
    const diaryNewScreen = document.getElementById("diary-new-screen");
    const diaryAppendScreen = document.getElementById("diary-append-screen");
    const diaryViewScreen = document.getElementById("diary-view-screen");
    const calendarMonthScreen = document.getElementById("calendar-month-screen");
    const graphScreen = document.getElementById("graph-screen");

    const diaryButton = document.getElementById("diary-button");

    const bottleStrip = document.getElementById("bottle-strip");
    const qrToggle = document.getElementById("qr-toggle");
    const qrOverlay = document.getElementById("qr-overlay");
    const qrClose = document.getElementById("qr-close");
    const overlayBottleList = document.getElementById("overlay-bottle-list");

    const winexpTitleJp = document.getElementById("winexp-title-jp");
    const winexpTitleEn = document.getElementById("winexp-title-en");
    const basicInfoSection = document.getElementById("basic-info-section");
    const worldSection = document.getElementById("world-section");
    const worldLinePrimary = document.getElementById("world-line-primary");
    const worldLineSecondary = document.getElementById("world-line-secondary");
    const messageWax = document.getElementById("message-wax");
    const messageCard = document.getElementById("message-card");
    const messageBody = document.getElementById("message-body");
    const accordionList = document.getElementById("accordion-list");
    const winexpBgLayer = document.getElementById("winexp-bg-layer");
    const nightStars = document.getElementById("night-stars");
    const homeButton = document.getElementById("home-button");

    const wineTitleBubble = document.getElementById("wine-title-bubble");
    const wineTitleBubbleText = document.getElementById("wine-title-bubble-text");
    const winexpBottleHero = document.getElementById("winexp-bottle-hero");
    const winexpBottleHeroImg = document.getElementById("winexp-bottle-hero-img");
    const pawButton = document.getElementById("paw-button");

    const bgmAudio = document.getElementById("bgm-audio");
    const bgmVolumeSlider = document.getElementById("bgm-volume");
    const seWine1 = document.getElementById("se-wine1");
    const nyaAudio = document.getElementById("nya-audio");

    // Diary DOM
    const diaryNewBackButton = document.getElementById("diary-new-back-button");
    const diaryAppendBackButton = document.getElementById("diary-append-back-button");

    const diaryDateInput = document.getElementById("diary-date");
    const diaryNameInput = document.getElementById("diary-name");
    const diaryTypeInput = document.getElementById("diary-type");
    const diaryBrandInput = document.getElementById("diary-brand");
    const diaryAmountInput = document.getElementById("diary-amount");
    const diaryAbvInput = document.getElementById("diary-abv");
    const diaryTasteInput = document.getElementById("diary-taste");
    const diaryAromaInput = document.getElementById("diary-aroma");
    const diaryColorInput = document.getElementById("diary-color");
    const diaryCommentInput = document.getElementById("diary-comment");
    const diaryTimezoneInput = document.getElementById("diary-timezone");
    const diaryMoodInput = document.getElementById("diary-mood");
    const diaryFoodInput = document.getElementById("diary-food");
    const diaryPlaceInput = document.getElementById("diary-place");
    const diaryDrunkenInput = document.getElementById("diary-drunken");
    const diaryNextdayInput = document.getElementById("diary-nextday");
    const diaryColorPicker = document.getElementById("diary-color-picker");

    const diaryGenerateQrButton = document.getElementById("diary-generate-qr-button");
    const diaryQrPreview = document.getElementById("diary-qr-preview");
    const diaryQrCanvas = document.getElementById("diary-qr-canvas");
    const diaryQrSaveButton = document.getElementById("diary-qr-save-button");

    const diaryAppendFile = document.getElementById("diary-append-file");
    const diaryAppendStatus = document.getElementById("diary-append-status");
    const diaryAppendFormCard = document.getElementById("diary-append-form-card");
    const diaryDateAppendInput = document.getElementById("diary-date-append");
    const diaryNameAppendInput = document.getElementById("diary-name-append");
    const diaryTypeAppendInput = document.getElementById("diary-type-append");
    const diaryBrandAppendInput = document.getElementById("diary-brand-append");
    const diaryAmountAppendInput = document.getElementById("diary-amount-append");
    const diaryAbvAppendInput = document.getElementById("diary-abv-append");
    const diaryTasteAppendInput = document.getElementById("diary-taste-append");
    const diaryAromaAppendInput = document.getElementById("diary-aroma-append");
    const diaryColorAppendInput = document.getElementById("diary-color-append");
    const diaryCommentAppendInput = document.getElementById("diary-comment-append");
    const diaryTimezoneAppendInput = document.getElementById("diary-timezone-append");
    const diaryMoodAppendInput = document.getElementById("diary-mood-append");
    const diaryFoodAppendInput = document.getElementById("diary-food-append");
    const diaryPlaceAppendInput = document.getElementById("diary-place-append");
    const diaryDrunkenAppendInput = document.getElementById("diary-drunken-append");
    const diaryNextdayAppendInput = document.getElementById("diary-nextday-append");
    const diaryColorPickerAppend = document.getElementById("diary-color-picker-append");
    const diaryAppendGenerateButton = document.getElementById("diary-append-generate-button");
    const diaryAppendQrPreview = document.getElementById("diary-append-qr-preview");
    const diaryAppendQrCanvas = document.getElementById("diary-append-qr-canvas");
    const diaryAppendQrSaveButton = document.getElementById("diary-append-qr-save-button");

    const diaryViewFile = document.getElementById("diary-view-file");
    const diaryViewReadButton = document.getElementById("diary-view-read-button");
    const diaryViewStatus = document.getElementById("diary-view-status");
    const calendarYearCard = document.getElementById("calendar-year-card");
    const calendarYearGrid = document.getElementById("calendar-year-grid");
    const graphOpenButton = document.getElementById("graph-open-button");

    const calendarHeaderTitle = document.getElementById("calendar-header-title");
    const calendarHeaderSubtitle = document.getElementById("calendar-header-subtitle");
    const calendarMonthTitle = document.getElementById("calendar-month-title");
    const calendarDates = document.getElementById("calendar-dates");
    const calendarPrevMonthButton = document.getElementById("calendar-prev-month");
    const calendarNextMonthButton = document.getElementById("calendar-next-month");
    const calendarDetailsTitle = document.getElementById("calendar-details-title");
    const calendarDetailsBody = document.getElementById("calendar-details-body");
    const calendarBackYearButton = document.getElementById("calendar-back-year-button");

    const diaryNewEntryButton = document.getElementById("diary-new-entry-button");
    const diaryAppendButton = document.getElementById("diary-append-button");
    const diaryViewButton = document.getElementById("diary-view-button");

    const graphCanvas = document.getElementById("graph-canvas");
    const graphCtx = graphCanvas.getContext("2d");
    const graphRangeGroup = document.getElementById("graph-range-group");
    const graphMetricGroup = document.getElementById("graph-metric-group");
    const graphList = document.getElementById("graph-list");
    const wineRankingList = document.getElementById("wine-ranking-list");
    const wineDetailButton = document.getElementById("wine-detail-button");
    const wineDetailList = document.getElementById("wine-detail-list");
    const graphBackButton = document.getElementById("graph-back-button");

    let diaryColorSelected = "#f97316";
    let diaryColorSelectedAppend = "#f97316";
    let loadedDiaryEntries = [];
    let loadedDiaryStruct = null;
    let calendarCurrentYear = null;
    let calendarCurrentMonth = null;
    let graphRange = "7";
    let graphMetric = "amount";
    let originalAppendFileName = "diary_updated.png";

    function hideAllScreensExcept(screen) {
      [
        homeScreen,
        winexpScreen,
        diaryHomeScreen,
        diaryNewScreen,
        diaryAppendScreen,
        diaryViewScreen,
        calendarMonthScreen,
        graphScreen
      ].forEach(s => {
        if (s === screen) return;
        s.classList.add("screen--hidden");
        s.classList.remove("screen--active");
      });
    }

    /* ===== Home / WineXP „É≠„Ç∏„ÉÉ„ÇØÔºàÁúÅÁï•„Åõ„ÅöÔºâ ===== */

    function renderHomeBottles() {
      bottleStrip.innerHTML = "";
      const visibleMain = 3;
      if (wines.length <= visibleMain) {
        for (let i = 0; i < wines.length; i++) appendBottleItem(i, false, false);
        return;
      }
      let start = currentIndex - 1;
      let end = currentIndex + 2;
      if (start < 0) {
        start = 0;
        end = start + visibleMain;
      }
      if (end > wines.length) {
        end = wines.length;
        start = end - visibleMain;
      }
      const leftIndex = start - 1;
      const rightIndex = end;
      if (leftIndex >= 0) appendBottleItem(leftIndex, true, true);
      for (let i = start; i < end; i++) appendBottleItem(i, false, false);
      if (rightIndex < wines.length) appendBottleItem(rightIndex, true, false);
    }

    function appendBottleItem(i, isSide, isLeftSide) {
      const wine = wines[i];
      const item = document.createElement("div");
      item.className = "bottle-item";
      if (isSide) item.classList.add("bottle-item--side");
      else if (i === currentIndex) item.classList.add("bottle-item--focused");
      else item.classList.add("bottle-item--dimmed");

      const wrap = document.createElement("div");
      wrap.className = "bottle-image-wrapper";

      const img = document.createElement("img");
      img.className = "bottle-image";
      img.src = wine.bottleImage;
      img.alt = wine.q1_name;

      const shadow = document.createElement("div");
      shadow.className = "bottle-shadow";

      const reflection = document.createElement("div");
      reflection.className = "bottle-reflection";

      wrap.appendChild(img);
      wrap.appendChild(shadow);
      wrap.appendChild(reflection);
      item.appendChild(wrap);
      bottleStrip.appendChild(item);

      if (isSide) {
        item.addEventListener("click", () => {
          if (!homeIsVisible) return;
          if (isLeftSide) currentIndex = Math.max(0, currentIndex - 1);
          else currentIndex = Math.min(wines.length - 1, currentIndex + 1);
          try { seWine1.currentTime = 0; seWine1.play(); } catch {}
          renderHomeBottles();
        });
      } else {
        item.addEventListener("click", () => {
          if (homeIsVisible) handleBottleTap(i, item);
        });
      }
    }

    function handleBottleTap(index, bottleElement) {
      activeWineIndex = index;
      bottleElement.style.transition = "filter 0.12s var(--transition-standard)";
      bottleElement.style.filter = "brightness(0.92)";
      setTimeout(() => bottleElement.style.filter = "", 120);
      setTimeout(() => {
        homeScreen.style.transition = "filter 0.65s var(--transition-soft)";
        homeScreen.style.filter = "blur(10px) brightness(0.85)";
        showWineXp(index);
      }, 150);
    }

    function showWineXp(index) {
      homeIsVisible = false;
      hideAllScreensExcept(winexpScreen);
      winexpScreen.classList.remove("screen--hidden");
      winexpScreen.classList.add("screen--active");
      document.body.style.overflow = "hidden";
      homeButton.classList.add("home-button--visible");

      const wine = wines[index];
      const key = revisitCountKeyPrefix + wine.id;
      const prevCount = parseInt(localStorage.getItem(key) || "0", 10);
      wine.openCount = prevCount + 1;
      localStorage.setItem(key, String(wine.openCount));

      interactionLocked = true;
      winexpScreen.classList.add("winexp-screen--locked-interaction");
      setTimeout(() => {
        interactionLocked = false;
        winexpScreen.classList.remove("winexp-screen--locked-interaction");
      }, 2500);

      winexpTitleJp.textContent = wine.q1_name || "";
      winexpTitleEn.textContent = wine.display_en || "";
      if (wine.tagline) {
        wineTitleBubble.style.display = "inline-flex";
        wineTitleBubbleText.textContent = wine.tagline;
      } else wineTitleBubble.style.display = "none";

      if (wine.bottleImage) {
        winexpBottleHero.style.display = "flex";
        winexpBottleHeroImg.src = wine.bottleImage;
        winexpBottleHeroImg.alt = wine.q1_name || "";
      } else {
        winexpBottleHero.style.display = "none";
      }

      pawButton.style.display = (wine.id === "wine4") ? "inline-flex" : "none";

      renderBasicInfo(wine);

      worldLinePrimary.textContent = wine.q8_world_phrase || "";
      worldLineSecondary.textContent = wine.q9_world_line || "";
      worldSection.classList.remove("world-section--active");
      worldLinePrimary.classList.remove("world-line-primary--visible");
      worldLineSecondary.classList.remove("world-line-secondary--visible");

      setupMessage(wine);
      renderAccordions(wine);
      updateNightEffects();

      winexpScreen.scrollTop = 0;
      setupScrollAnimations();

      try { seWine1.currentTime = 0; seWine1.play(); } catch {}
    }

    function renderBasicInfo(wine) {
      basicInfoSection.innerHTML = "";
      const blocks = [
        { label: "Wine", value: wine.q1_name },
        { label: "Producer", value: wine.q2_producer },
        { label: "Origin", value: wine.q3_origin },
        { label: "Variety", value: wine.q4_variety },
        { label: "Rank", value: wine.q6_style },
        { label: "Vintage", value: wine.q5_vintage },
        { label: "Alcohol", value: wine.q7_alcohol }
      ];
      blocks.forEach((b, idx) => {
        if (!b.value) return;
        const block = document.createElement("div");
        block.className = "info-block";
        block.style.transitionDelay = `${0.2 * idx}s`;
        const label = document.createElement("div");
        label.className = "info-label";
        label.textContent = b.label;
        const value = document.createElement("div");
        value.className = "info-value";
        value.textContent = b.value;
        block.appendChild(label);
        block.appendChild(value);
        basicInfoSection.appendChild(block);
      });
    }

    function setupMessage(wine) {
      messageWax.classList.remove("message-wax--visible");
      messageCard.classList.remove("message-card--open");
      messageBody.innerHTML = "";
      setTimeout(() => {
        messageWax.classList.add("message-wax--visible");
      }, 600);

      let opened = false;
      const onWaxClick = () => {
        if (opened || interactionLocked) return;
        opened = true;
        messageWax.style.transform = "scale(0.94) translateY(3px)";
        setTimeout(() => {
          messageWax.style.transform = "scale(0.98) translateY(1px)";
        }, 200);
        setTimeout(() => {
          messageCard.classList.add("message-card--open");
          const msgLines = wine.q10_message_lines || [];
          const baseDelay = 200;
          msgLines.forEach((text, idx) => {
            const lineEl = document.createElement("div");
            lineEl.className = "message-line";
            lineEl.textContent = text;
            messageBody.appendChild(lineEl);
            setTimeout(() => {
              lineEl.classList.add("message-line--visible");
            }, baseDelay + idx * 350);
          });
        }, 400);
      };
      messageWax.onclick = onWaxClick;
    }

    function renderAccordions(wine) {
      accordionList.innerHTML = "";
      const accData = [
        { icon: "üçΩ", title: "Pairing", content: wine.q11_pairing },
        { icon: "üåô", title: "Storage", content: wine.q12_storage },
        { icon: "üåä", title: "Craft", content: wine.q13_craft }
      ];
      accData.forEach(item => {
        if (!item.content) return;
        const accItem = document.createElement("div");
        accItem.className = "accordion-item";
        const header = document.createElement("div");
        header.className = "accordion-header";
        const labelWrap = document.createElement("div");
        labelWrap.className = "accordion-label-wrap";
        const iconEl = document.createElement("div");
        iconEl.className = "accordion-icon";
        iconEl.textContent = item.icon;
        const titleEl = document.createElement("div");
        titleEl.className = "accordion-title";
        titleEl.textContent = item.title;
        labelWrap.appendChild(iconEl);
        labelWrap.appendChild(titleEl);
        const arrow = document.createElement("div");
        arrow.className = "accordion-arrow";
        arrow.textContent = ">";
        header.appendChild(labelWrap);
        header.appendChild(arrow);
        const body = document.createElement("div");
        body.className = "accordion-body";
        const text = document.createElement("div");
        text.className = "accordion-text";
        text.textContent = item.content;
        body.appendChild(text);
        accItem.appendChild(header);
        accItem.appendChild(body);
        accordionList.appendChild(accItem);
        header.addEventListener("click", () => {
          accItem.classList.toggle("accordion-item--open");
        });
      });
    }

    function setupScrollAnimations() {
      const infoBlocks = Array.from(basicInfoSection.querySelectorAll(".info-block"));
      const handleScroll = () => {
        const vh = winexpScreen.clientHeight;
        infoBlocks.forEach((block, idx) => {
          const rect = block.getBoundingClientRect();
          if (rect.top < vh - 90) {
            setTimeout(() => block.classList.add("info-block--visible"), idx * 200);
          }
        });
        const worldRect = worldSection.getBoundingClientRect();
        if (worldRect.top < vh - 140) {
          worldSection.classList.add("world-section--active");
          setTimeout(() => worldLinePrimary.classList.add("world-line-primary--visible"), 150);
          setTimeout(() => worldLineSecondary.classList.add("world-line-secondary--visible"), 650);
        }
      };
      winexpScreen.removeEventListener("scroll", handleScroll);
      winexpScreen.addEventListener("scroll", handleScroll);
      handleScroll();
    }

    function isNightTime() {
      const h = new Date().getHours();
      return h >= 22 || h < 5;
    }

    function updateNightEffects() {
      if (isNightTime()) {
        nightStars.classList.add("night-stars--visible");
        winexpBgLayer.style.filter = "brightness(0.9)";
      } else {
        nightStars.classList.remove("night-stars--visible");
        winexpBgLayer.style.filter = "brightness(1)";
      }
    }

    function goHome() {
      if (homeIsVisible) return;
      homeIsVisible = true;
      hideAllScreensExcept(homeScreen);
      homeScreen.classList.add("screen--active");
      document.body.style.overflow = "hidden";
      homeButton.classList.remove("home-button--visible");
      homeScreen.style.filter = "none";
    }

    homeButton.addEventListener("click", () => {
      homeScreen.style.transition = "transform 0.6s var(--transition-standard), opacity 0.6s var(--transition-standard)";
      homeScreen.style.transform = "translateY(0)";
      goHome();
    });

    function openQrOverlay() {
      qrOverlay.classList.add("overlay--open");
    }

    function closeQrOverlay() {
      qrOverlay.classList.remove("overlay--open");
    }

    qrToggle.addEventListener("click", openQrOverlay);
    qrClose.addEventListener("click", closeQrOverlay);
    qrOverlay.addEventListener("click", e => {
      if (e.target === qrOverlay) closeQrOverlay();
    });

    function renderOverlayBottles() {
      overlayBottleList.innerHTML = "";
      wines.forEach(wine => {
        const item = document.createElement("div");
        item.className = "overlay-bottle";
        const imgWrap = document.createElement("div");
        imgWrap.className = "overlay-bottle-img-wrap";
        const img = document.createElement("img");
        img.className = "overlay-bottle-img";
        img.src = wine.bottleImage;
        img.alt = wine.q1_name;
        const shadow = document.createElement("div");
        shadow.className = "overlay-bottle-shadow";
        imgWrap.appendChild(img);
        imgWrap.appendChild(shadow);
        const nameEl = document.createElement("div");
        nameEl.className = "overlay-name";
        nameEl.textContent = wine.q1_name;
        const qrArea = document.createElement("div");
        qrArea.className = "overlay-qr-area";
        const qrCanvasWrap = document.createElement("div");
        qrCanvasWrap.className = "overlay-qr-canvas-wrap";
        qrCanvasWrap.style.width = "120px";
        qrCanvasWrap.style.height = "120px";
        const qrCanvas = document.createElement("canvas");
        qrCanvas.width = 200;
        qrCanvas.height = 200;
        qrCanvasWrap.appendChild(qrCanvas);
        const qrUrl = `${BASE_URL}?wine=${encodeURIComponent(wine.id)}`;
        new QRious({
          element: qrCanvas,
          value: qrUrl,
          size: 200,
          level: "H",
          background: "#ffffff",
          foreground: "#000000"
        });
        const actionRow = document.createElement("div");
        actionRow.className = "overlay-qr-action-row";
        const previewBtn = document.createElement("div");
        previewBtn.className = "overlay-qr-icon";
        previewBtn.textContent = "QR";
        const saveBtn = document.createElement("div");
        saveBtn.className = "overlay-qr-icon";
        saveBtn.textContent = "Save";
        previewBtn.addEventListener("click", e => {
          e.stopPropagation();
          const dataUrl = qrCanvas.toDataURL("image/png");
          const win = window.open();
          if (win) {
            win.document.write('<img src="' + dataUrl + '" style="width:100%;height:auto;"/>');
          }
        });
        saveBtn.addEventListener("click", e => {
          e.stopPropagation();
          const dataUrl = qrCanvas.toDataURL("image/png");
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = `${wine.id}_qr.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });
        actionRow.appendChild(previewBtn);
        actionRow.appendChild(saveBtn);
        qrArea.appendChild(qrCanvasWrap);
        qrArea.appendChild(actionRow);
        item.appendChild(imgWrap);
        item.appendChild(nameEl);
        item.appendChild(qrArea);
        overlayBottleList.appendChild(item);
      });
    }

    function setupBgm() {
      bgmAudio.volume = parseFloat(bgmVolumeSlider.value || "0.5");
      bgmVolumeSlider.addEventListener("input", () => {
        bgmAudio.volume = parseFloat(bgmVolumeSlider.value || "0.5");
      });
      const tryStart = () => {
        bgmAudio.play().catch(() => {});
        document.removeEventListener("click", tryStart);
        document.removeEventListener("touchstart", tryStart);
      };
      document.addEventListener("click", tryStart);
      document.addEventListener("touchstart", tryStart);
    }

    function getWineIdFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get("wine");
    }

    function openWineFromQueryIfNeeded() {
      const wineId = getWineIdFromQuery();
      if (!wineId) return;
      const idx = wines.findIndex(w => w.id === wineId);
      if (idx >= 0) {
        currentIndex = idx;
        renderHomeBottles();
        setTimeout(() => showWineXp(idx), 200);
      }
    }

    pawButton.addEventListener("click", () => {
      try { nyaAudio.currentTime = 0; nyaAudio.play(); } catch {}
    });

    /* ===== Diary „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ ===== */

    diaryButton.addEventListener("click", () => {
      homeIsVisible = false;
      hideAllScreensExcept(diaryHomeScreen);
      diaryHomeScreen.classList.remove("screen--hidden");
      diaryHomeScreen.classList.add("screen--active");
      homeButton.classList.add("home-button--visible");
    });

    diaryNewEntryButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryNewScreen);
      diaryNewScreen.classList.remove("screen--hidden");
      diaryNewScreen.classList.add("screen--active");
      diaryQrPreview.style.display = "none";
    });

    diaryAppendButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryAppendScreen);
      diaryAppendScreen.classList.remove("screen--hidden");
      diaryAppendScreen.classList.add("screen--active");
      diaryAppendFormCard.style.display = "none";
      diaryAppendQrPreview.style.display = "none";
      diaryAppendStatus.textContent = "";
      diaryAppendFile.value = "";
    });

    diaryViewButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryViewScreen);
      diaryViewScreen.classList.remove("screen--hidden");
      diaryViewScreen.classList.add("screen--active");
      diaryViewStatus.textContent = "";
      calendarYearCard.style.display = "none";
      diaryViewFile.value = "";
      graphOpenButton.style.display = "none";
    });

    diaryNewBackButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryHomeScreen);
      diaryHomeScreen.classList.remove("screen--hidden");
      diaryHomeScreen.classList.add("screen--active");
    });

    diaryAppendBackButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryHomeScreen);
      diaryHomeScreen.classList.remove("screen--hidden");
      diaryHomeScreen.classList.add("screen--active");
    });

    calendarBackYearButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryViewScreen);
      diaryViewScreen.classList.remove("screen--hidden");
      diaryViewScreen.classList.add("screen--active");
    });

    /* ===== Color Picker ===== */

    function setupColorPicker(container, initial, setter) {
      let active = initial;
      Array.from(container.querySelectorAll(".color-dot-option")).forEach(opt => {
        const color = opt.getAttribute("data-color");
        if (color === active) opt.classList.add("color-dot-option--active");
        opt.addEventListener("click", () => {
          active = color;
          setter(color);
          Array.from(container.querySelectorAll(".color-dot-option")).forEach(o => {
            o.classList.toggle("color-dot-option--active", o === opt);
          });
        });
      });
      setter(active);
    }

    setupColorPicker(diaryColorPicker, "#f97316", c => diaryColorSelected = c);
    setupColorPicker(diaryColorPickerAppend, "#f97316", c => diaryColorSelectedAppend = c);

    /* ===== Diary Encode / Decode (UTF-8 ‚Üí Base64) ===== */

    function utf8ToBase64(str) {
      const encoder = new TextEncoder();
      const bytes = encoder.encode(str);
      let binary = "";
      bytes.forEach(b => binary += String.fromCharCode(b));
      return btoa(binary);
    }

    function base64ToUtf8(b64) {
      const binary = atob(b64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      const decoder = new TextDecoder();
      return decoder.decode(bytes);
    }

    function buildDiaryEntryFromInputs(prefix = "") {
      const isAppend = prefix === "-append";
      const date = isAppend ? diaryDateAppendInput.value : diaryDateInput.value;
      if (!date) return null;
      return {
        date,
        name: isAppend ? diaryNameAppendInput.value : diaryNameInput.value,
        type: isAppend ? diaryTypeAppendInput.value : diaryTypeInput.value,
        brand: isAppend ? diaryBrandAppendInput.value : diaryBrandInput.value,
        amount: isAppend ? diaryAmountAppendInput.value : diaryAmountInput.value,
        abv: isAppend ? diaryAbvAppendInput.value : diaryAbvInput.value,
        taste: isAppend ? diaryTasteAppendInput.value : diaryTasteInput.value,
        aroma: isAppend ? diaryAromaAppendInput.value : diaryAromaInput.value,
        colorNote: isAppend ? diaryColorAppendInput.value : diaryColorInput.value,
        comment: isAppend ? diaryCommentAppendInput.value : diaryCommentInput.value,
        timezone: isAppend ? diaryTimezoneAppendInput.value : diaryTimezoneInput.value,
        mood: isAppend ? diaryMoodAppendInput.value : diaryMoodInput.value,
        food: isAppend ? diaryFoodAppendInput.value : diaryFoodInput.value,
        place: isAppend ? diaryPlaceAppendInput.value : diaryPlaceInput.value,
        drunken: isAppend ? diaryDrunkenAppendInput.value : diaryDrunkenInput.value,
        nextday: isAppend ? diaryNextdayAppendInput.value : diaryNextdayInput.value,
        dotColor: isAppend ? diaryColorSelectedAppend : diaryColorSelected
      };
    }

    function buildDiaryStruct(entries) {
      return { type: "diary", version: 1, entries };
    }

    function encodeDiaryToQR(canvas, struct) {
      const innerJson = JSON.stringify(struct);
      const b64 = utf8ToBase64(innerJson);
      const wrapper = { type: "diary-base64", data: b64 };
      const finalJson = JSON.stringify(wrapper);
      new QRious({
        element: canvas,
        value: finalJson,
        size: 512,
        level: "H",
        background: "#ffffff",
        foreground: "#000000"
      });
    }

    function tryParseDiaryFromQrString(str) {
      const outer = JSON.parse(str);
      if (outer.type === "diary-base64" && outer.data) {
        const innerStr = base64ToUtf8(outer.data);
        const inner = JSON.parse(innerStr);
        if (inner.type === "diary" && Array.isArray(inner.entries)) {
          return inner;
        }
      }
      const maybeDiary = JSON.parse(str);
      if (maybeDiary.type === "diary" && Array.isArray(maybeDiary.entries)) {
        return maybeDiary;
      }
      throw new Error("Êó•Ë®ò„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
    }

    /* ===== Diary New QR ===== */

    diaryGenerateQrButton.addEventListener("click", () => {
      const entry = buildDiaryEntryFromInputs("");
      if (!entry) {
        alert("Êó•‰ªò„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ");
        return;
      }
      const struct = buildDiaryStruct([entry]);
      encodeDiaryToQR(diaryQrCanvas, struct);
      diaryQrPreview.style.display = "none";

      const dataUrl = diaryQrCanvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "diary_entry.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    diaryQrSaveButton.addEventListener("click", () => {
      const dataUrl = diaryQrCanvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "diary_entry.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    /* ===== QR Reader ===== */

    function readQrImageFile(file, callback) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const size = 512;
          const canvas = document.createElement("canvas");
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, size, size);
          const imageData = ctx.getImageData(0, 0, size, size);
          const code = jsQR(imageData.data, size, size);
          if (code) callback(null, code.data);
          else callback(new Error("QR„Ç≥„Éº„Éâ„ÇíË™çË≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ"));
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    /* ===== Diary Append ===== */

    diaryAppendFile.addEventListener("change", () => {
      const file = diaryAppendFile.files[0];
      if (!file) return;
      originalAppendFileName = file.name || "diary_updated.png";
      diaryAppendStatus.textContent = "Ë™≠„ÅøÂèñ„Çä‰∏≠‚Ä¶";
      diaryAppendFormCard.style.display = "none";
      diaryAppendQrPreview.style.display = "none";
      readQrImageFile(file, (err, data) => {
        if (err) {
          diaryAppendStatus.textContent = "„Ç®„É©„Éº: " + err.message;
          return;
        }
        try {
          const parsedDiary = tryParseDiaryFromQrString(data);
          loadedDiaryStruct = parsedDiary;
          diaryAppendStatus.textContent = "„Éé„Éº„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇÊñ∞„Åó„ÅÑ1Êó•„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ";
          diaryAppendFormCard.style.display = "block";
        } catch (e) {
          diaryAppendStatus.textContent = "QR„ÅÆ‰∏≠Ë∫´„ÇíËß£Êûê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
        }
      });
    });

    diaryAppendGenerateButton.addEventListener("click", () => {
      if (!loadedDiaryStruct || !Array.isArray(loadedDiaryStruct.entries)) {
        alert("ÂÖà„Å´Êó•Ë®òQR„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ");
        return;
      }
      const entry = buildDiaryEntryFromInputs("-append");
      if (!entry) {
        alert("Êó•‰ªò„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ");
        return;
      }
      diaryAppendQrPreview.style.display = "none";
      const newEntries = loadedDiaryStruct.entries.concat(entry);
      const struct = buildDiaryStruct(newEntries);
      encodeDiaryToQR(diaryAppendQrCanvas, struct);

      const dataUrl = diaryAppendQrCanvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = originalAppendFileName || "diary_updated.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    diaryAppendQrSaveButton.addEventListener("click", () => {
      const dataUrl = diaryAppendQrCanvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = originalAppendFileName || "diary_updated.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    /* ===== Diary View & Calendar ===== */

    diaryViewReadButton.addEventListener("click", () => {
      const file = diaryViewFile.files[0];
      if (!file) {
        alert("Êó•Ë®òQRÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        return;
      }
      diaryViewStatus.textContent = "Ë™≠„ÅøÂèñ„Çä‰∏≠‚Ä¶";
      calendarYearCard.style.display = "none";
      graphOpenButton.style.display = "none";
      readQrImageFile(file, (err, data) => {
        if (err) {
          diaryViewStatus.textContent = "„Ç®„É©„Éº: " + err.message;
          return;
        }
        try {
          const parsedDiary = tryParseDiaryFromQrString(data);
          loadedDiaryEntries = parsedDiary.entries || [];
          if (!loadedDiaryEntries.length) {
            diaryViewStatus.textContent = "Êó•Ë®ò„ÅÆË®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
            return;
          }
          diaryViewStatus.textContent = "Ë™≠„ÅøÂèñ„ÇäÊàêÂäü„ÄÇÂπ¥„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ";
          calendarYearCard.style.display = "block";
          graphOpenButton.style.display = "inline-flex";
          renderCalendarYearChoices();
        } catch (e) {
          diaryViewStatus.textContent = "QR„ÅÆ‰∏≠Ë∫´„ÇíËß£Êûê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
        }
      });
    });

    function renderCalendarYearChoices() {
      calendarYearGrid.innerHTML = "";
      const years = new Set();
      loadedDiaryEntries.forEach(entry => {
        if (!entry.date) return;
        const y = new Date(entry.date).getFullYear();
        if (!isNaN(y)) years.add(y);
      });
      const yearList = Array.from(years).sort((a,b) => a-b);
      const allYears = [];
      for (let y = 2020; y <= 2035; y++) allYears.push(y);
      allYears.forEach(y => {
        const card = document.createElement("div");
        card.className = "year-card";
        card.textContent = y;
        if (yearList.includes(y)) {
          card.style.borderColor = "rgba(249,115,22,0.8)";
          card.style.color = "#fed7aa";
        }
        card.addEventListener("click", () => openCalendarForYear(y));
        calendarYearGrid.appendChild(card);
      });
    }

    function openCalendarForYear(year) {
      calendarCurrentYear = year;
      calendarCurrentMonth = 0;
      hideAllScreensExcept(calendarMonthScreen);
      calendarMonthScreen.classList.remove("screen--hidden");
      calendarMonthScreen.classList.add("screen--active");
      calendarHeaderTitle.textContent = `DIARY ‚Äì ${year}`;
      calendarHeaderSubtitle.textContent = "Áü¢Âç∞„ÅßÊúà„ÇíÁßªÂãï„Åó„Å¶„ÄÅ„Åù„ÅÆÂπ¥„ÅÆÈ£≤ÈÖí„ÅÆË∂≥Ë∑°„ÇíÁú∫„ÇÅ„Åæ„Åô„ÄÇ";
      renderCalendarMonth();
    }

    function renderCalendarMonth() {
      if (calendarCurrentYear == null || calendarCurrentMonth == null) return;
      const year = calendarCurrentYear;
      const month = calendarCurrentMonth;
      calendarMonthTitle.textContent = `${year} / ${month+1}`;
      calendarDates.innerHTML = "";
      calendarDetailsTitle.textContent = "Ë®òÈå≤„ÅÆ„ÅÇ„ÇãÊó•„ÇíÈÅ∏„Å∂„Å®„ÄÅ„Åì„Åì„Å´‰∏ÄË¶ß„ÅåÂá∫„Åæ„Åô„ÄÇ";
      calendarDetailsBody.innerHTML = "";

      const firstDay = new Date(year, month, 1);
      const startWeekday = firstDay.getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      const entriesByDate = {};
      loadedDiaryEntries.forEach(entry => {
        if (!entry.date) return;
        const d = new Date(entry.date);
        if (d.getFullYear() === year && d.getMonth() === month) {
          const day = d.getDate();
          const key = `${year}-${month+1}-${day}`;
          if (!entriesByDate[key]) entriesByDate[key] = [];
          entriesByDate[key].push(entry);
        }
      });

      const totalCells = 7 * 6;
      let currentDay = 1;
      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement("div");
        cell.className = "calendar-day";
        if (i < startWeekday || currentDay > daysInMonth) {
          cell.classList.add("calendar-day--inactive");
          calendarDates.appendChild(cell);
          continue;
        }
        const day = currentDay;
        cell.textContent = day;
        const key = `${year}-${month+1}-${day}`;
        if (entriesByDate[key]) {
          cell.classList.add("calendar-day--has-entry");
          const entries = entriesByDate[key];
          const dot = document.createElement("div");
          dot.className = "calendar-dot";
          const colors = entries.map(e => e.dotColor || "#f97316");
          dot.style.background = colors[0];
          cell.appendChild(dot);
          cell.addEventListener("click", () => {
            showCalendarDetails(year, month, day, entries);
          });
        } else {
          cell.classList.add("calendar-day--inactive");
        }
        calendarDates.appendChild(cell);
        currentDay++;
      }
    }

    function showCalendarDetails(year, month, day, entries) {
      calendarDetailsTitle.textContent = `${year}/${month+1}/${day} „ÅÆË®òÈå≤`;
      calendarDetailsBody.innerHTML = "";
      entries.forEach(entry => {
        const card = document.createElement("div");
        card.className = "calendar-entry-card";

        const nameTitle = document.createElement("div");
        nameTitle.className = "calendar-entry-name";
        nameTitle.textContent = entry.brand || entry.type || "(Ë®òÈå≤)";
        card.appendChild(nameTitle);

        const rows = [
          ["ÂêçÂâç", entry.name],
          ["„ÅäÈÖí„ÅÆÁ®ÆÈ°û", entry.type],
          ["ÈäòÊüÑ / „Éñ„É©„É≥„Éâ", entry.brand],
          ["Èáè", entry.amount],
          ["ABV%", entry.abv],
          ["Âë≥„ÅÆË©ï‰æ°", entry.taste],
          ["È¶ô„Çä", entry.aroma],
          ["Ëâ≤„ÉªË¶ã„ÅüÁõÆ", entry.colorNote],
          ["Á∑èÂêà„Ç≥„É°„É≥„Éà", entry.comment],
          ["ÊôÇÈñìÂ∏Ø", entry.timezone],
          ["Ê∞óÂàÜ", entry.mood],
          ["„Éö„Ç¢„É™„É≥„Ç∞", entry.food],
          ["Â†¥ÊâÄ", entry.place],
          ["ÈÖî„ÅÑ„ÅÆÁ®ãÂ∫¶", entry.drunken],
          ["ÁøåÊó•„ÅÆ‰ΩìË™ø", entry.nextday],
          ["„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆËâ≤", entry.dotColor]
        ];

        rows.forEach(([label, value]) => {
          if (!value) return;
          const row = document.createElement("div");
          row.className = "calendar-entry-row";
          const l = document.createElement("div");
          l.className = "calendar-entry-label";
          l.textContent = label + "Ôºö";
          const v = document.createElement("div");
          v.className = "calendar-entry-value";
          v.textContent = value;
          row.appendChild(l);
          row.appendChild(v);
          card.appendChild(row);
        });

        calendarDetailsBody.appendChild(card);
      });
    }

    calendarPrevMonthButton.addEventListener("click", () => {
      if (calendarCurrentMonth == null) return;
      calendarCurrentMonth--;
      if (calendarCurrentMonth < 0) {
        calendarCurrentMonth = 11;
        calendarCurrentYear--;
      }
      renderCalendarMonth();
    });

    calendarNextMonthButton.addEventListener("click", () => {
      if (calendarCurrentMonth == null) return;
      calendarCurrentMonth++;
      if (calendarCurrentMonth > 11) {
        calendarCurrentMonth = 0;
        calendarCurrentYear++;
      }
      renderCalendarMonth();
    });

    /* ===== Graph ===== */

    function parseNumberOrNull(value) {
      if (!value) return null;
      const n = parseFloat(String(value).replace(/[^\d.\-]/g, ""));
      return isNaN(n) ? null : n;
    }

    function parseRating1to5OrNull(value) {
      const n = parseNumberOrNull(value);
      if (n == null) return null;
      if (n < 1 || n > 5) return null;
      return n;
    }

    function parseTime0to24OrNull(value) {
      const n = parseNumberOrNull(value);
      if (n == null) return null;
      if (n < 0 || n > 24) return null;
      return n;
    }

    function getEntriesSortedByDateDesc() {
      const arr = (loadedDiaryEntries || []).slice();
      arr.sort((a, b) => {
        const da = new Date(a.date || "1970-01-01");
        const db = new Date(b.date || "1970-01-01");
        return db - da;
      });
      return arr;
    }

    function applyRange(entries) {
      if (graphRange === "all") return entries;
      const limit = graphRange === "7" ? 7 : 30;
      return entries.slice(0, limit);
    }

    function getMetricLabel(metric) {
      switch (metric) {
        case "amount": return "ÈáèÔºàml„Å™„Å©Ôºâ";
        case "time": return "ÊôÇÈñìÂ∏ØÔºà0ÔΩû24ÊôÇÔºâ";
        case "mood": return "Ê∞óÂàÜÔºà1ÔΩû5Ôºâ";
        case "drunken": return "ÈÖî„ÅÑÔºà1ÔΩû5Ôºâ";
        case "nextday": return "‰ΩìË™øÔºà1ÔΩû5Ôºâ";
        default: return "";
      }
    }

    function extractMetricValue(entry, metric) {
      switch (metric) {
        case "amount":
          return parseNumberOrNull(entry.amount);
        case "time":
          return parseTime0to24OrNull(entry.timezone);
        case "mood":
          return parseRating1to5OrNull(entry.mood);
        case "drunken":
          return parseRating1to5OrNull(entry.drunken);
        case "nextday":
          return parseRating1to5OrNull(entry.nextday);
      }
      return null;
    }

    function drawGraph() {
      graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
      const all = getEntriesSortedByDateDesc();
      const entries = applyRange(all);
      const points = [];
      entries.forEach((e, idx) => {
        const val = extractMetricValue(e, graphMetric);
        if (val != null) {
          points.push({ entry: e, index: idx, value: val });
        }
      });
      if (!points.length) {
        graphCtx.fillStyle = "#9ca3af";
        graphCtx.font = "12px system-ui";
        graphCtx.fillText("„Åì„ÅÆÊåáÊ®ô„ÅßÊï∞ÂÄ§„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ", 20, graphCanvas.height / 2);
        graphList.innerHTML = "";
        return;
      }

      let minY, maxY;
      if (graphMetric === "time") {
        minY = 0; maxY = 24;
      } else if (["mood","drunken","nextday"].includes(graphMetric)) {
        minY = 1; maxY = 5;
      } else {
        const vs = points.map(p => p.value);
        minY = 0;
        maxY = Math.max(...vs) || 1;
      }

      const paddingLeft = 40;
      const paddingRight = 10;
      const paddingTop = 20;
      const paddingBottom = 30;
      const w = graphCanvas.width - paddingLeft - paddingRight;
      const h = graphCanvas.height - paddingTop - paddingBottom;

      const stepX = points.length > 1 ? w / (points.length - 1) : 0;

      function mapX(i) {
        return paddingLeft + stepX * i;
      }

      function mapY(v) {
        if (maxY === minY) return paddingTop + h / 2;
        const t = (v - minY) / (maxY - minY);
        return paddingTop + h * (1 - t);
      }

      graphCtx.strokeStyle = "rgba(75,85,99,0.9)";
      graphCtx.lineWidth = 1;
      graphCtx.beginPath();
      graphCtx.moveTo(paddingLeft, paddingTop);
      graphCtx.lineTo(paddingLeft, paddingTop + h);
      graphCtx.lineTo(paddingLeft + w, paddingTop + h);
      graphCtx.stroke();

      graphCtx.strokeStyle = "#f97316";
      graphCtx.lineWidth = 2;
      graphCtx.beginPath();
      points.forEach((p, idx) => {
        const x = mapX(idx);
        const y = mapY(p.value);
        if (idx === 0) graphCtx.moveTo(x, y);
        else graphCtx.lineTo(x, y);
      });
      graphCtx.stroke();

      graphCtx.fillStyle = "#fed7aa";
      points.forEach((p, idx) => {
        const x = mapX(idx);
        const y = mapY(p.value);
        graphCtx.beginPath();
        graphCtx.arc(x, y, 3, 0, Math.PI * 2);
        graphCtx.fill();
      });

      graphCtx.fillStyle = "#9ca3af";
      graphCtx.font = "10px system-ui";
      graphCtx.textAlign = "right";
      graphCtx.textBaseline = "middle";
      const ticks = 4;
      for (let i = 0; i <= ticks; i++) {
        const t = i / ticks;
        const v = minY + (maxY - minY) * (1 - t);
        const y = paddingTop + h * t;
        graphCtx.fillText(v.toFixed(1), paddingLeft - 6, y);
      }

      graphCtx.textAlign = "center";
      graphCtx.textBaseline = "top";
      points.forEach((p, idx) => {
        const x = mapX(idx);
        const d = new Date(p.entry.date || "1970-01-01");
        const label = `${d.getMonth()+1}/${d.getDate()}`;
        if (points.length <= 10 || idx % Math.ceil(points.length / 10) === 0) {
          graphCtx.fillText(label, x, paddingTop + h + 4);
        }
      });

      graphList.innerHTML = "";
      points.forEach(p => {
        const d = new Date(p.entry.date || "1970-01-01");
        const row = document.createElement("div");
        row.className = "graph-list-item";
        const left = document.createElement("div");
        left.className = "graph-list-date";
        left.textContent = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        const right = document.createElement("div");
        right.className = "graph-list-value";
        right.textContent = `${p.value} (${getMetricLabel(graphMetric)})`;
        row.appendChild(left);
        row.appendChild(right);
        graphList.appendChild(row);
      });
    }

    function buildWineRankingAndDetail() {
      const map = new Map();
      (loadedDiaryEntries || []).forEach(e => {
        const key = (e.brand || e.type || "").trim();
        if (!key) return;
        if (!map.has(key)) {
          map.set(key, {
            name: key,
            count: 0,
            taste: [],
            aroma: [],
            colorNote: [],
            food: [],
            abv: []
          });
        }
        const w = map.get(key);
        w.count++;
        if (e.taste) w.taste.push(e.taste);
        if (e.aroma) w.aroma.push(e.aroma);
        if (e.colorNote) w.colorNote.push(e.colorNote);
        if (e.food) w.food.push(e.food);
        if (e.abv) w.abv.push(e.abv);
      });

      const list = Array.from(map.values());
      list.sort((a, b) => b.count - a.count);

      wineRankingList.innerHTML = "";
      list.slice(0, 5).forEach((w, i) => {
        const row = document.createElement("div");
        row.className = "wine-ranking-row";
        const left = document.createElement("div");
        left.className = "wine-ranking-name";
        left.textContent = `${i+1}. ${w.name}`;
        const right = document.createElement("div");
        right.className = "wine-ranking-count";
        right.textContent = `${w.count} Âõû`;
        row.appendChild(left);
        row.appendChild(right);
        wineRankingList.appendChild(row);
      });

      wineDetailList.innerHTML = "";
      wineDetailButton.onclick = () => {
        wineDetailList.innerHTML = "";
        list.forEach(w => {
          const item = document.createElement("div");
          item.className = "wine-detail-item";
          const title = document.createElement("div");
          title.className = "wine-detail-title";
          title.textContent = w.name + `Ôºà${w.count}ÂõûÔºâ`;
          const body = document.createElement("div");
          body.className = "wine-detail-body";
          body.textContent =
            `Âë≥„ÅÆË©ï‰æ°: ${w.taste.join(" / ") || "-"}\n` +
            `È¶ô„Çä: ${w.aroma.join(" / ") || "-"}\n` +
            `Ëâ≤„ÉªË¶ã„ÅüÁõÆ: ${w.colorNote.join(" / ") || "-"}\n` +
            `„Éö„Ç¢„É™„É≥„Ç∞: ${w.food.join(" / ") || "-"}\n` +
            `Â∫¶Êï∞: ${w.abv.join(" / ") || "-"}`;
          item.appendChild(title);
          item.appendChild(body);
          wineDetailList.appendChild(item);
        });
      };
    }

    graphOpenButton.addEventListener("click", () => {
      if (!loadedDiaryEntries || !loadedDiaryEntries.length) {
        alert("ÂÖà„Å´Êó•Ë®òQR„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ");
        return;
      }
      hideAllScreensExcept(graphScreen);
      graphScreen.classList.remove("screen--hidden");
      graphScreen.classList.add("screen--active");
      drawGraph();
      buildWineRankingAndDetail();
    });

    graphBackButton.addEventListener("click", () => {
      hideAllScreensExcept(diaryViewScreen);
      diaryViewScreen.classList.remove("screen--hidden");
      diaryViewScreen.classList.add("screen--active");
    });

    graphRangeGroup.addEventListener("click", e => {
      const btn = e.target.closest(".graph-chip");
      if (!btn) return;
      graphRange = btn.getAttribute("data-range");
      Array.from(graphRangeGroup.querySelectorAll(".graph-chip")).forEach(b => {
        b.classList.toggle("graph-chip--active", b === btn);
      });
      drawGraph();
    });

    graphMetricGroup.addEventListener("click", e => {
      const btn = e.target.closest(".graph-chip");
      if (!btn) return;
      graphMetric = btn.getAttribute("data-metric");
      Array.from(graphMetricGroup.querySelectorAll(".graph-chip")).forEach(b => {
        b.classList.toggle("graph-chip--active", b === btn);
      });
      drawGraph();
    });

    /* ===== init ===== */

    function init() {
      renderHomeBottles();
      renderOverlayBottles();
      updateNightEffects();
      setupBgm();
      openWineFromQueryIfNeeded();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
